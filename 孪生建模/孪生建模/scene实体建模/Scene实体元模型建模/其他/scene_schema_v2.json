{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/Scene.schema.json",
  "title": "Scene Entity Schema (Unified) V2.3",
  "description": "场景实体统一元模型 V2.3 - 新增完整的输入输出物料流转模型",
  "type": "object",
  
  "required": [
    "id",
    "type",
    "sceneLevel",
    "sceneCode",
    "sceneName",
    "refMBOM",
    "timeFrame",
    "location",
    "status"
  ],
  
  "properties": {
    "@context": {
      "type": "array",
      "items": {
        "type": "string",
        "format": "uri"
      },
      "description": "NGSI-LD上下文定义",
      "examples": [
        [
          "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld",
          "https://example.com/contexts/scene-context.jsonld"
        ]
      ]
    },
    
    "id": {
      "type": "string",
      "pattern": "^urn:ngsi-ld:Scene:(Route|Takt|Process|Step|SubStep):[A-Za-z0-9_-]+:[A-Za-z0-9_-]+:[0-9]{14}$",
      "description": "Scene实例唯一标识符,格式: urn:ngsi-ld:Scene:{sceneLevel}:{workpieceCode}:{mbomRef}:{timestamp}",
      "examples": [
        "urn:ngsi-ld:Scene:Process:PO123-001:T01-P0010:20250108150000"
      ]
    },
    
    "type": {
      "type": "string",
      "const": "Scene",
      "description": "实体类型固定为Scene"
    },
    
    "sceneLevel": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "string",
          "enum": ["Route", "Takt", "Process", "Step", "SubStep"],
          "description": "场景层级"
        }
      },
      "description": "场景层级标识"
    },
    
    "sceneCode": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "string",
          "minLength": 1,
          "maxLength": 100
        }
      },
      "description": "场景业务编码"
    },
    
    "sceneName": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {"type": "string", "minLength": 1, "maxLength": 200}
      },
      "description": "场景名称"
    },
    
    "description": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {"type": "string", "maxLength": 1000}
      },
      "description": "场景详细描述"
    },
    
    "refMBOM": {
      "type": "object",
      "required": ["type", "object"],
      "properties": {
        "type": {"type": "string", "const": "Relationship"},
        "object": {
          "type": "string",
          "pattern": "^urn:ngsi-ld:MBOM:[A-Za-z0-9_-:]+$",
          "description": "引用的MBOM实体实例ID,层级应与sceneLevel匹配"
        }
      },
      "description": "【关键】引用MBOM实体实例,定义该场景遵循的工艺蓝图"
    },
    
    "inputWorkpiece": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Relationship"},
        "object": {
          "type": "string",
          "pattern": "^urn:ngsi-ld:TwinObject:Workpiece\\.[A-Za-z0-9_-]+$",
          "description": "输入的主工件TwinObject ID"
        },
        "description": {"type": "string"},
        "observedAt": {
          "type": "string",
          "format": "date-time",
          "description": "物料进入场景的时间"
        }
      },
      "description": "【新增】输入的主要流转工件,具有唯一ID的在制品"
    },
    
    "outputWorkpiece": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Relationship"},
        "object": {
          "type": "string",
          "pattern": "^urn:ngsi-ld:TwinObject:(Workpiece|Product)\\.[A-Za-z0-9_-]+$",
          "description": "输出的工件TwinObject ID"
        },
        "description": {"type": "string"},
        "observedAt": {
          "type": "string",
          "format": "date-time",
          "description": "物料完成并离开场景的时间"
        }
      },
      "description": "【新增】输出的工件,表示加工/装配后的新状态实例"
    },
    
    "inputMaterials": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["materialId", "quantity", "unit"],
            "properties": {
              "materialId": {
                "type": "string",
                "pattern": "^urn:ngsi-ld:TwinObject:Material\\.[A-Za-z0-9_-]+$",
                "description": "原材料/配件的TwinObject ID"
              },
              "materialName": {
                "type": "string",
                "description": "物料名称"
              },
              "quantity": {
                "type": "number",
                "minimum": 0,
                "description": "消耗数量"
              },
              "unit": {
                "type": "string",
                "description": "单位,如piece/kg/liter等"
              },
              "batchNo": {
                "type": "string",
                "description": "批次号,用于质量追溯"
              },
              "supplierCode": {
                "type": "string",
                "description": "供应商编码"
              },
              "lotTraceCode": {
                "type": "string",
                "description": "批次追溯码"
              }
            }
          }
        }
      },
      "description": "【新增】输入的原材料/采购件清单,用于装配类工序。每项包含物料ID、数量、批次等追溯信息"
    },
    
    "consumedMaterials": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["materialId", "consumedQuantity", "unit"],
            "properties": {
              "materialId": {
                "type": "string",
                "pattern": "^urn:ngsi-ld:TwinObject:(Consumable|Material)\\.[A-Za-z0-9_-]+$"
              },
              "materialName": {"type": "string"},
              "consumedQuantity": {
                "type": "number",
                "minimum": 0,
                "description": "实际消耗量"
              },
              "unit": {"type": "string"},
              "batchNo": {"type": "string"}
            }
          }
        }
      },
      "description": "【新增】消耗性辅助材料(如焊丝、切削液、能源等),用于成本核算"
    },
    
    "refFinalProduct": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Relationship"},
        "object": {
          "type": "string",
          "pattern": "^urn:ngsi-ld:TwinObject:Product\\.[A-Za-z0-9_-]+$",
          "description": "最终产品ID"
        },
        "description": {"type": "string"}
      },
      "description": "【新增】所有中间态物料通过此关系追溯到最终交付产品"
    },
    
    "timeFrame": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "object",
          "required": ["start"],
          "properties": {
            "start": {
              "type": "string",
              "format": "date-time",
              "description": "场景开始时间(UTC ISO8601)"
            },
            "end": {
              "type": "string",
              "format": "date-time",
              "description": "场景结束时间,执行中为null"
            },
            "actualDuration": {
              "type": "number",
              "minimum": 0,
              "description": "实际执行时长(秒)"
            }
          }
        }
      },
      "description": "【时空容器-时间维度】场景执行的时间范围"
    },
    
    "location": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "object",
          "properties": {
            "lineCode": {"type": "string", "description": "产线编码"},
            "stationCode": {"type": "string", "description": "工位编码,StepScene必填"},
            "positionCode": {"type": "string", "description": "台位编码"},
            "zoneId": {"type": "string", "description": "区域标识"},
            "coordinates": {
              "type": "object",
              "properties": {
                "latitude": {"type": "number"},
                "longitude": {"type": "number"}
              }
            }
          }
        }
      },
      "description": "【时空容器-空间维度】场景执行的空间位置"
    },
    
    "status": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "string",
          "enum": ["Planned", "Running", "Paused", "Completed", "Failed", "Aborted"],
          "description": "Planned=计划中; Running=执行中; Paused=暂停; Completed=正常完成; Failed=失败终止; Aborted=人工中止"
        }
      },
      "description": "场景执行状态"
    },
    
    "partOfScene": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Relationship"},
        "object": {
          "type": "string",
          "pattern": "^urn:ngsi-ld:Scene:[A-Za-z0-9_-:]+$",
          "description": "父场景ID,指向上一层级的Scene实例"
        }
      },
      "description": "反向关系:指向父场景(N:1)"
    },
    
    "includesSubScenes": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Relationship"},
        "object": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^urn:ngsi-ld:Scene:[A-Za-z0-9_-:]+$"
          },
          "uniqueItems": true
        }
      },
      "description": "正向关系:指向子场景列表(1:N)"
    },
    
    "involvesAsset": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Relationship"},
        "object": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^urn:ngsi-ld:TwinObject:[A-Za-z0-9_.-]+$"
          },
          "uniqueItems": true,
          "description": "涉及的TwinObject实例ID列表,包括设备/工装/人员等"
        }
      },
      "description": "场景涉及的所有孪生体对象,用于LLM分析时确定上下文边界"
    },
    
    "responsibilityAssignment": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["stepId", "responsible"],
            "properties": {
              "stepId": {"type": "string"},
              "responsible": {
                "type": "string",
                "pattern": "^urn:ngsi-ld:Role:[A-Za-z_]+$",
                "description": "执行者角色(R)"
              },
              "accountable": {
                "type": "string",
                "pattern": "^urn:ngsi-ld:Role:[A-Za-z_]+$",
                "description": "最终负责人角色(A),必须唯一"
              },
              "consulted": {
                "type": "array",
                "items": {"type": "string"},
                "description": "咨询角色列表(C)"
              },
              "informed": {
                "type": "array",
                "items": {"type": "string"},
                "description": "知会角色列表(I)"
              }
            }
          }
        }
      },
      "description": "RACI职责分配"
    },
    
    "stepLog": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["stepId", "performedBy", "observedAt"],
            "properties": {
              "stepId": {"type": "string"},
              "performedBy": {
                "type": "object",
                "required": ["personId", "roleId"],
                "properties": {
                  "personId": {
                    "type": "string",
                    "pattern": "^urn:ngsi-ld:TwinObject:Person\\.[A-Za-z0-9_-]+$"
                  },
                  "roleId": {
                    "type": "string",
                    "pattern": "^urn:ngsi-ld:Role:[A-Za-z_]+$"
                  }
                }
              },
              "observedAt": {
                "type": "string",
                "format": "date-time"
              },
              "approvedBy": {
                "type": "object",
                "properties": {
                  "personId": {"type": "string"},
                  "roleId": {"type": "string"}
                }
              },
              "duration": {
                "type": "number",
                "minimum": 0,
                "description": "步骤实际耗时(秒)"
              },
              "resultData": {
                "type": "object",
                "description": "步骤级结果数据"
              }
            }
          }
        }
      },
      "description": "步骤执行日志,记录实际执行者+角色+时间+结果"
    },
    
    "result": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "object",
          "required": ["overallStatus", "derivedFrom"],
          "properties": {
            "overallStatus": {
              "type": "string",
              "enum": ["Pass", "Fail", "PartialPass", "Inconclusive", "Pending"]
            },
            "kpi": {
              "type": "object",
              "description": "KPI指标"
            },
            "defects": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "defectCode": {"type": "string"},
                  "severity": {
                    "type": "string",
                    "enum": ["Critical", "Major", "Minor"]
                  },
                  "description": {"type": "string"},
                  "detectedAt": {
                    "type": "string",
                    "format": "date-time"
                  }
                }
              }
            },
            "deviations": {
              "type": "array",
              "items": {
                "type": "object",
                "properties": {
                  "type": {"type": "string"},
                  "description": {"type": "string"},
                  "severity": {"type": "string"}
                }
              }
            },
            "derivedFrom": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^urn:ngsi-ld:(ModalData|Scene|Event):[A-Za-z0-9_-:]+$"
              },
              "minItems": 1,
              "description": "【核心溯源】结果来源的数据/子场景ID列表,支持一跳回溯"
            },
            "computedAt": {
              "type": "string",
              "format": "date-time"
            },
            "computedBy": {"type": "string"}
          }
        }
      },
      "description": "【关键】场景执行结果,必须包含derivedFrom实现溯源"
    },
    
    "predecessorScene": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Relationship"},
        "object": {
          "type": "string",
          "pattern": "^urn:ngsi-ld:Scene:[A-Za-z0-9_-:]+$"
        }
      },
      "description": "前序场景,指向同层级或跨层级的前置Scene"
    },
    
    "successorScene": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Relationship"},
        "object": {
          "type": "string",
          "pattern": "^urn:ngsi-ld:Scene:[A-Za-z0-9_-:]+$"
        }
      },
      "description": "后续场景"
    },
    
    "metadata": {
      "type": "object",
      "properties": {
        "type": {"type": "string", "const": "Property"},
        "value": {
          "type": "object",
          "properties": {
            "createdAt": {
              "type": "string",
              "format": "date-time"
            },
            "createdBy": {"type": "string"},
            "modifiedAt": {
              "type": "string",
              "format": "date-time"
            },
            "tags": {
              "type": "array",
              "items": {"type": "string"}
            },
            "notes": {"type": "string"}
          }
        }
      },
      "description": "元数据信息"
    }
  },
  
  "additionalProperties": false,
  
  "allOf": [
    {
      "if": {
        "properties": {
          "sceneLevel": {
            "properties": {
              "value": {"const": "Step"}
            }
          }
        }
      },
      "then": {
        "properties": {
          "location": {
            "properties": {
              "value": {
                "required": ["stationCode"]
              }
            }
          }
        },
        "description": "StepScene必须指定精确的stationCode"
      }
    }
  ]
}

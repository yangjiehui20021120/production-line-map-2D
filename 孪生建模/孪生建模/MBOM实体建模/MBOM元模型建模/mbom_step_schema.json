{
  "$schema": "http://json-schema.org/draft-07/schema#",
  "$id": "https://example.com/schemas/MBOM.Step.schema.json",
  "title": "MBOM Step Entity Schema",
  "description": "工步实体元模型 - 最小执行单元,定义具体操作和测量要求 (mbomType=Step)",
  "type": "object",
  
  "required": [
    "id",
    "type",
    "mbomType",
    "stepSeq",
    "stepName",
    "stdTime",
    "stationCode",
    "partOfProcess"
  ],
  
  "properties": {
    "@context": {
      "type": "array",
      "items": {
        "type": "string",
        "format": "uri"
      },
      "description": "NGSI-LD上下文定义",
      "examples": [
        [
          "https://uri.etsi.org/ngsi-ld/v1/ngsi-ld-core-context.jsonld",
          "https://example.com/contexts/mbom-context.jsonld"
        ]
      ]
    },
    
    "id": {
      "type": "string",
      "pattern": "^urn:ngsi-ld:MBOM:[A-Za-z0-9_-]+:T[0-9]{2,3}:P[0-9]{4}:S[0-9]{2,3}$",
      "description": "Step实体唯一标识符,格式: urn:ngsi-ld:MBOM:{productCode}:T{taktSeq}:P{procCode}:S{stepSeq}",
      "examples": [
        "urn:ngsi-ld:MBOM:M000004670327:T01:P0010:S01",
        "urn:ngsi-ld:MBOM:M000004670327:T02:P0020:S03"
      ]
    },
    
    "type": {
      "type": "string",
      "const": "MBOM",
      "description": "实体类型固定为MBOM"
    },
    
    "mbomType": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "string",
          "const": "Step",
          "description": "子类型固定为Step,标识这是工步实体"
        }
      },
      "description": "MBOM子类型标识"
    },
    
    "stepSeq": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "integer",
          "minimum": 1,
          "maximum": 999,
          "description": "工步序号,在工序内的顺序位置,从1开始"
        }
      },
      "description": "工步序号,定义工步在工序内的执行顺序",
      "examples": [
        {
          "type": "Property",
          "value": 1
        }
      ]
    },
    
    "stepCode": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "string",
          "minLength": 1,
          "maxLength": 50,
          "description": "工步业务编码,可选字段"
        }
      },
      "description": "工步业务编码"
    },
    
    "stepName": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "string",
          "minLength": 1,
          "maxLength": 200
        }
      },
      "description": "工步名称,业务友好的描述性名称",
      "examples": [
        {
          "type": "Property",
          "value": "焊接反装焊缝"
        }
      ]
    },
    
    "processKind": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "string",
          "enum": ["process", "handling", "inspection", "andon", "measurement"],
          "description": "process=加工; handling=搬运; inspection=检验; andon=报警; measurement=测量"
        }
      },
      "description": "工步类型,继承自Process或独立定义"
    },
    
    "stdTime": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "number",
          "minimum": 0,
          "description": "标准工时数值"
        },
        "unitCode": {
          "type": "string",
          "enum": ["MIN", "SEC", "HOUR"],
          "default": "MIN",
          "description": "时间单位"
        }
      },
      "description": "标准工时,定义该工步的标准完成时间",
      "examples": [
        {
          "type": "Property",
          "value": 210,
          "unitCode": "MIN"
        }
      ]
    },
    
    "stationCode": {
      "type": "object",
      "required": ["type", "value"],
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "string",
          "description": "执行工位编码,如ST-HJ-01, BF等"
        }
      },
      "description": "工步执行的工位编码",
      "examples": [
        {
          "type": "Property",
          "value": "ST-HJ-01"
        }
      ]
    },
    
    "positionCode": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "string",
          "description": "工位内的具体位置编码,可选"
        }
      },
      "description": "工位内的位置编码,用于精确定位"
    },
    
    "partOfProcess": {
      "type": "object",
      "required": ["type", "object"],
      "properties": {
        "type": {
          "type": "string",
          "const": "Relationship"
        },
        "object": {
          "type": "string",
          "pattern": "^urn:ngsi-ld:MBOM:[A-Za-z0-9_-]+:T[0-9]+:P[0-9]+$",
          "description": "所属Process实体ID"
        }
      },
      "description": "反向关系:指向所属的Process实体 (N:1)。双向关系:Process.composedOfSteps指向此实体",
      "examples": [
        {
          "type": "Relationship",
          "object": "urn:ngsi-ld:MBOM:M000004670327:T01:P0010"
        }
      ]
    },
    
    "resourceClasses": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "array",
          "items": {
            "type": "string",
            "enum": [
              "OPERATOR",
              "AUTO_WELDER",
              "ROBOT",
              "CRANE",
              "LASER_SCANNER",
              "HYDRAULIC_PRESS",
              "NDT_ULTRASONIC",
              "QC_TOOL",
              "HANDTOOL",
              "CART",
              "CAMERA",
              "TEMP_SENSOR",
              "HUMIDITY_SENSOR",
              "MES_SYSTEM"
            ]
          },
          "uniqueItems": true,
          "description": "资源类别列表"
        }
      },
      "description": "工步所需的资源类别,抽象的资源类型定义",
      "examples": [
        {
          "type": "Property",
          "value": ["AUTO_WELDER", "ROBOT"]
        }
      ]
    },
    
    "roleCodes": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Relationship"
        },
        "object": {
          "type": "array",
          "items": {
            "type": "string",
            "pattern": "^urn:ngsi-ld:Role:ROLE_[A-Z_]+$"
          },
          "uniqueItems": true
        }
      },
      "description": "工步所需的人员角色,引用Role实体列表"
    },
    
    "actsOnType": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "string",
          "enum": ["Workpiece", "Station", "Buffer", "Equipment"],
          "description": "Workpiece=工件; Station=工位; Buffer=缓冲区; Equipment=设备"
        }
      },
      "description": "工步作用对象类型,定义该工步对什么进行操作"
    },
    
    "actsOnHint": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "string",
          "description": "作用对象提示,自然语言描述"
        }
      },
      "description": "作用对象的描述性提示",
      "examples": [
        {
          "type": "Property",
          "value": "侧墙型材V、IV"
        }
      ]
    },
    
    "qgateIn": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "boolean",
          "description": "true表示需要入口质量门检查"
        }
      },
      "description": "入口质量门,工步开始前是否需要质量检查",
      "examples": [
        {
          "type": "Property",
          "value": true
        }
      ]
    },
    
    "qgateOut": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "boolean",
          "description": "true表示需要出口质量门检查"
        }
      },
      "description": "出口质量门,工步完成后是否需要质量检查",
      "examples": [
        {
          "type": "Property",
          "value": true
        }
      ]
    },
    
    "resultKeys": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "array",
          "items": {
            "type": "string"
          },
          "description": "工步输出的结果键列表"
        }
      },
      "description": "工步输出结果键,用于标识工步产生的数据字段"
    },
    
    "materialChecks": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["materialCode", "checkType"],
            "properties": {
              "materialCode": {
                "type": "string",
                "description": "物料编码"
              },
              "checkType": {
                "type": "string",
                "enum": ["presence", "quantity", "quality", "specification"],
                "description": "检查类型: presence=到位检查, quantity=数量, quality=质量, specification=规格"
              },
              "description": {
                "type": "string",
                "description": "检查描述"
              }
            }
          }
        }
      },
      "description": "工步级物料检查,定义需要检查的物料及检查类型"
    },
    
    "materialConsumption": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["materialCode", "quantity", "unit"],
            "properties": {
              "materialCode": {
                "type": "string",
                "description": "物料编码"
              },
              "quantity": {
                "type": "number",
                "minimum": 0
              },
              "unit": {
                "type": "string",
                "description": "单位,如KG, L, PCS"
              }
            }
          }
        }
      },
      "description": "工步级物料消耗,定义该工步消耗的具体物料和数量",
      "examples": [
        {
          "type": "Property",
          "value": [
            {
              "materialCode": "MAT_WELDING_WIRE_ER70S6",
              "quantity": 1.2,
              "unit": "KG"
            }
          ]
        }
      ]
    },
    
    "materialsHandled": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["materialCode", "operation"],
            "properties": {
              "materialCode": {
                "type": "string"
              },
              "operation": {
                "type": "string",
                "enum": ["lift_and_place", "weld", "cut", "drill", "assemble", "inspect", "flip", "transfer", "store"],
                "description": "操作类型"
              }
            }
          }
        }
      },
      "description": "工步级物料操作,定义对物料的具体操作动作"
    },
    
    "resourceRequirements": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "object",
          "properties": {
            "requiredCapabilities": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^CAP\\.[A-Za-z.]+$",
                "description": "能力标识,格式: CAP.{domain}.{capability}"
              },
              "description": "所需设备能力列表,抽象能力定义"
            },
            "requiredSkills": {
              "type": "array",
              "items": {
                "type": "string",
                "pattern": "^Skill\\.[A-Za-z.]+$",
                "description": "技能标识,格式: Skill.{domain}.{skill}"
              },
              "description": "所需人员技能列表"
            },
            "mustHaveTooling": {
              "type": "array",
              "items": {
                "type": "string"
              },
              "description": "必备工装列表,引用Tooling编码"
            }
          }
        }
      },
      "description": "工步级资源要求,定义能力、技能、工装的具体需求",
      "examples": [
        {
          "type": "Property",
          "value": {
            "requiredCapabilities": ["CAP.Weld.MIG", "CAP.Weld.Program"],
            "requiredSkills": ["Skill.Welder.L2"],
            "mustHaveTooling": ["WELDER_MIG_300A", "FIXTURE_HJ_01"]
          }
        }
      ]
    },
    
    "requiredMeasurements": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "array",
          "items": {
            "type": "object",
            "required": ["modalityCode", "ruleId", "timing"],
            "properties": {
              "modalityCode": {
                "type": "string",
                "description": "测量模态代码,引用Modality Catalog,抽象的测量名称"
              },
              "ruleId": {
                "type": "string",
                "description": "质量规则ID,引用Rule Catalog,定义合格判定标准"
              },
              "timing": {
                "type": "string",
                "enum": ["pre", "in", "post"],
                "description": "测量时机: pre=工步开始前, in=工步执行中, post=工步完成后"
              },
              "aggregator": {
                "type": "string",
                "enum": ["mean", "max", "min", "sum", "p95", "median"],
                "description": "聚合方式,用于多次采样的统计"
              },
              "sampleSize": {
                "type": "integer",
                "minimum": 1,
                "description": "采样数量"
              },
              "capturedByResourceClass": {
                "type": "string",
                "description": "采集资源类别,如AUTO_WELDER, CRANE, QC_TOOL等"
              },
              "description": {
                "type": "string",
                "description": "测量描述"
              }
            }
          }
        }
      },
      "description": "Step级测量要求(最细粒度),定义具体的测量参数和质量检查。MBOM只定义抽象的modalityCode,具体的数据采集点位通过TwinObject.ModalityBinding映射",
      "examples": [
        {
          "type": "Property",
          "value": [
            {
              "modalityCode": "WeldingCurrent",
              "ruleId": "RULE_CURRENT_150_250A",
              "timing": "in",
              "aggregator": "mean",
              "capturedByResourceClass": "AUTO_WELDER",
              "description": "焊接电流实时监控"
            },
            {
              "modalityCode": "WeldSeamWidth",
              "ruleId": "RULE_SEAM_WIDTH_8_12MM",
              "timing": "post",
              "sampleSize": 5,
              "capturedByResourceClass": "QC_TOOL",
              "description": "焊缝宽度检测"
            }
          ]
        }
      ]
    },
    
    "stepDocuments": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "object",
          "properties": {
            "workInstructionSection": {
              "type": "string",
              "description": "作业指导书章节编码"
            },
            "safetyNotes": {
              "type": "string",
              "description": "安全注意事项"
            },
            "qualityStandard": {
              "type": "string",
              "description": "质量标准引用"
            },
            "safetyChecklist": {
              "type": "string",
              "description": "安全检查表编码"
            }
          }
        }
      },
      "description": "工步级关联文档",
      "examples": [
        {
          "type": "Property",
          "value": {
            "workInstructionSection": "WI_WELD_001_S4",
            "qualityStandard": "ISO 5817:2014 焊缝质量B级",
            "safetyNotes": "佩戴焊接面罩和防护手套,确保通风"
          }
        }
      ]
    },
    
    "evidenceFormCode": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "string",
          "description": "证据表单编码,用于记录工步执行证据"
        }
      },
      "description": "证据表单编码,关联到具体的数据采集表单"
    },
    
    "templateVersion": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "string",
          "description": "工步模板版本"
        }
      },
      "description": "工步模板版本标识,用于工步复用和版本管理"
    },
    
    "isOptional": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "boolean",
          "description": "true表示该工步为可选,可根据情况跳过"
        }
      },
      "description": "是否为可选工步"
    },
    
    "canRunInParallel": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "boolean",
          "description": "true表示该工步可与其他工步并行执行"
        }
      },
      "description": "是否支持并行执行"
    },
    
    "predecessorStep": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Relationship"
        },
        "object": {
          "type": "string",
          "pattern": "^urn:ngsi-ld:MBOM:[A-Za-z0-9_-]+:T[0-9]+:P[0-9]+:S[0-9]+$"
        }
      },
      "description": "前序工步,建立工步间依赖关系"
    },
    
    "successorStep": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Relationship"
        },
        "object": {
          "type": "string",
          "pattern": "^urn:ngsi-ld:MBOM:[A-Za-z0-9_-]+:T[0-9]+:P[0-9]+:S[0-9]+$"
        }
      },
      "description": "后续工步,建立工步间依赖关系"
    },
    
    "metadata": {
      "type": "object",
      "properties": {
        "type": {
          "type": "string",
          "const": "Property"
        },
        "value": {
          "type": "object",
          "properties": {
            "createdAt": {
              "type": "string",
              "format": "date-time"
            },
            "modifiedAt": {
              "type": "string",
              "format": "date-time"
            },
            "notes": {
              "type": "string"
            }
          }
        }
      },
      "description": "元数据信息"
    }
  },
  
  "additionalProperties": false
}

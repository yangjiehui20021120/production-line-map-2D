# Assignment 元模型设计说明文档

**文档版本**: V1.0  
**制定日期**: 2025-10-22  
**适用范围**: 数字孪生责任流建模

---

## 一、元模型定位与设计目标

### 1.1 核心定位

Assignment（岗位指派）元模型是数字孪生体系中**支撑责任流**的关键辅助实体，用于实现**人员与岗位角色之间的时态化绑定关系**。它解决了"谁在何时履行什么岗位"的核心问题，是将抽象的Role定义映射到具体执行人员并加上时间维度的桥梁实体。

在数字孪生六大核心实体（TwinObject、Scene、MBOM、Role、Modality、ModalData）的基础上，Assignment作为**辅助实体**，通过建立Person类型的TwinObject与Role之间的动态连接，为责任链闭环提供了"有岗有人"的保障机制。

### 1.2 设计目标

本元模型设计遵循以下目标：

1. **时态性**：支持记录指派的有效期，实现历史追溯和时间段查询
2. **合规性**：确保人员资质与角色要求匹配，支持审批流程追溯
3. **灵活性**：既支持常规轮班指派，也支持临时任务级指派
4. **可追溯性**：每条指派记录都有创建者、审批记录等审计信息
5. **标准化**：完全遵循NGSI-LD规范，确保互操作性和语义一致性

---

## 二、元模型架构设计

### 2.1 NGSI-LD实体结构

Assignment被设计为符合NGSI-LD规范的完整实体，而非简单的Relationship。这一设计决策基于以下考虑：

**为什么不是简单Relationship？**
- 简单的Relationship无法承载丰富的时间维度（validFrom/validTo）
- 无法记录复杂的业务语义（班次、资质验证、审批流程）
- 无法支持独立的生命周期管理和状态机转换

**实体化的优势：**
- 拥有独立的ID和生命周期，可独立查询和管理
- 支持状态机（Active/Suspended/Revoked/Expired）
- 可记录完整的审计信息（创建者、审批记录、修改历史）
- 可与Scene等实体建立复杂的关联关系

### 2.2 核心字段分类

元模型的字段按功能分为五大类：

#### （1）实体标识类（必填）
- **id**：全局唯一标识符，建议格式包含人员、角色、组织、时间信息
- **type**：固定值"Assignment"
- **@context**：NGSI-LD上下文定义

#### （2）关系引用类（必填）
- **assigneeId**：被指派人员引用（必须是Person类型的TwinObject）
- **roleId**：指派角色引用（必须是有效的Role实体）
- **orgId**：所属组织单元引用（限定指派的组织范围）

#### （3）时间维度类（必填）
- **validFrom**：指派生效时间
- **validTo**：指派失效时间

#### （4）业务扩展类（可选）
- **sceneId**：特定场景引用（用于临时任务指派）
- **shiftId**：班次标识
- **qualificationRef**：人员资质引用
- **approvalRef**：审批记录引用

#### （5）状态管理类（必填）
- **assignmentStatus**：当前指派状态（Active/Suspended/Revoked/Expired）
- **createdBy**：创建者引用
- **notes**：备注信息

---

## 三、关键设计原则

### 3.1 时态化绑定原则

Assignment的核心价值在于**时态性**，即记录"在特定时间段内"的人岗关系。设计中强制要求validFrom和validTo字段，并通过以下机制确保时态逻辑正确：

- **时间校验**：validTo必须晚于validFrom
- **重叠检测**：同一人员在同一时间段内不能有多个Active状态的Assignment（避免一人多岗冲突）
- **自动过期**：系统自动检测到达validTo时间后，将状态从Active转为Expired

### 3.2 责任可追溯原则

为实现"责任可计算、过程可追溯"，元模型设计了完整的审计链条：

- **创建者记录**：createdBy字段记录是谁创建了这条指派
- **审批流程**：approvalRef字段关联审批单，记录指派决策的审批过程
- **资质验证**：qualificationRef字段记录人员具备的资质，确保人岗匹配合规
- **状态历史**：通过NGSI-LD的modifiedAt元数据，可追溯状态变更历史

### 3.3 场景灵活适配原则

元模型支持两种指派模式：

**常规指派模式**：
- 不填写sceneId字段
- 指派在整个有效期内对所有场景生效
- 适用于轮班制、长期岗位任命等场景

**临时任务指派模式**：
- 填写sceneId字段，关联到特定Scene实例
- 指派仅在该场景执行期间有效
- 适用于临时调配、紧急支援等场景

### 3.4 状态机管理原则

Assignment实体拥有独立的状态机，支持以下状态转换：

```
[创建] → Active (生效)
Active → Suspended (暂停)
Suspended → Active (恢复)
Active → Revoked (撤销)
Suspended → Revoked (撤销)
Active → Expired (自动过期)
```

状态转换规则：
- 到达validTo时间，系统自动将Active转为Expired
- Suspended和Revoked需要管理员手动操作且需审批权限
- Expired和Revoked为终态，不可再转换

---

## 四、字段详细设计

### 4.1 必填字段设计

#### assigneeId（被指派人员）
- **类型**：Relationship
- **引用目标**：Person类型的TwinObject
- **格式约束**：`^urn:ngsi-ld:TwinObject:Person\.[A-Za-z0-9._-]+$`
- **设计考虑**：
  - 必须引用真实存在的Person实体（创建前校验）
  - 支持通过NGSI-LD图查询反向查找某人的所有指派
  - 为人员提供了统一的数字身份基础

#### roleId（指派角色）
- **类型**：Relationship
- **引用目标**：Role实体
- **格式约束**：`^urn:ngsi-ld:Role:[A-Za-z0-9._-]+$`
- **设计考虑**：
  - Role定义了岗位的静态职责、权限和资质要求
  - Assignment通过roleId将这些要求动态绑定到具体人员
  - 实现了"职责与个体解耦"的建模公理

#### orgId（所属组织）
- **类型**：Relationship
- **引用目标**：OrgUnit实体
- **设计考虑**：
  - 限定指派的组织范围，支持多车间、多产线的独立管理
  - 为权限控制提供组织维度的边界
  - 支持跨组织人员调配的场景

#### validFrom/validTo（有效期）
- **类型**：Property，值为ISO8601格式的UTC时间
- **设计考虑**：
  - 强制时间范围，避免"永久有效"的模糊状态
  - 长期指派可设定validTo为较远的未来时间（如2030-12-31）
  - 支持基于时间的精确查询（如"2025年9月8日早班谁是焊工？"）

#### assignmentStatus（指派状态）
- **类型**：Property，枚举值
- **可选值**：Active、Suspended、Revoked、Expired
- **设计考虑**：
  - 提供实时的指派可用性判断
  - 支持状态机驱动的业务逻辑
  - 便于统计分析（如"当前有多少Active指派"）

### 4.2 可选字段设计

#### sceneId（特定场景）
- **使用场景**：临时任务指派
- **设计考虑**：
  - 不填写时，指派对所有场景生效
  - 填写时，指派仅在该场景执行期间有效
  - 支持"一人在常规岗位 + 临时支援另一任务"的复杂场景

#### shiftId（班次）
- **设计考虑**：
  - 支持企业自定义班次编码（如A/B/C班或早中晚班）
  - 为排班管理提供数据基础
  - 可与时间段结合进行班次冲突检测

#### qualificationRef（资质引用）
- **设计考虑**：
  - 支持单个或多个资质证书引用
  - 在Assignment创建时校验人员资质是否满足Role要求
  - 为合规审计提供证据链

#### approvalRef（审批记录）
- **设计考虑**：
  - 关联到审批流程实体，记录谁批准了这条指派
  - 为责任追溯提供审批链条
  - 支持审计查询（如"所有未经审批的指派"）

---

## 五、使用场景与实例模式

### 5.1 常规轮班指派

**业务场景**：员工张三在侧墙车间早班担任焊接工

**关键特征**：
- 有明确的班次（shiftId）
- 时间范围为一个班次（8小时）
- 在组织范围内生效（orgId指向车间）

**适用性**：日常排班管理、周期性轮班制度

### 5.2 临时任务指派

**业务场景**：李四被临时调配到订单PO123的正面焊接场景担任水蜘蛛

**关键特征**：
- 有sceneId字段，关联到特定Scene实例
- 时间范围仅覆盖任务执行期
- 通常需要审批记录（approvalRef）

**适用性**：紧急支援、临时调配、特殊任务

### 5.3 长期岗位任命

**业务场景**：王五被长期任命为质量主管

**关键特征**：
- validTo设为远期时间（如2030年）
- 通常有多个资质要求（qualificationRef为数组）
- 必须有审批记录（正式任命流程）

**适用性**：管理岗位任命、关键岗位固定分配

---

## 六、校验规则与约束

### 6.1 创建前校验

1. **必填字段完整性**：所有required字段必须提供
2. **时间逻辑校验**：validTo必须晚于validFrom
3. **实体存在性校验**：
   - assigneeId引用的Person实体必须存在
   - roleId引用的Role实体必须存在
   - orgId引用的OrgUnit实体必须存在
4. **资质匹配校验**：人员的qualificationRef必须满足Role的qualificationReq
5. **时间冲突检测**：同一人员在同一时间段内不能有多个Active状态的Assignment

### 6.2 运行时约束

1. **状态转换合法性**：只能按状态机规则转换状态
2. **自动过期检测**：系统定时任务检测到达validTo的Assignment并自动标记为Expired
3. **权限校验**：状态变更操作需要验证操作者的权限

### 6.3 删除保护

Assignment实体原则上**不允许物理删除**，只能通过状态转换为Revoked来"软删除"。这保证了审计链条的完整性。

---

## 七、与核心实体的集成

### 7.1 与TwinObject的关系

- Assignment的assigneeId字段引用Person类型的TwinObject
- Person是人员的数字孪生，包含基本信息、技能、资质等
- Assignment为Person提供了"当前在岗情况"的动态视图

### 7.2 与Role的关系

- Assignment的roleId字段引用Role实体
- Role定义了岗位的静态"蓝图"（职责、权限、资质要求）
- Assignment将Role动态绑定到具体人员并加上时间维度

### 7.3 与Scene的关系

- Scene在执行前需要检查所需的每个Role是否都有有效的Assignment
- Assignment的sceneId字段可以将指派限定在特定场景
- Scene的stepLog中记录的personId和roleId来自于Assignment的绑定关系

### 7.4 在责任流中的作用

数字孪生的"五流模型"中，责任流依赖于Assignment：
- **Role**定义了"需要什么岗位负责"（静态）
- **Assignment**落实了"由哪个人负责且在何时负责"（动态）
- **Scene.stepLog**记录了"实际谁执行了什么"（履职证据）

三者构成了完整的责任链闭环。

---

## 八、元模型演进与扩展

### 8.1 版本管理

当前元模型版本为V1.0，未来可能的演进方向：

1. **增加deputyId字段**：支持代理人机制（如休假时的临时替代）
2. **增加performanceRef字段**：关联绩效考核记录
3. **增加trainingRef字段**：关联培训记录，追踪人员能力成长

### 8.2 扩展性设计

元模型遵循NGSI-LD的开放性原则：
- 可在不修改核心字段的前提下，通过增加新的Property或Relationship扩展
- 可通过@context机制引入企业特定的语义定义
- additionalProperties设为false，确保扩展的规范性

---

## 九、实施建议

### 9.1 系统集成建议

1. **与排班系统集成**：排班系统生成Assignment实例，数字孪生平台消费
2. **与HR系统集成**：从HR系统同步人员资质信息，用于资质匹配校验
3. **与MES系统集成**：MES在任务执行前查询有效Assignment，确保"有岗有人"

### 9.2 数据治理建议

1. **定期审计**：每周审计是否有无效Assignment未清理
2. **异常监控**：监控是否有人员无资质却被指派的情况
3. **合规检查**：检查关键岗位的Assignment是否都有审批记录

### 9.3 性能优化建议

1. **索引设计**：在assigneeId、roleId、orgId、validFrom/validTo字段上建立索引
2. **缓存策略**：对"当前有效Assignment"进行缓存，减少查询压力
3. **归档策略**：将Expired/Revoked状态的Assignment定期归档到历史库

---

## 十、总结

Assignment元模型是数字孪生责任流建模的核心支撑实体，它通过以下设计特点实现了"有岗有人、责任可追溯"的目标：

✅ **时态化绑定**：通过validFrom/validTo实现时间维度的精确控制  
✅ **状态机管理**：通过assignmentStatus实现生命周期的规范化管理  
✅ **多模式支持**：既支持常规轮班，也支持临时任务指派  
✅ **审计友好**：通过createdBy、approvalRef等字段构建完整审计链  
✅ **标准化**：完全遵循NGSI-LD规范，确保互操作性

本元模型为Assignment实体的实例创建提供了规范化的约束和指导，确保每条Assignment记录都具有明确的语义、完整的结构和可追溯的来源，从而支撑数字孪生体系中责任流的可靠运行。

# T1-数字孪生管理平台 - 技术规格书

**面向 Claude Code 开发**

**版本**: v2.0.0  
**日期**: 2025-01-16  
**任务编号**: T1

---

## 📋 文档说明

本技术规格书是提交给 **Claude Code** 的T1数字孪生管理平台开发任务书。V2.0版本重点改进：
- ✅ 明确基于Fiware六层架构体系
- ✅ 采用前后端分离、前端优先的开发策略
- ✅ 保持13个功能的业务视角，同时体现技术架构映射
- ✅ 使用Draco进行数据持久化，集成Perseo规则引擎
- ✅ 提供详细的功能逻辑说明和API契约规范
- ❌ 不规定具体代码实现（由Claude Code自行设计）

---

## 1. 任务定位 ⭐

### 1.1 功能边界

**本平台要实现的功能**：
- ✅ 8类核心实体（TwinObject、MBOM、Scene、Modality、ModalityBinding、ModalData、Role、Assignment）的完整管理
- ✅ 基于Fiware六层架构的完整数字孪生平台
- ✅ NGSI-LD标准数据服务接口（基于Scorpio Broker）
- ✅ 元模型管理（JSON Schema导入和可视化展示）
- ✅ 语义锚定和变更通知机制
- ✅ Web管理界面（实体管理、关系图谱、数据统计）
- ✅ 数据服务接口管理和监控
- ✅ IoT Agent多协议数据接入
- ✅ Draco数据持久化服务
- ✅ 历史数据存储和查询（TimescaleDB）
- ✅ 关系图谱管理（Neo4j）
- ✅ 非结构化数据管理（MinIO对象存储）
- ✅ Perseo复杂事件处理和规则引擎
- ✅ 安全认证和访问控制

**明确不实现的功能**：
- ❌ 生产计划编排（原因：属于上层业务应用）
- ❌ 2D/3D可视化地图渲染引擎（原因：由T3任务实现）
- ❌ 智能分析算法（原因：由T4任务实现）
- ❌ 仿真模型运行（原因：由T5任务实现）
- ❌ Mock数据生成（原因：由T2 Mockserver实现）

### 1.2 与其他任务的关系

| 任务 | 关系类型 | 接口方式 | 数据流向 | 说明 |
|-----|---------|---------|---------|------|
| T2-Mockserver | 并行支撑 | - | - | 开发期间T2模拟T1接口 |
| T3-产线2D地图 | 被依赖 | NGSI-LD API | 提供 | T3查询实体数据和订阅变更 |
| T4-智能应用 | 被依赖 | NGSI-LD API | 提供 | T4查询实体数据和订阅变更 |
| T5-生产仿真 | 被依赖 | NGSI-LD API | 提供 | T5查询实体数据 |
| 物理设备 | 数据源 | IoT Agent | 接收 | 通过IoT Agent接入设备数据 |

---

## 2. 数据契约约束 ⭐

### 2.1 使用的实体契约

本平台必须严格遵守项目定义的9个契约文件：

| 契约文件 | 使用方式 | 核心约束 |
|---------|---------|---------|
| 00_总契约.md | 验证 | URN格式、时间格式ISO 8601、编码规范 |
| 01_TwinObject契约.md | 读写验证 | 11种子类型、五类属性接口、继承关系 |
| 02_MBOM契约.md | 读写验证 | 4层结构(Process→Route→Step→Takt)、链式关系 |
| 03_Scene契约.md | 读写验证 | 场景状态、stepLog结构、时间戳规范 |
| 04_Modality契约.md | 读写验证 | 数据模态定义、allowedRange、单位规范 |
| 05_ModalityBinding契约.md | 读写验证 | 三元绑定关系(Twin-Modality-Scene) |
| 06_ModalData契约.md | 读写验证 | 实时数据格式、qualityTag、observedAt |
| 07_Role契约.md | 读写验证 | 角色权限定义、层级关系 |
| 08_Assignment契约.md | 读写验证 | 岗位分配关系、生效时间范围 |

### 2.2 契约遵从要求

**必须遵守**：
- ✅ 实体结构必须完全符合对应的JSON Schema定义
- ✅ URN命名必须符合：`urn:ngsi-ld:{EntityType}:{UniqueID}`
- ✅ 所有关系字段必须使用Relationship类型并指向有效实体URN
- ✅ 时间字段必须使用ISO 8601格式带时区
- ✅ subType字段用于区分TwinObject子类型
- ✅ @context必须包含NGSI-LD核心上下文
- ✅ 实体创建时必须验证必填属性完整性
- ✅ 关系引用必须验证目标实体存在性

**验证方式**：
- 使用JSON Schema验证实体结构
- URN格式正则表达式验证
- 关系引用实时验证
- 契约合规性检查服务

---

## 3. 架构设计 ⭐⭐

### 3.1 Fiware六层架构总览

平台严格遵循Fiware生态的六层架构设计：

```
┌─────────────────────────────────────────────────────────────┐
│               T-L6 自动化与规则响应层                          │
│                    Perseo-FE + Perseo-Core                   │
│                  (复杂事件处理、业务规则引擎)                   │
├─────────────────────────────────────────────────────────────┤
│                 T-L5 可视化与交互层                           │
│                  React前端 + Grafana(可选)                    │
│                  (Web管理界面、数据可视化)                     │
├─────────────────────────────────────────────────────────────┤
│                  T-L4 安全与控制层                            │
│                 JWT认证 + RBAC授权 + API Gateway              │
│               (身份认证、访问控制、API安全网关)                 │
├─────────────────────────────────────────────────────────────┤
│                  T-L3 数据与分析层                            │
│     Draco + TimescaleDB + PostgreSQL + Neo4j + MinIO         │
│           (数据持久化、时序存储、图数据、对象存储)              │
├─────────────────────────────────────────────────────────────┤
│                  T-L2 上下文管理层                            │
│                      Scorpio Broker                          │
│           (实体管理、订阅通知、NGSI-LD接口服务)               │
├─────────────────────────────────────────────────────────────┤
│                   T-L1 感知与接入层                           │
│      IoT Agent (JSON/UL/LoRaWAN/OPC-UA) + MQTT Broker       │
│               (多协议适配、设备接入、数据采集)                  │
└─────────────────────────────────────────────────────────────┘
```

### 3.2 各层详细设计

#### 3.2.1 T-L1 感知与接入层

**核心组件**：
- IoT Agent JSON：处理JSON格式数据
- IoT Agent UL：处理UltraLight 2.0协议
- IoT Agent OPC-UA：处理工业OPC-UA协议
- MQTT Broker (Mosquitto)：消息中间件

**主要职责**：
- 南向连接物理设备，支持多种工业协议
- 协议转换，统一为NGSI-LD格式
- 设备注册和管理
- 数据预处理和过滤

**支撑功能**：
- F3 语义锚定服务（数据接入部分）
- 设备自动发现和注册
- 协议适配器扩展机制

**接口规范**：
```yaml
南向接口:
  - MQTT: mqtt://broker:1883
  - HTTP: http://agent:7896
  - OPC-UA: opc.tcp://server:4840
  
北向接口:
  - NGSI-LD: http://scorpio:9090/ngsi-ld/v1
```

#### 3.2.2 T-L2 上下文管理层

**核心组件**：
- Scorpio Broker 4.1.0+：NGSI-LD Context Broker

**主要职责**：
- 维护所有数字孪生实体的当前状态
- 提供标准NGSI-LD v1.6.1接口
- 管理订阅和通知机制
- 实体关系管理

**支撑功能**：
- F1 实体管理功能（8类实体CRUD）
- F4 订阅通知机制
- F2 元模型管理（Schema存储）

**数据流**：
```
IoT Agent → Scorpio → Draco → Databases
                ↓
          Subscription → Applications
```

#### 3.2.3 T-L3 数据与分析层

**核心组件**：
- **Draco**：基于Apache NiFi的数据持久化服务（替代Cygnus）
- TimescaleDB：时序数据存储
- PostgreSQL：结构化数据存储
- Neo4j：图数据存储
- MinIO：对象存储

**主要职责**：
- 实时数据持久化（通过Draco）
- 历史数据存储和查询
- 数据聚合和分析
- 文件和大对象管理

**Draco数据流配置**：
```
Scorpio订阅 → Draco NiFi处理器 → 多目标存储
                    ↓
         ┌──────────┼──────────┬──────────┐
         ↓          ↓          ↓          ↓
    TimescaleDB  PostgreSQL  Neo4j     MinIO
    (时序数据)   (结构化)    (图关系)  (文件)
```

**支撑功能**：
- F8 历史数据查询
- F11 非结构化数据管理
- F9 数据质量监控
- F6 关系图谱管理（Neo4j部分）

#### 3.2.4 T-L4 安全与控制层

**核心组件**：
- API Gateway（Kong/Nginx）
- JWT认证服务
- RBAC授权服务
- 审计日志服务

**主要职责**：
- 统一身份认证
- 细粒度访问控制
- API限流和熔断
- 安全审计

**支撑功能**：
- F13 安全认证管理
- API访问控制
- 数据权限管理

**安全架构**：
```
请求 → API Gateway → 认证 → 授权 → 业务服务
           ↓          ↓       ↓
        限流检查   JWT验证  RBAC检查
```

#### 3.2.5 T-L5 可视化与交互层

**核心组件**：
- React 18+ 前端应用
- WebSocket服务
- Nginx静态资源服务
- Grafana（可选，用于运维监控）

**主要职责**：
- Web管理界面
- 实时数据推送
- 数据可视化
- 用户交互

**支撑功能**：
- F5 Web管理界面
- F6 关系图谱可视化（前端部分）
- F7 数据服务管理界面
- 实时监控大屏

#### 3.2.6 T-L6 自动化与规则响应层

**核心组件**：
- Perseo-FE：规则引擎前端
- Perseo-Core：复杂事件处理引擎

**主要职责**：
- 复杂事件检测（CEP）
- 业务规则管理
- 自动响应执行
- 告警通知

**支撑功能**：
- F12 规则引擎管理
- 异常检测和预警
- 自动化工作流

**规则引擎架构**：
```
事件流 → Perseo-Core → 规则匹配 → 动作执行
              ↓            ↓           ↓
         事件聚合     条件判断    通知/控制
```

### 3.3 功能与架构层映射矩阵

| 功能ID | 功能名称 | L1-感知 | L2-上下文 | L3-数据 | L4-安全 | L5-可视化 | L6-自动化 |
|--------|----------|---------|-----------|---------|---------|-----------|-----------|
| F1 | 实体管理 | - | ✓核心 | ✓Draco | ✓认证 | ✓界面 | - |
| F2 | 元模型管理 | - | ✓Schema | ✓存储 | ✓权限 | ✓可视化 | - |
| F3 | 语义锚定 | ✓IoT Agent | ✓映射 | - | - | - | ✓规则 |
| F4 | 订阅通知 | - | ✓核心 | - | ✓Token | ✓WebSocket | ✓CEP |
| F5 | Web界面 | - | - | - | ✓认证 | ✓核心 | - |
| F6 | 关系图谱 | - | ✓查询 | ✓Neo4j | ✓权限 | ✓D3.js | - |
| F7 | 服务监控 | - | ✓状态 | ✓统计 | - | ✓Dashboard | - |
| F8 | 历史查询 | - | - | ✓核心 | ✓权限 | ✓图表 | - |
| F9 | 质量监控 | - | ✓验证 | ✓分析 | - | ✓报告 | ✓规则 |
| F10 | 批量操作 | ✓批量接入 | ✓批处理 | ✓导入 | ✓权限 | ✓进度 | - |
| F11 | 文件管理 | - | ✓元数据 | ✓MinIO | ✓权限 | ✓预览 | - |
| F12 | 规则引擎 | - | ✓事件 | ✓日志 | ✓权限 | ✓配置 | ✓核心 |
| F13 | 安全认证 | - | - | ✓用户 | ✓核心 | ✓登录 | - |

---

## 4. 前后端分离架构 ⭐⭐

### 4.1 架构设计原则

**核心原则**：
- **前后端完全分离**：前端和后端独立部署、独立开发、独立测试
- **API优先设计**：先定义API契约，前后端基于契约并行开发
- **前端优先体验**：优先开发前端界面，快速验证用户体验
- **Mock驱动开发**：前端基于Mock数据开发，后端逐步替换真实服务

### 4.2 技术架构

```
┌─────────────────────────────────────────────────────────┐
│                      前端架构                           │
├─────────────────────────────────────────────────────────┤
│   React SPA → Mock Service → API契约 → Production API   │
│       ↓           ↓            ↓             ↓         │
│   开发模式    独立Mock      标准接口    生产模式        │
└─────────────────────────────────────────────────────────┘

┌─────────────────────────────────────────────────────────┐
│                      后端架构                           │
├─────────────────────────────────────────────────────────┤
│   API Gateway → 认证授权 → 业务API → Fiware六层服务     │
│       ↓           ↓          ↓            ↓            │
│   统一入口    JWT/RBAC   RESTful    NGSI-LD/Draco      │
└─────────────────────────────────────────────────────────┘
```

### 4.3 API契约规范

**契约定义方式**：
```yaml
# api-contracts/entity-management.yaml
openapi: 3.0.0
info:
  title: 实体管理API
  version: 1.0.0
paths:
  /api/v1/entities/{entityType}:
    get:
      summary: 查询实体列表
      parameters:
        - name: entityType
          in: path
          required: true
          schema:
            type: string
            enum: [TwinObject, MBOM, Scene, Modality, ModalityBinding, ModalData, Role, Assignment]
        - name: limit
          in: query
          schema:
            type: integer
            default: 20
        - name: offset
          in: query
          schema:
            type: integer
            default: 0
      responses:
        200:
          description: 成功
          content:
            application/json:
              schema:
                type: object
                properties:
                  data:
                    type: array
                    items:
                      $ref: '#/components/schemas/Entity'
                  total:
                    type: integer
                  page:
                    type: object
```

### 4.4 Mock Service设计

**前端Mock服务架构**：
```javascript
// frontend/mock-server/server.js
const express = require('express');
const WebSocket = require('ws');

class MockServer {
  constructor() {
    this.app = express();
    this.setupRoutes();
    this.setupWebSocket();
  }

  setupRoutes() {
    // 实体管理Mock
    this.app.get('/api/v1/entities/:type', (req, res) => {
      const mockData = this.generateMockEntities(req.params.type);
      res.json({
        data: mockData,
        total: mockData.length,
        page: { limit: 20, offset: 0 }
      });
    });

    // 订阅Mock
    this.app.post('/api/v1/subscriptions', (req, res) => {
      res.json({
        id: 'sub-' + Date.now(),
        status: 'active'
      });
    });
  }

  setupWebSocket() {
    this.wss = new WebSocket.Server({ port: 8081 });
    
    this.wss.on('connection', (ws) => {
      // 模拟实时数据推送
      const interval = setInterval(() => {
        ws.send(JSON.stringify({
          type: 'notification',
          data: this.generateRealtimeData()
        }));
      }, 2000);

      ws.on('close', () => clearInterval(interval));
    });
  }

  generateMockEntities(type) {
    // 根据契约生成符合规范的Mock数据
    return require(`./mock-data/${type}.json`);
  }
}
```

### 4.5 前后端对接策略

**环境配置管理**：
```javascript
// frontend/.env.development
REACT_APP_API_BASE=http://localhost:3001/api/v1
REACT_APP_WS_URL=ws://localhost:3001/ws
REACT_APP_USE_MOCK=true

// frontend/.env.production
REACT_APP_API_BASE=https://api.platform.com/api/v1
REACT_APP_WS_URL=wss://api.platform.com/ws
REACT_APP_USE_MOCK=false
```

**API客户端封装**：
```typescript
// frontend/src/services/api-client.ts
class ApiClient {
  private baseURL: string;
  private useMock: boolean;

  constructor() {
    this.baseURL = process.env.REACT_APP_API_BASE!;
    this.useMock = process.env.REACT_APP_USE_MOCK === 'true';
  }

  async request<T>(config: RequestConfig): Promise<T> {
    if (this.useMock && mockHandlers[config.url]) {
      // 使用Mock数据
      return mockHandlers[config.url](config);
    }
    
    // 真实API请求
    const response = await fetch(this.baseURL + config.url, {
      ...config,
      headers: {
        'Content-Type': 'application/json',
        'Authorization': `Bearer ${this.getToken()}`,
        ...config.headers
      }
    });

    if (!response.ok) {
      throw new ApiError(response.status, await response.text());
    }

    return response.json();
  }
}
```

### 4.6 契约测试保障

**自动化契约验证**：
```javascript
// tests/contract-tests.js
describe('API Contract Tests', () => {
  let mockServer;
  let realServer;

  beforeAll(() => {
    mockServer = new MockServer();
    realServer = process.env.API_URL;
  });

  test('Entity API contract', async () => {
    const mockResponse = await fetch(`${mockServer}/api/v1/entities/TwinObject`);
    const realResponse = await fetch(`${realServer}/api/v1/entities/TwinObject`);
    
    const mockJson = await mockResponse.json();
    const realJson = await realResponse.json();
    
    // 验证结构一致性
    expect(Object.keys(mockJson)).toEqual(Object.keys(realJson));
    expect(mockJson.data[0]).toMatchSchema(entitySchema);
    expect(realJson.data[0]).toMatchSchema(entitySchema);
  });
});
```

---

## 5. 功能需求 ⭐⭐

### 5.1 功能列表

| 功能ID | 功能名称 | 输入 | 输出 | 优先级 | 主要架构层 |
|-------|---------|------|------|--------|----------|
| F1 | 实体管理功能 | 8类实体数据 | CRUD操作结果 | P0 | L2-上下文管理 |
| F2 | 元模型管理 | JSON Schema文件 | 模型导入和展示 | P0 | L2-上下文管理 |
| F3 | 语义锚定服务 | IoT原始数据 | 语义化实体数据 | P0 | L1-感知接入 |
| F4 | 订阅通知机制 | 订阅条件 | 变更通知推送 | P0 | L2-上下文管理 |
| F5 | Web管理界面 | 用户操作 | 可视化界面 | P0 | L5-可视化 |
| F6 | 关系图谱管理 | 实体关系数据 | 图形化展示 | P0 | L3-数据分析 |
| F7 | 数据服务管理 | API配置 | 接口监控统计 | P1 | L5-可视化 |
| F8 | 历史数据查询 | 查询条件 | 时序数据结果 | P1 | L3-数据分析 |
| F9 | 数据质量监控 | 实体数据 | 质量报告 | P2 | L3-数据分析 |
| F10 | 批量导入导出 | Excel/JSON文件 | 批量操作结果 | P2 | L2-上下文管理 |
| F11 | 非结构化数据管理 | 文件/图片/视频 | 存储URL和元数据 | P0 | L3-数据分析 |
| F12 | 规则引擎管理 | 规则配置 | 自动化响应 | P1 | L6-自动化 |
| F13 | 安全认证管理 | 用户凭证 | 访问令牌 | P0 | L4-安全控制 |

### 5.2 功能详细说明

#### F1: 实体管理功能

**功能描述**：
为8类核心实体提供完整的增删改查功能，支持复杂查询、批量操作和关系管理。

**涉及组件**：
- 【主要层级】：L2-上下文管理层
- 【核心组件】：Scorpio Broker
- 【数据持久化】：通过Draco写入L3层各数据库

**详细功能逻辑**：

##### 1.1 TwinObject实体管理

```
数据流程：
前端界面 → API Gateway → 业务API → Scorpio Broker → Draco → 数据库
    ↑                                      ↓
    └──────── WebSocket通知 ←──────────────┘

创建流程：
1. 前端提交实体数据
2. API层验证契约合规性
3. 调用Scorpio创建实体
4. Draco自动持久化到PostgreSQL
5. 返回创建成功的实体

查询流程：
1. 前端发起查询请求
2. API层构建NGSI-LD查询
3. Scorpio执行查询
4. 返回符合条件的实体集合
```

**11种子类型特殊处理**（详细逻辑见V1.0）

##### 1.2 MBOM实体管理

**链式关系维护**：
```
工序链管理：
Process1 → Process2 → Process3
    ↓         ↓         ↓
  Route1    Route2    Route3
    ↓         ↓         ↓
  Step1     Step2     Step3
    ↓         ↓         ↓
  Takt1     Takt2     Takt3
```

##### 1.3-1.8 其他实体管理
（Scene、Modality、ModalityBinding、ModalData、Role、Assignment的详细逻辑见V1.0）

#### F2: 元模型管理

**功能描述**：
通过JSON Schema文件导入定义元模型，提供图形化界面展示模型结构和关系。

**涉及组件**：
- 【主要层级】：L2-上下文管理层 + L5-可视化层
- 【核心组件】：Schema存储（Scorpio）+ 前端可视化
- 【数据持久化】：Schema存储在PostgreSQL

**实现要点**：
- JSON Schema导入和版本管理
- 模型关系可视化（D3.js力导向图）
- 实例验证器自动生成
- 继承关系严格验证

#### F3: 语义锚定服务

**功能描述**：
将IoT Agent接收的原始设备数据自动映射到语义化的实体结构，实现数据的三元锚定。

**涉及组件**：
- 【主要层级】：L1-感知接入层 + L2-上下文管理层
- 【核心组件】：IoT Agents + 语义映射规则引擎
- 【规则存储】：Perseo规则引擎（L6层）

**语义锚定流程**：
```
设备数据 → IoT Agent → 协议转换 → 语义映射 → Scorpio更新
                           ↓
                    规则引擎匹配
                           ↓
                    三元锚定：
                    - 设备 → TwinObject
                    - 上下文 → Scene  
                    - 数据 → Modality
                           ↓
                    创建ModalData实例
```

#### F4: 订阅通知机制

**功能描述**：
基于NGSI-LD订阅规范，实现实体变更的条件订阅和主动通知推送。

**涉及组件**：
- 【主要层级】：L2-上下文管理层 + L6-自动化层
- 【核心组件】：Scorpio订阅管理 + Perseo-CEP
- 【通知方式】：HTTP回调 + WebSocket推送

**订阅处理流程**：
```
订阅创建 → Scorpio注册 → 实体变更 → 条件匹配
                              ↓
                        Perseo复杂事件检测
                              ↓
                    通知推送（HTTP/WebSocket）
```

#### F5: Web管理界面

**功能描述**：
提供直观的Web界面用于管理平台的所有功能。

**涉及组件**：
- 【主要层级】：L5-可视化层
- 【核心技术】：React 18 + Ant Design + D3.js
- 【通信方式】：REST API + WebSocket

**界面模块**：
1. **实体管理中心**（8类实体独立页面）
2. **数据统计仪表板**（ECharts图表）
3. **关系图谱可视化**（D3.js力导向图）
4. **系统配置管理**（规则配置、用户管理）

#### F6: 关系图谱管理

**功能描述**：
基于Neo4j图数据库，提供实体关系的存储、查询和可视化功能。

**涉及组件**：
- 【主要层级】：L3-数据分析层 + L5-可视化层
- 【核心组件】：Neo4j + D3.js
- 【数据同步】：Draco → Neo4j实时同步

**图数据同步机制**：
```
Scorpio实体变更 → Draco捕获 → Neo4j更新
                      ↓
                分流处理器：
                - 实体 → Node
                - 关系 → Edge
                - 属性 → Properties
```

#### F7: 数据服务管理

**功能描述**：
管理和监控平台对外提供的所有数据服务接口。

**涉及组件**：
- 【主要层级】：L4-安全控制层 + L5-可视化层
- 【核心组件】：API Gateway + 监控面板
- 【统计存储】：TimescaleDB

#### F8: 历史数据查询

**功能描述**：
基于TimescaleDB提供高性能的时序数据存储和查询服务。

**涉及组件**：
- 【主要层级】：L3-数据分析层
- 【核心组件】：Draco + TimescaleDB
- 【查询优化】：时间分区、自动聚合

**Draco持久化配置**：
```xml
<!-- Draco NiFi处理器配置 -->
<processor>
  <type>NGSIToTimescaleDB</type>
  <config>
    <source>Scorpio Subscription</source>
    <target>TimescaleDB</target>
    <hypertable>modal_data_history</hypertable>
    <chunk_interval>7 days</chunk_interval>
  </config>
</processor>
```

#### F9: 数据质量监控

**功能描述**：
对平台中的数据进行质量评估，识别数据问题。

**涉及组件**：
- 【主要层级】：L3-数据分析层 + L6-自动化层
- 【核心组件】：数据质量引擎 + Perseo规则
- 【报告生成】：定时任务 + 报表服务

#### F10: 批量导入导出

**功能描述**：
支持大批量数据的导入导出操作。

**涉及组件**：
- 【主要层级】：L2-上下文管理层
- 【核心组件】：批量API + 异步任务队列
- 【文件处理】：Excel/CSV解析器

#### F11: 非结构化数据管理

**功能描述**：
管理与实体关联的非结构化数据（图片、视频、文档等）。

**涉及组件**：
- 【主要层级】：L3-数据分析层
- 【核心组件】：MinIO对象存储
- 【元数据管理】：Scorpio存储文件元数据实体

**文件处理流程**：
```
文件上传 → MinIO存储 → 生成URL → 创建元数据实体
                           ↓
                    关联到业务实体
                           ↓
                    Draco持久化元数据
```

#### F12: 规则引擎管理

**功能描述**：
基于Perseo提供复杂事件处理和业务规则管理。

**涉及组件**：
- 【主要层级】：L6-自动化层
- 【核心组件】：Perseo-FE + Perseo-Core
- 【规则存储】：MongoDB

**规则引擎架构**：
```
事件源（Scorpio） → Perseo-Core → 规则匹配
                        ↓
                  复杂事件检测：
                  - 时间窗口聚合
                  - 模式匹配
                  - 阈值检测
                        ↓
                  动作执行：
                  - 发送通知
                  - 调用API
                  - 更新实体
```

**规则配置示例**：
```json
{
  "name": "high_temperature_alert",
  "text": "SELECT *, 'HighTemp' as alertType FROM pattern [every a=iotEvent(type='AutoEquipment' and temperature>80)]",
  "action": {
    "type": "update",
    "parameters": {
      "entity": "${a.id}",
      "attributes": [{
        "name": "alert",
        "value": "high_temperature",
        "type": "Property"
      }]
    }
  }
}
```

#### F13: 安全认证管理

**功能描述**：
提供用户身份认证和访问控制功能。

**涉及组件**：
- 【主要层级】：L4-安全控制层
- 【核心组件】：JWT服务 + RBAC权限
- 【用户存储】：PostgreSQL

**认证流程**：
```
用户登录 → 验证凭证 → 生成JWT → 返回Token
    ↓
API请求 → Gateway验证Token → 检查权限 → 转发请求
```

---

## 6. 接口规范 ⭐

### 6.1 API分层设计

```
┌─────────────────────────────────────────────┐
│          前端应用 (React SPA)                │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│      API Gateway (统一入口 /api/v1)          │
├─────────────────────────────────────────────┤
│  业务API        │  NGSI-LD API   │ Admin API │
│  /entities     │  /ngsi-ld/v1   │ /admin    │
│  /files        │  标准接口       │ /config   │
│  /rules        │                │           │
└─────────────────────────────────────────────┘
                    ↓
┌─────────────────────────────────────────────┐
│          Fiware组件服务                      │
│  Scorpio | Draco | Perseo | IoT Agents      │
└─────────────────────────────────────────────┘
```

### 6.2 业务API接口

#### 实体管理API

```yaml
# 统一的实体管理接口（封装NGSI-LD复杂性）
GET /api/v1/entities/{entityType}
  Description: 查询实体列表
  Parameters:
    - entityType: 实体类型(8种)
    - q: 查询条件
    - limit/offset: 分页
  Response:
    {
      "success": true,
      "data": [...],
      "pagination": {...}
    }

POST /api/v1/entities/{entityType}
  Description: 创建实体
  Body: 实体数据（自动验证契约）
  
PUT /api/v1/entities/{entityType}/{id}
  Description: 更新实体
  
DELETE /api/v1/entities/{entityType}/{id}
  Description: 删除实体

POST /api/v1/entities/{entityType}/batch
  Description: 批量操作
  Body: {
    "operation": "create|update|delete",
    "entities": [...]
  }
```

#### 文件管理API

```yaml
POST /api/v1/files/upload
  Description: 文件上传
  Body: multipart/form-data
  Response:
    {
      "fileId": "file-xxx",
      "url": "https://minio/xxx",
      "metadata": {...}
    }

GET /api/v1/files/{fileId}
  Description: 获取文件信息

GET /api/v1/files/{fileId}/download
  Description: 下载文件

GET /api/v1/files/{fileId}/thumbnail?size=medium
  Description: 获取缩略图
```

#### 规则管理API

```yaml
GET /api/v1/rules
  Description: 获取规则列表

POST /api/v1/rules
  Description: 创建规则
  Body: {
    "name": "规则名称",
    "condition": "温度>80",
    "action": {...}
  }

PUT /api/v1/rules/{ruleId}
  Description: 更新规则

DELETE /api/v1/rules/{ruleId}
  Description: 删除规则

POST /api/v1/rules/{ruleId}/test
  Description: 测试规则
```

### 6.3 NGSI-LD标准接口

```yaml
# 直接暴露Scorpio的NGSI-LD接口供高级用户使用
Base Path: /ngsi-ld/v1

Entities:
  GET /entities
  POST /entities
  GET /entities/{entityId}
  PATCH /entities/{entityId}/attrs
  DELETE /entities/{entityId}

Subscriptions:
  GET /subscriptions
  POST /subscriptions
  GET /subscriptions/{subscriptionId}
  DELETE /subscriptions/{subscriptionId}

Temporal:
  GET /temporal/entities
  GET /temporal/entities/{entityId}
```

### 6.4 WebSocket接口

```javascript
// WebSocket连接协议
ws://platform/ws

// 消息格式
{
  "type": "subscribe|unsubscribe|notification|ping|pong",
  "topic": "entities.*.update",
  "data": {...}
}

// 订阅实体变更
→ {"type": "subscribe", "topic": "entities.TwinObject.*"}
← {"type": "subscribed", "subscriptionId": "ws-sub-001"}

// 接收实时通知
← {
  "type": "notification",
  "topic": "entities.TwinObject.update",
  "data": {
    "id": "urn:ngsi-ld:TwinObject:xxx",
    "temperature": 85.5,
    "timestamp": "2025-01-16T10:00:00Z"
  }
}
```

---

## 7. 技术栈要求 ⭐

### 7.1 必须使用的技术

```yaml
# 前端技术栈
框架: React 18+ 或 Vue 3+
构建工具: Vite 4+
UI库: Ant Design 5+ 或 Element Plus
图表: ECharts 5+ / D3.js 7+
状态管理: Redux Toolkit / Pinia
Mock服务: Express + Mock.js
测试: Jest + React Testing Library

# 后端技术栈
语言: Python 3.11+
框架: FastAPI 0.104+
验证: Pydantic 2.5+
异步: asyncio + aiohttp

# Fiware组件
Scorpio Broker: 4.1.0+
IoT Agents: 最新版本
Draco: 2.1.0+（基于Apache NiFi）
Perseo-FE: 1.27.0+
Perseo-Core: 1.13.0+

# 数据存储
PostgreSQL: 15+
TimescaleDB: 2.13+
Neo4j: 5.0+
Redis: 7.0+
MinIO: RELEASE.2023-12+
MongoDB: 6.0+（for Perseo）

# 容器化
Docker: 24.0+
Docker Compose: 2.20+
```

### 7.2 推荐的依赖库

**前端依赖**：
```json
{
  "dependencies": {
    "react": "^18.2.0",
    "react-router-dom": "^6.20.0",
    "antd": "^5.12.0",
    "axios": "^1.6.0",
    "echarts": "^5.4.0",
    "d3": "^7.8.0",
    "@reduxjs/toolkit": "^2.0.0",
    "socket.io-client": "^4.5.0"
  },
  "devDependencies": {
    "@vitejs/plugin-react": "^4.2.0",
    "vite": "^5.0.0",
    "express": "^4.18.0",
    "mockjs": "^1.1.0",
    "@testing-library/react": "^14.0.0",
    "jest": "^29.7.0"
  }
}
```

**后端依赖**：
```txt
# requirements.txt
fastapi==0.104.0
uvicorn[standard]==0.24.0
pydantic==2.5.0
sqlalchemy==2.0.0
asyncpg==0.29.0
neo4j==5.14.0
redis==5.0.0
minio==7.2.0
httpx==0.25.0
websockets==12.0
paho-mqtt==1.6.0
pandas==2.1.0
pyjwt==2.8.0
passlib[bcrypt]==1.7.4
python-multipart==0.0.6
```

---

## 8. 开发任务拆解 ⭐⭐

### 8.1 Phase划分（前端优先策略）

开发分为7个阶段，总工时约400-480小时：

```
Phase 0: API契约设计 - 16h（前后端共同参与）
Phase 1: 前端Mock开发 - 80h（前端先行）
Phase 2: 后端基础架构 - 60h（与前端并行）
Phase 3: Fiware组件集成 - 80h
Phase 4: 业务功能实现 - 80h
Phase 5: 前后端联调 - 40h
Phase 6: 高级功能 - 60h
Phase 7: 测试与部署 - 40h
```

### 8.2 详细任务列表

#### Phase 0: API契约设计 (16h) - 前后端共同

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| T0.1 | 定义所有API接口 | OpenAPI规范文档 | 覆盖13个功能 | 8h |
| T0.2 | 设计数据模型 | JSON Schema | 符合契约要求 | 4h |
| T0.3 | 制定Mock数据模板 | Mock数据文件 | 数据符合契约 | 4h |

#### Phase 1: 前端Mock开发 (80h) - 前端先行

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| T1.1 | 搭建前端项目框架 | React项目结构 | 项目可运行 | 8h |
| T1.2 | 配置Mock服务 | Mock Server | Mock API可访问 | 8h |
| T1.3 | 开发布局框架 | 三栏布局组件 | 响应式布局 | 8h |
| T1.4 | 实体管理界面 | 8个实体页面 | CRUD功能完整 | 24h |
| T1.5 | 仪表板界面 | Dashboard | 图表展示正常 | 8h |
| T1.6 | 关系图谱界面 | 图谱可视化 | D3.js渲染流畅 | 12h |
| T1.7 | 文件管理界面 | 上传下载界面 | 文件操作正常 | 8h |
| T1.8 | 规则配置界面 | 规则管理页面 | 规则CRUD | 4h |

**重点**：此阶段前端完全基于Mock数据开发，可独立运行和演示。

#### Phase 2: 后端基础架构 (60h) - 与前端并行

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| T2.1 | 搭建FastAPI项目 | 项目结构 | API框架运行 | 8h |
| T2.2 | 配置Docker环境 | docker-compose | 容器化部署 | 10h |
| T2.3 | 数据库初始化 | 数据库Schema | 5个数据库就绪 | 12h |
| T2.4 | API Gateway配置 | 网关服务 | 路由转发正常 | 8h |
| T2.5 | JWT认证服务 | 认证模块 | Token生成验证 | 10h |
| T2.6 | 契约验证服务 | 验证中间件 | 契约检查准确 | 12h |

#### Phase 3: Fiware组件集成 (80h)

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| T3.1 | 部署Scorpio Broker | Scorpio服务 | NGSI-LD可用 | 16h |
| T3.2 | 配置IoT Agents | IoT接入层 | 多协议支持 | 16h |
| T3.3 | 部署Draco | Draco服务 | 数据持久化正常 | 16h |
| T3.4 | 配置Perseo | 规则引擎 | 规则执行正常 | 16h |
| T3.5 | 集成MinIO | 对象存储 | 文件存储可用 | 8h |
| T3.6 | 集成Neo4j | 图数据库 | 图查询正常 | 8h |

#### Phase 4: 业务功能实现 (80h)

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| T4.1 | 实体管理API | CRUD接口 | 8类实体完整 | 20h |
| T4.2 | 语义锚定服务 | 映射引擎 | 自动锚定准确 | 12h |
| T4.3 | 订阅通知实现 | 订阅服务 | 实时推送正常 | 12h |
| T4.4 | 历史数据查询 | 时序查询API | 查询性能达标 | 12h |
| T4.5 | 文件管理服务 | 文件API | 上传下载正常 | 8h |
| T4.6 | 规则引擎集成 | 规则API | 规则执行准确 | 8h |
| T4.7 | 批量操作实现 | 批量API | 1000条/批 | 8h |

#### Phase 5: 前后端联调 (40h)

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| T5.1 | API对接切换 | 配置更新 | Mock切换到真实API | 8h |
| T5.2 | WebSocket联调 | 实时通信 | 推送延迟<50ms | 8h |
| T5.3 | 认证集成 | 登录流程 | JWT认证正常 | 8h |
| T5.4 | 数据一致性验证 | 测试报告 | 契约100%符合 | 8h |
| T5.5 | 性能优化 | 优化方案 | 响应时间<2s | 8h |

#### Phase 6: 高级功能 (60h)

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| T6.1 | 数据质量监控 | 质量服务 | 报告生成正常 | 12h |
| T6.2 | 复杂事件处理 | CEP配置 | 事件检测准确 | 12h |
| T6.3 | 图谱分析功能 | 图算法 | 路径查询正常 | 12h |
| T6.4 | 数据导入导出 | 导入导出工具 | Excel支持 | 12h |
| T6.5 | API监控统计 | 监控面板 | 统计准确 | 12h |

#### Phase 7: 测试与部署 (40h)

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| T7.1 | 单元测试 | 测试用例 | 覆盖率>80% | 12h |
| T7.2 | 集成测试 | 测试报告 | 功能全通过 | 8h |
| T7.3 | 契约测试 | 契约验证 | Mock与API一致 | 8h |
| T7.4 | 部署脚本 | 自动化脚本 | 一键部署 | 8h |
| T7.5 | 文档完善 | 使用文档 | 文档完整 | 4h |

### 8.3 开发顺序说明

```
契约设计(T0) ──┬──→ 前端开发(T1) ──→ 前后端联调(T5)
               │                           ↑
               └──→ 后端架构(T2) ──→ Fiware(T3) ──→ 业务实现(T4)
                                                    
最后：高级功能(T6) ──→ 测试部署(T7)

关键点：
1. T0完成后，前后端可以并行开发
2. 前端基于Mock快速开发，2-3周可见成果
3. 后端按架构层次逐步实现
4. T5联调是关键节点，需要重点保障
```

---

## 9. 项目结构建议

### 9.1 整体项目结构

```
digital-twin-platform/
├── frontend/                   # 前端项目（独立部署）
│   ├── src/
│   │   ├── pages/            # 页面组件
│   │   │   ├── entities/     # 8类实体管理
│   │   │   ├── dashboard/    # 仪表板
│   │   │   ├── graph/        # 关系图谱
│   │   │   ├── files/        # 文件管理
│   │   │   ├── rules/        # 规则管理
│   │   │   └── settings/     # 系统设置
│   │   ├── components/       # 通用组件
│   │   ├── services/         # API服务
│   │   │   ├── api-client.ts
│   │   │   ├── mock-client.ts
│   │   │   └── websocket.ts
│   │   ├── stores/           # 状态管理
│   │   └── utils/           # 工具函数
│   ├── mock/                 # Mock服务
│   │   ├── server.js        # Mock服务器
│   │   ├── data/            # Mock数据
│   │   └── handlers/        # Mock处理器
│   ├── tests/               # 前端测试
│   ├── vite.config.ts
│   └── package.json
│
├── backend/                  # 后端项目
│   ├── app/
│   │   ├── api/
│   │   │   ├── v1/         # 业务API
│   │   │   │   ├── entities.py
│   │   │   │   ├── files.py
│   │   │   │   ├── rules.py
│   │   │   │   └── auth.py
│   │   │   └── ngsi/       # NGSI-LD转发
│   │   ├── core/           # 核心服务
│   │   │   ├── fiware/     # Fiware集成
│   │   │   │   ├── scorpio_client.py
│   │   │   │   ├── draco_config.py
│   │   │   │   ├── perseo_client.py
│   │   │   │   └── iot_agent.py
│   │   │   ├── security/   # 安全服务
│   │   │   └── contracts/  # 契约验证
│   │   ├── models/         # 数据模型
│   │   └── services/       # 业务服务
│   ├── tests/             # 后端测试
│   └── requirements.txt
│
├── fiware/                # Fiware组件配置
│   ├── scorpio/          # Scorpio配置
│   ├── draco/            # Draco NiFi流程
│   │   ├── flows/        # NiFi流程定义
│   │   └── processors/   # 自定义处理器
│   ├── perseo/           # Perseo规则
│   ├── iot-agents/       # IoT Agent配置
│   └── docker-compose.yml
│
├── contracts/             # 数据契约
│   ├── schemas/          # JSON Schema
│   └── examples/         # 示例数据
│
├── api-contracts/         # API契约
│   ├── openapi.yaml      # OpenAPI规范
│   └── postman/          # Postman集合
│
├── deployment/           # 部署配置
│   ├── docker/          # Docker配置
│   ├── k8s/             # K8s配置（可选）
│   └── scripts/         # 部署脚本
│
├── docs/                # 文档
│   ├── architecture.md  # 架构说明
│   ├── api.md          # API文档
│   └── deployment.md   # 部署指南
│
├── Makefile            # 构建脚本
└── README.md
```

### 9.2 关键配置文件

**前端环境配置**：
```javascript
// frontend/.env.development
VITE_API_BASE=http://localhost:3001/api/v1
VITE_WS_URL=ws://localhost:3001/ws
VITE_USE_MOCK=true

// frontend/.env.production  
VITE_API_BASE=https://api.platform.com/api/v1
VITE_WS_URL=wss://api.platform.com/ws
VITE_USE_MOCK=false
```

**后端环境配置**：
```python
# backend/.env
SCORPIO_URL=http://scorpio:9090
DRACO_URL=http://draco:8080/nifi
PERSEO_FE_URL=http://perseo-fe:9090
DATABASE_URL=postgresql://user:pass@postgres:5432/db
JWT_SECRET=your-secret-key
```

**Docker Compose配置**：
```yaml
# fiware/docker-compose.yml
version: '3.8'
services:
  # L2层：上下文管理
  scorpio:
    image: scorpio/broker:4.1.0
    environment:
      - POSTGRES_HOST=postgres
    ports:
      - "9090:9090"
      
  # L3层：数据持久化
  draco:
    image: ging/fiware-draco:2.1.0
    ports:
      - "8080:8080"
      - "5050:5050"
    volumes:
      - ./draco/flows:/opt/nifi/conf/flow
      
  # L6层：规则引擎
  perseo-core:
    image: telefonicaiot/perseo-core:1.13.0
    
  perseo-fe:
    image: telefonicaiot/perseo-fe:1.27.0
    environment:
      - PERSEO_CORE_URL=http://perseo-core:8080
      
  # 数据库服务
  postgres:
    image: postgres:15
    
  timescaledb:
    image: timescale/timescaledb:2.13.0-pg15
    
  neo4j:
    image: neo4j:5.0
    
  redis:
    image: redis:7.0
    
  minio:
    image: minio/minio:latest
    
  mongodb:
    image: mongo:6.0
```

---

## 10. 测试要求 ⭐

### 10.1 测试策略

| 测试类型 | 覆盖率目标 | 测试重点 | 测试工具 |
|---------|-----------|---------|----------|
| 单元测试 | > 80% | 业务逻辑、契约验证 | Jest/Pytest |
| 集成测试 | > 70% | API接口、组件集成 | Supertest |
| 契约测试 | 100% | Mock与API一致性 | Pact |
| E2E测试 | 核心流程 | 用户操作流程 | Cypress |
| 性能测试 | 全接口 | 响应时间、并发 | JMeter |

### 10.2 契约测试（重点）

**前后端契约一致性测试**：
```javascript
// tests/contract-tests.spec.js
describe('API Contract Compliance', () => {
  const mockAPI = new MockServer();
  const realAPI = process.env.REAL_API_URL;

  test('Entity API contract', async () => {
    // 测试相同请求
    const request = {
      method: 'GET',
      path: '/api/v1/entities/TwinObject',
      query: { limit: 10 }
    };

    // 获取Mock响应
    const mockResponse = await mockAPI.request(request);
    
    // 获取真实响应
    const realResponse = await fetch(realAPI + request.path);
    
    // 验证结构一致性
    expect(mockResponse.structure).toEqual(realResponse.structure);
    
    // 验证数据契约
    expect(mockResponse.data[0]).toMatchContract(TwinObjectContract);
    expect(realResponse.data[0]).toMatchContract(TwinObjectContract);
  });
});
```

### 10.3 性能测试要求

| 指标 | 目标值 | 测试场景 |
|-----|-------|---------|
| API响应时间 | < 2秒 | 单实体查询 |
| 批量查询 | < 5秒 | 1000条数据 |
| 实时推送 | < 50ms | WebSocket通知 |
| 并发用户 | 200 | 混合场景 |
| 文件上传 | > 10MB/s | 100MB文件 |

### 10.4 测试数据准备

```python
# tests/fixtures/test_data_generator.py
class TestDataGenerator:
    """生成符合契约的测试数据"""
    
    @staticmethod
    def generate_twin_object(subtype="Station"):
        return {
            "id": f"urn:ngsi-ld:TwinObject:test-{uuid4()}",
            "type": "TwinObject",
            "subType": {"value": subtype},
            "name": {"value": f"Test {subtype}"},
            # ... 符合契约的完整数据
        }
    
    @staticmethod
    def generate_scene(status="active"):
        return {
            "id": f"urn:ngsi-ld:Scene:test-{uuid4()}",
            "type": "Scene",
            "status": {"value": status},
            "workpieceId": {"object": "urn:ngsi-ld:Workpiece:test"},
            # ... 符合契约的完整数据
        }
```

---

## 11. 部署要求

### 11.1 容器化部署架构

```yaml
# 生产环境部署架构
services:
  # 前端服务（独立部署）
  frontend:
    image: platform/frontend:v2.0.0
    ports:
      - "80:80"
    environment:
      - API_URL=https://api.platform.com
      
  # API网关
  api-gateway:
    image: kong:3.4
    ports:
      - "443:443"
    configs:
      - source: kong-config
        target: /etc/kong/kong.conf
        
  # 后端服务
  backend:
    image: platform/backend:v2.0.0
    replicas: 3  # 高可用
    environment:
      - SCORPIO_URL=http://scorpio:9090
      
  # Fiware组件（按六层架构部署）
  # L1: IoT Agents
  iot-agent-json:
    image: fiware/iotagent-json:latest
    
  # L2: Scorpio
  scorpio:
    image: scorpio/broker:4.1.0
    
  # L3: Draco + 数据库
  draco:
    image: ging/fiware-draco:2.1.0
    
  # L6: Perseo
  perseo-fe:
    image: telefonicaiot/perseo-fe:1.27.0
```

### 11.2 部署流程

```bash
# 使用Makefile简化部署
make build          # 构建镜像
make test           # 运行测试
make deploy-dev     # 部署开发环境
make deploy-prod    # 部署生产环境
```

### 11.3 监控与运维

**监控指标**：
- 服务健康状态（/health接口）
- API响应时间（P50/P90/P99）
- 错误率和告警
- 资源使用率（CPU/内存/磁盘）

**日志管理**：
- 结构化日志（JSON格式）
- 集中日志收集（ELK Stack可选）
- 日志级别控制（开发DEBUG，生产INFO）

---

## 12. 文档交付要求

### 12.1 必须提供的文档

- [ ] **README.md** - 项目快速开始指南
- [ ] **ARCHITECTURE.md** - 六层架构详细说明
- [ ] **API.md** - 完整API文档（自动生成）
- [ ] **CONTRACTS.md** - 契约遵从说明
- [ ] **DEPLOYMENT.md** - 部署配置指南
- [ ] **USER_MANUAL.md** - 用户使用手册
- [ ] **DEVELOPMENT.md** - 开发指南

### 12.2 README.md示例

```markdown
# 数字孪生管理平台 V2.0

基于Fiware六层架构的工业数字孪生平台

## 特性
- ✅ Fiware六层架构（L1-L6完整实现）
- ✅ 8类实体管理（严格契约验证）
- ✅ 前后端分离架构
- ✅ Draco数据持久化
- ✅ Perseo规则引擎
- ✅ 实时数据推送

## 快速开始

### 前端开发（Mock模式）
```bash
cd frontend
npm install
npm run mock  # 启动Mock服务
npm run dev   # 启动前端
```

### 完整部署
```bash
make install   # 安装依赖
make build     # 构建镜像  
make up        # 启动所有服务
```

### 访问地址
- 前端界面: http://localhost:3000
- API文档: http://localhost:8000/docs
- Scorpio: http://localhost:9090
- Draco NiFi: http://localhost:8080/nifi

## 架构说明
本平台采用Fiware标准六层架构：
- L1: IoT Agent（多协议接入）
- L2: Scorpio Broker（上下文管理）
- L3: Draco + Databases（数据持久化）
- L4: Security（认证授权）
- L5: Web UI（可视化）
- L6: Perseo（规则引擎）

## API使用
```javascript
// 查询实体
GET /api/v1/entities/TwinObject?limit=10

// 创建实体（自动契约验证）
POST /api/v1/entities/TwinObject
{
  "name": "焊接工位-01",
  "subType": "Station",
  ...
}

// 订阅变更
POST /api/v1/subscriptions
{
  "entityType": "AutoEquipment",
  "condition": "temperature>80"
}
```

## 开发指南
- 前端基于React 18 + Ant Design
- 后端基于FastAPI + Fiware
- 严格遵守9个数据契约
- API优先，前后端并行开发

## 测试
```bash
npm run test:unit     # 单元测试
npm run test:contract # 契约测试
npm run test:e2e      # 端到端测试
```

## License
MIT
```

---

## 13. 最终验收标准 ⭐

### 13.1 架构验收

- [ ] Fiware六层架构完整实现
- [ ] Scorpio Broker正常运行
- [ ] Draco数据持久化配置正确
- [ ] Perseo规则引擎可用
- [ ] IoT Agent多协议支持
- [ ] 前后端完全分离部署

### 13.2 功能验收

- [ ] 8类实体CRUD功能完整
- [ ] 13个功能模块全部实现
- [ ] 契约验证100%准确
- [ ] 实时推送延迟<50ms
- [ ] 文件管理功能正常
- [ ] 规则引擎执行准确

### 13.3 质量验收

- [ ] 前端可独立运行（Mock模式）
- [ ] API契约测试通过
- [ ] 单元测试覆盖率>80%
- [ ] 性能指标达标
- [ ] 并发200用户稳定

### 13.4 交付验收

- [ ] Docker镜像构建成功
- [ ] 一键部署脚本可用
- [ ] 文档完整准确
- [ ] 源代码规范
- [ ] 演示环境可用

---

## 给 Claude Code 的开发指引

### 理解优先级

1. **先理解架构**：
   - Fiware六层架构是基础
   - 每层的职责必须清晰
   - 组件间的数据流向要明确

2. **再理解功能**：
   - 13个功能的业务需求
   - 功能与架构层的映射关系
   - 前端界面与后端API的对应

3. **严格遵守契约**：
   - 9个数据契约是红线
   - 所有数据必须验证
   - URN格式必须正确

### 开发建议

1. **前端优先策略**：
   ```
   Week 1: Mock开发，快速出界面
   Week 2-3: 完善交互，优化体验
   Week 4+: 对接真实API
   ```

2. **后端分层实现**：
   ```
   Step 1: 搭建Fiware组件（L1-L2-L3）
   Step 2: 实现业务API（封装复杂性）
   Step 3: 集成高级功能（L4-L6）
   ```

3. **数据流重点**：
   ```
   IoT Agent → Scorpio → Draco → Databases
                ↓
           Subscription → Apps
   ```

4. **Draco配置要点**：
   - 使用NiFi流程编排数据管道
   - 配置多目标输出（TimescaleDB/Neo4j/MinIO）
   - 确保数据不丢失

5. **Perseo规则引擎**：
   - EPL语法编写规则
   - 复杂事件窗口设置
   - 动作执行要幂等

### 常见问题预防

| 问题 | 预防措施 |
|-----|---------|
| Mock与API不一致 | 使用契约测试自动验证 |
| Fiware组件集成复杂 | 使用官方Docker镜像 |
| 数据丢失 | Draco配置持久化队列 |
| 性能瓶颈 | 合理使用缓存和索引 |

### 关键决策

**你可以自主决定**：
- ✅ 前端组件库选择（Ant Design或其他）
- ✅ 具体的代码组织结构
- ✅ 缓存策略
- ✅ 测试框架选择

**你必须遵守**：
- ⚠️ Fiware六层架构
- ⚠️ 使用Draco而非Cygnus
- ⚠️ 前后端分离架构
- ⚠️ 9个契约的所有约束
- ⚠️ API契约规范

### 成功标准

1. **第一周**：前端Mock界面可演示
2. **第二周**：Fiware组件运行正常
3. **第三周**：核心功能API完成
4. **第四周**：前后端联调成功
5. **第五周**：高级功能实现
6. **第六周**：测试部署完成

---

**祝开发顺利！** 🚀

---

**文档版本**: v2.0.0  
**最后更新**: 2025-01-16  
**状态**: 正式发布

## 修订记录

| 版本 | 日期 | 修订内容 | 修订人 |
|-----|------|---------|--------|
| v1.0.0 | 2025-01-15 | 初始版本 | - |
| v2.0.0 | 2025-01-16 | 增加Fiware六层架构；前后端分离；Draco集成；Perseo规则引擎 | - |

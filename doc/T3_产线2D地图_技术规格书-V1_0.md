# T3-产线2D地图 - 技术规格书

**面向 Claude Code 开发**

**版本**: v1.0.0  
**日期**: 2025-11-12  
**任务编号**: T3

---

## 📋 文档说明

本技术规格书是提交给 **Claude Code** 的开发任务书,用于指导产线2D地图系统的完整开发。

**本文档的定位**:
- ✅ 定义产线2D地图的完整功能边界和技术架构
- ✅ 明确OpenLayers地图引擎的集成方案
- ✅ 规定必须遵守的NGSI-LD数据契约
- ✅ 提供4个Phase的开发路线图和验收标准
- ✅ 说明与数字孪生管理平台和Mockserver的接口关系
- ❌ 不涉及3D可视化功能
- ❌ 不规定具体的代码实现细节

**产品定位**:  
**产线2D地图是侧墙产线数字孪生系统的核心主入口页面**,承载全局生产态势监控、实时追踪、历史回放、路径分析等完整功能,为生产管理人员提供直观的空间可视化决策支持。

---

## 1. 任务定位 ⭐

### 1.1 功能边界

**本任务要实现的功能**:

#### 核心功能模块 (P0级)
- ✅ **产线地图渲染**: 基于矢量数据的产线布局可视化,支持自定义车间坐标系
- ✅ **实时状态监控**: 设备(~30台)、在制品(最多40个)、人员(~20人)的实时位置和状态展示
- ✅ **KPI指标展示**: 6大核心指标实时显示(Flow产量、PLT信息率、WIP在制数、Quality FPY、Cost OEE、Flexibility OTD)
- ✅ **要素交互选择**: 点击地图要素显示详情弹窗,支持多层级信息查看
- ✅ **多图层管理**: 底图层、设备层、在制品层、人员层的独立控制
- ✅ **数据筛选查询**: 按类型、状态、区域、属性进行快速筛选

#### 高级功能模块 (P0级)
- ✅ **专属视图过滤**: 
  - Flow流动问题视图(物流瓶颈点过滤)
  - Quality质量问题视图(质量异常设备过滤)
  - Efficiency效率问题视图(低效率工位过滤)
  - Spaghetti图(物料流转路径综合展示)
- ✅ **历史轨迹回放**: 基于时间轴的设备/在制品/人员历史轨迹回放,支持播放/暂停/快进控制
- ✅ **路径优化分析**: 物料流转路径可视化、瓶颈识别、OEE分析
- ✅ **动画效果**: 基于postrender和requestAnimationFrame的流畅轨迹动画

#### 扩展功能模块 (P1级)
- ✅ **地图标注与编辑**: 支持用户在地图上绘制标注(点/线/面)、拖拽编辑要素
- ✅ **热力图分析**: 人员密度、物料堆积、设备报警频次的热力图展示
- ✅ **数据图表联动**: 地图与ECharts图表的双向联动
- ✅ **导出功能**: 地图截图导出、数据报表导出

**明确不实现的功能**:
- ❌ **3D视角切换**: 不实现三维可视化(原因: 当前阶段聚焦2D地图)
- ❌ **业务应用嵌入**: 不嵌入业务优化应用的可视化结果(原因: 当前阶段独立开发)
- ❌ **直接设备控制**: 不提供设备控制指令下发(原因: 属于控制系统职责)
- ❌ **实体数据修改**: 不修改数字孪生平台的实体数据(原因: 只读访问)
- ❌ **生产计划编排**: 不执行生产计划编制(原因: 属于T1管理平台职责)

### 1.2 与其他任务的关系

| 任务 | 关系类型 | 接口方式 | 数据流向 | 说明 |
|-----|---------|---------|---------|------|
| T1:数字孪生管理平台 | 生产依赖 | NGSI-LD API | 单向读取 | 实际部署环境的数据源 |
| T2:Mockserver | 开发依赖 | NGSI-LD API | 单向读取 | 开发测试环境的数据源 |
| T4:业务优化智能应用 | 未来集成 | Plugin API | 双向(后续) | 当前阶段独立开发,后续集成 |
| T5:生产仿真分析 | 可选协作 | REST API | 双向(可选) | 可对比仿真与实际数据 |

**关键说明**:
- **开发阶段**: 前端使用本地Mock数据,后端使用T2 Mockserver提供的NGSI-LD接口
- **测试阶段**: 完全使用T2 Mockserver提供的完整数据集
- **生产环境**: 切换到T1管理平台的NGSI-LD接口
- **接口协议**: 严格遵循NGSI-LD标准,确保数据源切换无缝

### 1.3 系统边界

```
┌─────────────────────────────────────────────────────┐
│         产线2D地图系统 (T3)                          │
│                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │
│  │  地图渲染   │  │  实时监控   │  │ 历史回放   │ │
│  │  模块       │  │  模块       │  │ 模块       │ │
│  └─────────────┘  └─────────────┘  └────────────┘ │
│                                                     │
│  ┌─────────────┐  ┌─────────────┐  ┌────────────┐ │
│  │  路径分析   │  │  专属视图   │  │ 数据查询   │ │
│  │  模块       │  │  模块       │  │ 模块       │ │
│  └─────────────┘  └─────────────┘  └────────────┘ │
│                                                     │
│  ┌──────────────────────────────────────────────┐ │
│  │     NGSI-LD 数据访问层                        │ │
│  └──────────────────────────────────────────────┘ │
└────────────────┬────────────────────────┬──────────┘
                 │                        │
         ┌───────┴──────┐        ┌───────┴──────┐
         │  T1管理平台  │        │  T2Mockserver│
         │  (生产环境)  │        │  (开发环境)  │
         └──────────────┘        └──────────────┘
```

---

## 2. 数据契约约束 ⭐

### 2.1 使用的实体契约

产线2D地图必须严格遵守以下数据契约,**不定义独立的地图数据契约**:

| 契约文件 | 使用方式 | 核心约束 | 用途说明 |
|---------|---------|---------|---------|
| 00_总契约.md | 全局规范 | URN格式、时间格式、@context规范 | 所有数据访问的基础规范 |
| 01_TwinObject契约.md | 只读 | 11种子类型(Station/Robot/AGV/Person/Workpiece等) | 地图要素的主要数据源 |
| 02_MBOM契约.md | 只读 | 4层工艺结构、工序链关系 | 工序位置定位、工艺路径展示 |
| 03_Scene契约.md | 只读 | 场景层级、timeFrame、status | 执行过程追踪、历史回放数据源 |
| 04_Modality契约.md | 只读 | 数据模态定义、allowedRange、单位 | KPI指标定义参考 |
| 05_ModalityBinding契约.md | 只读 | 模态与实体的绑定关系 | 确定要素可展示的数据项 |
| 06_ModalData契约.md | 只读 | 实时数据、qualityTag、observedAt | 实时状态数据源 |
| 07_Role契约.md | 只读 | 角色定义 | 人员信息展示 |
| 08_Assignment契约.md | 只读 | 岗位指派 | 责任追溯 |

### 2.2 契约遵从要求

**必须遵守的规范**:
- ✅ **URN格式**: 所有实体引用必须使用标准URN格式: `urn:ngsi-ld:{EntityType}:{UniqueID}`
- ✅ **时间格式**: 所有时间戳必须是 ISO 8601 格式,带时区信息 (UTC或+08:00)
- ✅ **关系类型**: 处理Relationship类型属性时,从 `object` 字段获取目标URN
- ✅ **@context**: 查询返回的实体必须包含 @context 声明,解析时正确处理
- ✅ **只读访问**: 不允许通过任何接口修改、创建、删除数字孪生平台的实体数据
- ✅ **查询规范**: 使用标准NGSI-LD查询语法(q参数、timerel、georel等)

**地图特定的契约使用规则**:

1. **地图要素来源**:
   ```
   底图布局 → TwinObject (type=Zone, type=Station)
   设备     → TwinObject (type=Robot, type=CNCMachine, type=AutoEquipment)
   在制品   → TwinObject (type=Workpiece)
   人员     → TwinObject (type=Person) + Role + Assignment
   ```

2. **实时状态获取**:
   ```
   设备状态  → ModalData (refEntity指向设备TwinObject)
   在制品位置 → TwinObject.location + ModalData
   人员位置  → TwinObject.location (如果有定位标签)
   ```

3. **历史轨迹获取**:
   ```
   轨迹数据 → Scene (sceneLevel=Process) + ModalData (historical query)
   时间查询 → 使用 timerel=between&timeAt=...&endTimeAt=...
   ```

### 2.3 坐标系转换契约

**车间坐标系定义**:
```json
{
  "coordinateSystem": {
    "type": "Local2D",
    "epsgCode": "EPSG:10001",
    "origin": {
      "latitude": 30.0,
      "longitude": 120.0
    },
    "unit": "meter",
    "projection": "TransverseMercator"
  }
}
```

**坐标转换规则**:
- 后端返回的 `location` 字段格式: `{"type": "Point", "coordinates": [x, y]}`
- x, y 单位为米,相对于车间原点
- 前端必须使用 proj4.js 将车间坐标转换为 Web墨卡托 (EPSG:3857)
- 反向转换用于用户交互(如点击、绘制)获取的坐标

**验证要求**:
- 提供坐标转换工具函数
- 编写单元测试验证转换精度

---

## 3. 功能需求 ⭐

### 3.1 功能列表

| 功能ID | 功能名称 | 输入 | 输出 | 优先级 | 所属Phase |
|-------|---------|------|------|--------|----------|
| **F1** | 产线地图初始化与渲染 | 产线布局数据(GeoJSON) | 可交互的矢量地图 | P0 | Phase 1 |
| **F2** | 自定义坐标系转换 | 车间坐标(x,y)、Web坐标 | 转换后坐标 | P0 | Phase 1 |
| **F3** | 多图层管理 | 图层配置 | 图层显示/隐藏控制 | P0 | Phase 1 |
| **F4** | KPI指标展示 | 实时KPI数据 | 顶部指标栏 | P0 | Phase 1 |
| **F5** | 实时设备状态监控 | 设备实时数据(WebSocket) | 地图上设备动态渲染 | P0 | Phase 2 |
| **F6** | 实时在制品追踪 | 在制品位置数据(WebSocket) | 地图上在制品动态更新 | P0 | Phase 2 |
| **F7** | 实时人员位置追踪 | 人员位置数据(WebSocket) | 地图上人员动态显示 | P0 | Phase 2 |
| **F8** | 要素选择与详情弹窗 | 用户点击要素 | 详情信息弹窗 | P0 | Phase 2 |
| **F9** | 数据筛选与查询 | 筛选条件 | 过滤后的地图要素 | P0 | Phase 2 |
| **F10** | 历史轨迹查询 | 对象ID、时间范围 | 轨迹坐标序列 | P0 | Phase 3 |
| **F11** | 轨迹回放动画 | 轨迹数据、回放控制 | 平滑动画效果 | P0 | Phase 3 |
| **F12** | 时间轴控件 | 当前时间点 | 播放/暂停/进度控制 | P0 | Phase 3 |
| **F13** | Flow流动问题视图 | 物流数据 | 瓶颈点过滤显示 | P0 | Phase 4 |
| **F14** | Quality质量问题视图 | 质量数据 | 异常设备过滤显示 | P0 | Phase 4 |
| **F15** | Efficiency效率问题视图 | 效率数据 | 低效工位过滤显示 | P0 | Phase 4 |
| **F16** | Spaghetti图 | 物料流转历史 | 路径综合可视化 | P0 | Phase 4 |
| **F17** | 路径优化分析 | 物流路径数据 | 优化建议可视化 | P0 | Phase 4 |
| **F18** | 设备OEE分析 | 设备运行数据 | OEE热力图 | P1 | Phase 4 |
| **F19** | 热力图展示 | 密度数据 | MapV热力图 | P1 | Phase 4 |
| **F20** | 地图标注与编辑 | 用户绘制操作 | 新增地图要素 | P1 | Phase 4 |

### 3.2 功能详细说明

#### F1: 产线地图初始化与渲染

**功能描述**:  
使用OpenLayers加载车间矢量布局图,初始化地图视图,配置基础交互控件(缩放、平移),建立自定义车间坐标系。

**输入**:
- 产线布局数据: GeoJSON格式,包含工序区域(Zone)、工位(Station)、通道(Passage)、缓存区(Buffer)等要素
- 坐标系配置: 车间原点经纬度、单位、投影参数
- 地图配置: 初始中心点、缩放级别、可见范围

**输出**:
- OpenLayers地图实例,渲染在页面主区域
- 底图图层(布局矢量图)
- 基础控件(缩放控件、比例尺、鼠标位置显示)

**约束条件**:
- 布局数据必须包含完整的几何信息(Polygon、Point)
- 所有要素必须有唯一的 `id` 属性对应 TwinObject URN
- 样式定义清晰(墙体、工位、通道等不同颜色区分)

**验收标准**:
- [ ] 地图能正常渲染在页面中央区域
- [ ] 缩放、平移交互流畅(60fps)
- [ ] 底图要素样式正确(颜色、边框、标签)
- [ ] 坐标系转换精度验证通过(误差<1cm)
- [ ] 支持100个并发用户访问,地图渲染不卡顿

---

#### F2: 自定义坐标系转换

**功能描述**:  
实现车间局部坐标系与Web墨卡托坐标系之间的双向转换,确保地图要素位置精确。

**输入**:
- 车间坐标: `[x, y]` (单位:米,相对原点)
- Web墨卡托坐标: `[x, y]` (EPSG:3857)

**输出**:
- 转换后的坐标数组 `[x, y]`

**实现方案**:
```typescript
// 使用 proj4.js 定义车间坐标系
import proj4 from 'proj4';
import { register } from 'ol/proj/proj4';

proj4.defs("EPSG:10001", 
  "+proj=tmerc +lat_0=30.0 +lon_0=120.0 +k_0=1 +x_0=0 +y_0=0 +units=m +no_defs"
);
register(proj4);

// 转换函数
function transformWorkshopToMap(coord: [number, number]): [number, number] {
  return ol.proj.transform(coord, 'EPSG:10001', 'EPSG:3857');
}

function transformMapToWorkshop(coord: [number, number]): [number, number] {
  return ol.proj.transform(coord, 'EPSG:3857', 'EPSG:10001');
}
```

**验收标准**:
- [ ] 正向转换精度测试通过(100个测试点,误差<1cm)
- [ ] 反向转换精度测试通过(往返转换误差<0.1mm)
- [ ] 提供单元测试覆盖所有边界情况
- [ ] 转换性能满足要求(1000次转换<10ms)

---

#### F3: 多图层管理

**功能描述**:  
实现多个矢量图层的独立管理,支持用户动态控制每个图层的显示/隐藏。

**输入**:
- 图层配置列表: `[{id, name, visible, zIndex, data}]`
- 用户切换操作: `toggleLayer(layerId)`

**输出**:
- 图层切换控件(位于左侧面板)
- 图层状态实时更新

**图层定义**:
```typescript
const layers = {
  baseLayer: "底图图层",      // 车间布局
  equipmentLayer: "设备图层", // 30台设备
  wipLayer: "在制品图层",     // 40个在制品
  personnelLayer: "人员图层", // 20名人员
  pathLayer: "路径图层",      // 物流路径(Spaghetti)
  annotationLayer: "标注图层" // 用户标注
};
```

**验收标准**:
- [ ] 每个图层可独立显示/隐藏
- [ ] 图层顺序可配置(zIndex)
- [ ] 图层切换无闪烁,性能流畅
- [ ] 至少6个图层同时管理

---

#### F4: KPI指标展示

**功能描述**:  
在地图顶部展示6个核心生产KPI指标,数据实时更新(1-5分钟频率)。

**输入**:
- KPI数据源: ModalData (refModality指向对应的Modality定义)
- 更新频率: 1-5分钟

**输出**:
- 顶部KPI指标栏: 
  ```
  [Flow产量: 21/24] [PLT信息率: 73%] [WIP在制数: 105]
  [Quality FPY: 88.16%] [Cost OEE: 82.31%] [Flexibility OTD: 92.92%]
  ```

**数据契约映射**:
| KPI指标 | Modality URN | 单位 | 阈值(绿/黄/红) |
|---------|--------------|------|----------------|
| Flow产量 | `urn:ngsi-ld:Modality:Flow:DailyOutput` | 件/天 | >20/>15/>0 |
| PLT信息率 | `urn:ngsi-ld:Modality:PLT:InfoRate` | % | >80%/>60%/>0% |
| WIP在制数 | `urn:ngsi-ld:Modality:WIP:Count` | 个 | <30/<50/<∞ |
| Quality FPY | `urn:ngsi-ld:Modality:Quality:FirstPassYield` | % | >90%/>85%/>0% |
| Cost OEE | `urn:ngsi-ld:Modality:Cost:OEE` | % | >85%/>75%/>0% |
| Flexibility OTD | `urn:ngsi-ld:Modality:Flexibility:OnTimeDelivery` | % | >95%/>90%/>0% |

**验收标准**:
- [ ] 6个指标全部正确显示
- [ ] 数据更新频率符合要求(1-5分钟)
- [ ] 根据阈值显示不同颜色(绿/黄/红)
- [ ] 点击指标可查看详细趋势图(ECharts)

---

#### F5: 实时设备状态监控

**功能描述**:  
通过WebSocket接收设备实时状态数据,在地图上动态更新设备图标的颜色和样式,反映运行/停机/故障等状态。

**输入**:
- WebSocket消息: 
  ```json
  {
    "type": "equipmentStatus",
    "entityId": "urn:ngsi-ld:TwinObject:Robot:RBT-GZ-01",
    "status": "Running",  // Running/Idle/Fault/Maintenance
    "location": {"type": "Point", "coordinates": [10.5, 20.3]},
    "observedAt": "2025-11-12T10:30:00+08:00"
  }
  ```

**输出**:
- 地图上设备要素(Feature)实时更新:
  - 位置变化 → 调用 `feature.getGeometry().setCoordinates()`
  - 状态变化 → 调用 `feature.setStyle()` 更新图标颜色

**状态样式映射**:
```typescript
const equipmentStyles = {
  Running: { color: '#00ff00', icon: 'running.svg' },    // 绿色
  Idle: { color: '#ffff00', icon: 'idle.svg' },         // 黄色
  Fault: { color: '#ff0000', icon: 'fault.svg', blink: true }, // 红色闪烁
  Maintenance: { color: '#0000ff', icon: 'maintenance.svg' }   // 蓝色
};
```

**性能要求**:
- 30台设备同时更新,延迟<100ms
- WebSocket重连机制,支持断线自动重连(指数退避)
- 支持100个并发用户,每个用户独立WebSocket连接

**验收标准**:
- [ ] 设备状态变化在地图上实时反映(<100ms延迟)
- [ ] 故障设备有明显视觉警示(红色闪烁)
- [ ] WebSocket断线自动重连,不影响用户体验
- [ ] 压力测试:30台设备×每秒1次更新×100用户,系统稳定

---

#### F6: 实时在制品追踪

**功能描述**:  
实时追踪产线上在制品的位置和状态,支持最多40个在制品同时显示。

**输入**:
- WebSocket消息:
  ```json
  {
    "type": "workpieceUpdate",
    "entityId": "urn:ngsi-ld:TwinObject:Workpiece:M670-SN001",
    "location": {"type": "Point", "coordinates": [15.2, 8.7]},
    "currentProcess": "T01:P0010",
    "status": "InProcess",  // Pending/InProcess/Completed/Hold
    "queueTime": 180,  // 秒
    "observedAt": "2025-11-12T10:30:05+08:00"
  }
  ```

**输出**:
- 地图上在制品图标,显示:
  - 工件编号(M670-SN001)
  - 当前工序代码(P0010)
  - 等待时间(如果>5分钟,显示为警告色)

**样式规则**:
```typescript
const workpieceStyles = {
  Pending: { color: '#808080' },      // 灰色:待加工
  InProcess: { color: '#00ff00' },    // 绿色:加工中
  Completed: { color: '#0000ff' },    // 蓝色:已完成
  Hold: { color: '#ff0000', blink: true }  // 红色闪烁:暂停/异常
};

// 等待时间颜色映射
function getQueueTimeColor(seconds: number) {
  if (seconds < 300) return '#00ff00';  // <5分钟:绿色
  if (seconds < 900) return '#ffff00';  // 5-15分钟:黄色
  return '#ff0000';                     // >15分钟:红色
}
```

**验收标准**:
- [ ] 40个在制品同时追踪,无卡顿
- [ ] 在制品移动轨迹平滑(插值动画)
- [ ] 等待时间超过阈值自动预警
- [ ] 点击在制品显示完整工艺路径

---

#### F7: 实时人员位置追踪

**功能描述**:  
如果人员佩戴定位标签(UWB/蓝牙/RFID),实时追踪人员在车间的位置。

**输入**:
- WebSocket消息:
  ```json
  {
    "type": "personnelUpdate",
    "entityId": "urn:ngsi-ld:TwinObject:Person:EMP-001",
    "name": "张三",
    "role": "焊接工",
    "location": {"type": "Point", "coordinates": [12.3, 18.5]},
    "status": "Working",  // Working/Break/Idle
    "observedAt": "2025-11-12T10:30:10+08:00"
  }
  ```

**输出**:
- 地图上人员图标,显示:
  - 姓名
  - 角色
  - 当前状态颜色

**地理围栏功能**:
- 在危险区域(如焊接区、吊装区)设置虚拟围栏
- 人员进入危险区域时触发警报

**验收标准**:
- [ ] 20名人员同时追踪,流畅显示
- [ ] 人员轨迹历史可回放
- [ ] 地理围栏越界自动警报
- [ ] 符合隐私保护要求(非工作时间不追踪)

---

#### F8: 要素选择与详情弹窗

**功能描述**:  
用户点击地图上的设备/在制品/人员要素时,显示该要素的详细信息弹窗。

**输入**:
- 用户点击事件: `map.on('click', handler)`
- 选中要素: `ol.Feature`

**输出**:
- 信息弹窗(Popup),显示:
  ```
  [设备详情]
  - 设备名称: 焊接机器人 RBT-GZ-01
  - 当前状态: 运行中
  - 实时参数:
    · 温度: 45°C
    · 电流: 120A
    · 运行时长: 3小时25分钟
  - 今日产量: 18件
  - 负责人: 李四
  - 最近维护: 2025-11-10
  
  [查看历史趋势] [查看维护记录]
  ```

**数据来源**:
- 基本信息: TwinObject实体
- 实时参数: ModalData (refEntity指向该设备)
- 人员信息: Assignment实体

**交互逻辑**:
1. 点击要素 → 触发 `Select` 交互
2. 获取要素ID(URN)
3. 查询相关数据(可缓存)
4. 渲染弹窗(`ol.Overlay`)
5. 点击空白处关闭弹窗

**验收标准**:
- [ ] 弹窗位置准确(锚定在要素旁)
- [ ] 数据加载<500ms
- [ ] 支持多级信息展开
- [ ] 弹窗样式美观,与整体UI风格一致

---

#### F9: 数据筛选与查询

**功能描述**:  
提供左侧筛选面板,支持用户按类型、状态、区域、属性快速过滤地图要素。

**输入**:
- 筛选条件:
  ```typescript
  {
    type: 'Equipment' | 'Workpiece' | 'Person' | null,
    status: string[],  // 如 ['Fault', 'Maintenance']
    zone: string,      // 区域ID,如 'ZONE-T01'
    keyword: string    // 模糊搜索(名称/编号)
  }
  ```

**输出**:
- 地图上只显示符合条件的要素
- 其他要素隐藏或半透明显示

**实现方案**:
```typescript
function applyFilter(filter: FilterCondition) {
  const features = vectorSource.getFeatures();
  features.forEach(feature => {
    const match = evaluateFilter(feature, filter);
    if (match) {
      feature.setStyle(normalStyle);
    } else {
      feature.setStyle(hiddenStyle);  // 或透明度0.2
    }
  });
}
```

**性能优化**:
- 使用虚拟滚动加载大量要素
- 筛选结果计数显示
- 支持筛选条件保存/加载

**验收标准**:
- [ ] 多条件组合筛选正确
- [ ] 筛选响应<100ms(100个要素)
- [ ] 筛选结果数量实时显示
- [ ] 支持"反选"功能

---

#### F10: 历史轨迹查询

**功能描述**:  
查询指定对象在指定时间范围内的历史轨迹数据。

**输入**:
- 对象ID: `urn:ngsi-ld:TwinObject:Workpiece:M670-SN001`
- 时间范围: `startTime`, `endTime` (ISO 8601格式)

**输出**:
- 轨迹数据数组:
  ```json
  [
    {
      "timestamp": "2025-11-12T10:00:00+08:00",
      "location": {"coordinates": [10.0, 20.0]},
      "status": "InProcess"
    },
    {
      "timestamp": "2025-11-12T10:05:00+08:00",
      "location": {"coordinates": [12.0, 20.0]},
      "status": "InProcess"
    },
    // ...
  ]
  ```

**查询方式**:
- NGSI-LD Temporal Query:
  ```
  GET /ngsi-ld/v1/temporal/entities/{entityId}
      ?timerel=between
      &timeAt=2025-11-12T09:00:00Z
      &endTimeAt=2025-11-12T11:00:00Z
      &attrs=location,status
  ```

**数据处理**:
- 按时间戳排序
- 插值处理(如果采样间隔>5秒,进行线性插值)
- 轨迹简化(Douglas-Peucker算法,减少点数)

**性能要求**:
- 1周数据量查询 < 2秒
- 支持分页查询(避免一次加载过多数据)

**验收标准**:
- [ ] 查询准确性验证(对比原始数据)
- [ ] 查询性能达标(1周数据<2秒)
- [ ] 支持多对象同时查询(最多5个)
- [ ] 异常处理完善(无数据、超时等)

---

#### F11: 轨迹回放动画

**功能描述**:  
基于历史轨迹数据,实现流畅的动画回放效果。

**输入**:
- 轨迹数据(F10查询结果)
- 回放速度: 1x, 2x, 5x, 10x

**输出**:
- 地图上移动对象沿轨迹平滑移动
- 轨迹线(LineString)逐步绘制

**实现方案**:
```typescript
// 方案1: 基于 postrender 事件
layer.on('postrender', (event) => {
  const elapsed = Date.now() - animationStartTime;
  const progress = elapsed / totalDuration;
  
  const currentPosition = interpolateTrajectory(trajectoryPoints, progress);
  movingFeature.getGeometry().setCoordinates(currentPosition);
  
  if (progress < 1) {
    map.render();  // 触发下一帧
  }
});

// 方案2: 基于 requestAnimationFrame
function animate() {
  updatePosition();
  if (!finished) {
    requestAnimationFrame(animate);
  }
}
```

**动画效果**:
- 拖尾效果(tail trail):显示最近5秒的轨迹
- 速度可视化:移动速度快慢影响动画速度
- 多对象同步回放:支持多个对象同时回放

**验收标准**:
- [ ] 动画流畅度>60fps
- [ ] 速度控制准确(2x速度=实际时间的一半)
- [ ] 支持暂停/恢复
- [ ] 支持拖动进度条跳转

---

#### F12: 时间轴控件

**功能描述**:  
提供类似视频播放器的时间轴控件,控制历史轨迹回放。

**输入**:
- 回放时间范围: `startTime`, `endTime`
- 用户操作: 播放/暂停/快进/快退/跳转

**输出**:
- 时间轴UI组件:
  ```
  [播放▶] [暂停⏸] [快进⏩]
  |━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━━|
  └─ 当前时间: 2025-11-12 10:15:30    └─ 结束时间: 2025-11-12 11:00:00
  
  速度: [1x] [2x] [5x] [10x]
  ```

**功能按钮**:
- ▶ 播放: 开始动画
- ⏸ 暂停: 暂停动画
- ⏩ 快进: 跳过5分钟
- ⏪ 快退: 回退5分钟
- 🔁 循环播放
- 📷 截图保存

**交互逻辑**:
- 拖动进度条 → 立即跳转到对应时间点
- 滚轮 → 微调时间(±1秒)
- 双击时间轴 → 标记关键帧

**验收标准**:
- [ ] 所有按钮功能正常
- [ ] 进度条拖动流畅
- [ ] 当前时间显示精确到秒
- [ ] 支持键盘快捷键(空格=播放/暂停,左右箭头=快进/快退)

---

#### F13-F16: 专属视图功能

**F13: Flow流动问题视图**

**功能描述**: 过滤显示物流瓶颈点

**瓶颈判定逻辑**:
```typescript
function isBottleneck(station: Station): boolean {
  const wipCount = getWIPCountAtStation(station.id);
  const avgProcessTime = getAvgProcessTime(station.id);
  const threshold = calculateThreshold(station);
  
  return wipCount > threshold || avgProcessTime > station.standardCT * 1.2;
}
```

**显示效果**:
- 只显示瓶颈工位(高亮显示)
- 其他工位半透明
- 瓶颈工位显示等待队列长度

---

**F14: Quality质量问题视图**

**功能描述**: 过滤显示质量异常设备

**异常判定**:
```typescript
function hasQualityIssue(equipment: Equipment): boolean {
  const recentDefectRate = getRecentDefectRate(equipment.id, hours=24);
  return recentDefectRate > equipment.qualityThreshold;
}
```

**显示效果**:
- 只显示有质量异常的设备(红色图标)
- 显示近24小时不良率
- 提供根因分析入口

---

**F15: Efficiency效率问题视图**

**功能描述**: 过滤显示低效率工位

**效率判定**:
```typescript
function isLowEfficiency(station: Station): boolean {
  const actualOEE = getOEE(station.id);
  return actualOEE < station.targetOEE * 0.9;  // 低于目标90%
}
```

**显示效果**:
- 只显示低效工位(橙色图标)
- 显示OEE值
- 对比目标OEE

---

**F16: Spaghetti图**

**功能描述**: 物料流转路径综合展示

**数据来源**:
- Scene实体的历史数据
- 统计所有在制品在过去24小时的移动路径

**可视化方案**:
```typescript
// 使用 ECharts 的 lines 系列
const spaghettiChart = {
  series: [{
    type: 'lines',
    coordinateSystem: 'ol',  // OpenLayers坐标系
    data: trajectories,
    lineStyle: {
      opacity: 0.4,
      curveness: 0.2,
      color: colorByFrequency  // 颜色深浅表示频次
    },
    effect: {
      show: true,
      trailLength: 0.1,
      symbol: 'arrow',
      symbolSize: 5
    }
  }]
};
```

**显示效果**:
- 所有物料路径叠加显示
- 颜色深浅表示使用频率
- 高频路径突出显示
- 支持点击查看该路径的详细统计

**验收标准(F13-F16)**:
- [ ] 每个视图过滤逻辑正确
- [ ] 切换视图响应<200ms
- [ ] 视图状态可保存
- [ ] Spaghetti图渲染不卡顿(1000条路径)

---

#### F17: 路径优化分析

**功能描述**:  
基于历史物流数据,分析当前路径的合理性,提供优化建议。

**分析维度**:
1. **路径长度**: 计算平均转运距离
2. **路径拥堵**: 识别高频路径段
3. **无效搬运**: 检测往返搬运、绕路等浪费
4. **空间利用**: 分析缓存区利用率

**输出**:
- 优化建议列表:
  ```
  1. 工位P0010 → P0020的路径建议改为直线(节省15%距离)
  2. 缓存区BF-03利用率过高(90%),建议扩容
  3. AGV-01在T01区域往返频繁,建议调整调度策略
  ```
- 优化前后对比图

**实现方案**:
- 使用 Dijkstra 算法计算最短路径
- 使用热力图展示路径密度
- 使用箭头标注建议路径

**验收标准**:
- [ ] 优化建议合理性验证(人工评审)
- [ ] 优化前后定量对比(距离、时间)
- [ ] 支持优化方案模拟(what-if分析)

---

#### F18: 设备OEE分析

**功能描述**:  
在地图上以热力图形式展示各设备的OEE(综合设备效率)。

**OEE计算**:
```
OEE = 可用率 × 性能率 × 质量率
    = (实际运行时间/计划运行时间) 
      × (实际产量×标准CT/实际运行时间) 
      × (良品数/实际产量)
```

**可视化方案**:
- 使用 MapV 的热力图层
- 颜色映射:
  - OEE > 85%: 深绿色
  - 75% < OEE < 85%: 浅绿色
  - 65% < OEE < 75%: 黄色
  - OEE < 65%: 红色

**交互功能**:
- 点击设备查看OEE详细分解
- 查看OEE历史趋势图(ECharts)
- 对比同类设备OEE

**验收标准**:
- [ ] OEE计算准确(与MES系统对比)
- [ ] 热力图渲染流畅
- [ ] 支持时间范围选择(今日/本周/本月)

---

#### F19: 热力图展示

**功能描述**:  
使用 MapV 库实现多种热力图分析。

**热力图类型**:
1. **人员密度热力图**: 显示车间各区域的人员密集程度
2. **设备报警热力图**: 显示设备故障高发区域
3. **在制品堆积热力图**: 显示物料拥堵点

**实现方案**:
```typescript
import { MapVLayer } from 'mapv';

const heatmapDataset = {
  data: [
    { geometry: { type: 'Point', coordinates: [x, y] }, count: 10 },
    // ...
  ]
};

const heatmapLayer = new MapVLayer(map, heatmapDataset, {
  draw: 'heatmap',
  gradient: { 0.25: 'blue', 0.55: 'green', 0.85: 'yellow', 1.0: 'red' },
  max: 100
});
```

**验收标准**:
- [ ] 热力图渲染性能良好(1000个数据点<500ms)
- [ ] 颜色映射合理
- [ ] 支持热力图透明度调节

---

#### F20: 地图标注与编辑

**功能描述**:  
允许用户在地图上绘制标注(点/线/面),并保存。

**功能列表**:
- 绘制点标注(如标记问题点)
- 绘制线标注(如规划新路径)
- 绘制面标注(如划定区域)
- 添加文字标注
- 拖拽编辑已有标注
- 删除标注

**实现方案**:
```typescript
// 使用 Draw 交互
const drawInteraction = new ol.interaction.Draw({
  source: annotationSource,
  type: 'Polygon'  // 或 'Point', 'LineString'
});

map.addInteraction(drawInteraction);

// 使用 Modify 交互
const modifyInteraction = new ol.interaction.Modify({
  source: annotationSource
});

map.addInteraction(modifyInteraction);
```

**数据持久化**:
- 标注保存到后端(可选)
- 或保存到浏览器 IndexedDB
- 支持导出/导入标注文件(GeoJSON)

**验收标准**:
- [ ] 绘制功能流畅
- [ ] 标注样式可自定义
- [ ] 标注可保存和加载
- [ ] 支持协作标注(多用户)

---

## 4. 接口规范 ⭐

### 4.1 前端对外接口

产线2D地图作为独立模块,暴露以下接口供其他系统调用:

#### 接口1: 初始化地图

**接口描述**: 在指定容器中初始化产线地图

**接口定义**:
```typescript
interface MapConfig {
  container: string | HTMLElement;  // 地图容器ID或元素
  baseMapUrl: string;               // 底图数据URL
  dataSource: {
    type: 'platform' | 'mockserver' | 'local';
    endpoint: string;               // NGSI-LD API端点
    websocketUrl?: string;          // WebSocket URL
  };
  initialView?: {
    center: [number, number];       // 初始中心点(车间坐标)
    zoom: number;                   // 初始缩放级别
  };
}

export function initMap(config: MapConfig): MapInstance;
```

**使用示例**:
```typescript
import { initMap } from '@/map-module';

const mapInstance = initMap({
  container: '#map-container',
  baseMapUrl: '/api/basemap/production-line.geojson',
  dataSource: {
    type: 'mockserver',
    endpoint: 'http://localhost:9090/ngsi-ld/v1',
    websocketUrl: 'ws://localhost:9090/ws'
  }
});
```

---

#### 接口2: 切换专属视图

**接口描述**: 程序化切换地图视图模式

**接口定义**:
```typescript
type ViewMode = 'default' | 'flow' | 'quality' | 'efficiency' | 'spaghetti';

interface MapInstance {
  switchView(mode: ViewMode): void;
  getCurrentView(): ViewMode;
}
```

**使用示例**:
```typescript
mapInstance.switchView('flow');  // 切换到Flow流动问题视图
```

---

#### 接口3: 查询地图要素

**接口描述**: 根据条件查询地图上的要素

**接口定义**:
```typescript
interface FeatureQuery {
  type?: 'Equipment' | 'Workpiece' | 'Person';
  status?: string | string[];
  zone?: string;
  bounds?: [number, number, number, number];  // [minX, minY, maxX, maxY]
}

interface MapInstance {
  queryFeatures(query: FeatureQuery): Feature[];
  highlightFeatures(featureIds: string[]): void;
  clearHighlight(): void;
}
```

**使用示例**:
```typescript
// 查询所有故障设备
const faultEquipments = mapInstance.queryFeatures({
  type: 'Equipment',
  status: 'Fault'
});

// 高亮显示
mapInstance.highlightFeatures(faultEquipments.map(f => f.id));
```

---

#### 接口4: 订阅地图事件

**接口描述**: 监听地图上的用户交互事件

**接口定义**:
```typescript
type MapEventType = 'featureClick' | 'featureHover' | 'viewChange' | 'dataUpdate';

interface MapEvent {
  type: MapEventType;
  feature?: Feature;
  view?: ViewState;
  timestamp: string;
}

interface MapInstance {
  on(eventType: MapEventType, callback: (event: MapEvent) => void): void;
  off(eventType: MapEventType, callback: Function): void;
}
```

**使用示例**:
```typescript
mapInstance.on('featureClick', (event) => {
  console.log('用户点击了:', event.feature.properties.name);
  // 可触发外部逻辑,如打开详情页
});
```

---

### 4.2 后端API接口

#### 接口1: 获取底图数据

**接口描述**: 获取产线布局的矢量底图数据

**请求格式**:
```
GET /api/map/basemap
Query Parameters:
  - lineCode: string (产线代码,如 TS361202)
  - version: string (可选,布局版本)
```

**响应格式**:
```json
{
  "success": true,
  "data": {
    "type": "FeatureCollection",
    "features": [
      {
        "type": "Feature",
        "id": "urn:ngsi-ld:TwinObject:Zone:ZONE-T01",
        "geometry": {
          "type": "Polygon",
          "coordinates": [[[x1,y1], [x2,y2], ...]]
        },
        "properties": {
          "name": "组焊工序区",
          "type": "Zone",
          "color": "#e8f5e9"
        }
      },
      // ... 更多要素
    ]
  }
}
```

**数据契约映射**:
| GeoJSON字段 | TwinObject字段 | 说明 |
|-------------|----------------|------|
| `id` | `id` (URN) | 要素唯一标识 |
| `properties.name` | `name.value` | 要素名称 |
| `properties.type` | `type` | 实体类型 |
| `geometry` | `location.value` | 几何信息 |

---

#### 接口2: 获取实时要素数据

**接口描述**: 批量查询当前所有活动要素的实时数据

**请求格式**:
```
GET /api/map/entities/realtime
Query Parameters:
  - types: string[] (如 ['Robot', 'Workpiece', 'Person'])
  - limit: number (可选,默认100)
```

**响应格式**:
```json
{
  "success": true,
  "data": [
    {
      "id": "urn:ngsi-ld:TwinObject:Robot:RBT-GZ-01",
      "type": "Robot",
      "name": "焊接机器人01",
      "location": {"type": "Point", "coordinates": [10.5, 20.3]},
      "status": "Running",
      "modalData": {
        "temperature": 45.2,
        "current": 120.5,
        "output": 18
      },
      "observedAt": "2025-11-12T10:30:00+08:00"
    },
    // ... 更多要素
  ],
  "total": 67
}
```

**数据来源**:
- 基本信息: TwinObject实体 (NGSI-LD查询)
- 实时数据: ModalData实体 (最新数据)

---

#### 接口3: 查询历史轨迹

**接口描述**: 查询指定实体的历史位置轨迹

**请求格式**:
```
GET /api/map/trajectory/{entityId}
Query Parameters:
  - startTime: string (ISO 8601)
  - endTime: string (ISO 8601)
  - interval: number (可选,采样间隔,单位:秒,默认60)
```

**请求示例**:
```
GET /api/map/trajectory/urn:ngsi-ld:TwinObject:Workpiece:M670-SN001
    ?startTime=2025-11-11T00:00:00+08:00
    &endTime=2025-11-12T00:00:00+08:00
    &interval=300
```

**响应格式**:
```json
{
  "success": true,
  "data": {
    "entityId": "urn:ngsi-ld:TwinObject:Workpiece:M670-SN001",
    "entityType": "Workpiece",
    "timeRange": {
      "start": "2025-11-11T00:00:00+08:00",
      "end": "2025-11-12T00:00:00+08:00"
    },
    "trajectoryPoints": [
      {
        "timestamp": "2025-11-11T08:00:00+08:00",
        "location": {"coordinates": [5.2, 18.3]},
        "status": "Pending"
      },
      {
        "timestamp": "2025-11-11T08:05:00+08:00",
        "location": {"coordinates": [10.5, 18.3]},
        "status": "InProcess"
      },
      // ... 更多点
    ],
    "totalPoints": 288
  }
}
```

**后端实现逻辑**:
```python
# 使用 NGSI-LD Temporal API
response = requests.get(
    f"{ngsi_endpoint}/temporal/entities/{entity_id}",
    params={
        "timerel": "between",
        "timeAt": start_time,
        "endTimeAt": end_time,
        "attrs": "location,status"
    }
)
```

---

#### 接口4: WebSocket实时数据推送

**接口描述**: 通过WebSocket推送实时数据变化

**连接URL**:
```
ws://[backend-host]/ws/map/realtime
```

**消息格式**:
```json
{
  "type": "entityUpdate",
  "timestamp": "2025-11-12T10:30:00+08:00",
  "entities": [
    {
      "id": "urn:ngsi-ld:TwinObject:Robot:RBT-GZ-01",
      "updateType": "status",  // status/location/modalData
      "changes": {
        "status": "Fault",
        "location": {"coordinates": [10.5, 20.3]}
      }
    }
  ]
}
```

**消息类型**:
- `entityUpdate`: 实体数据更新
- `kpiUpdate`: KPI指标更新
- `alertNotification`: 异常警报
- `systemStatus`: 系统状态(连接/断开)

**客户端订阅**:
```typescript
const ws = new WebSocket('ws://localhost:8000/ws/map/realtime');

ws.onmessage = (event) => {
  const message = JSON.parse(event.data);
  handleRealtimeUpdate(message);
};

ws.onerror = (error) => {
  console.error('WebSocket error:', error);
  // 触发重连机制
};
```

**心跳保活**:
- 客户端每30秒发送 `{type: 'ping'}`
- 服务端响应 `{type: 'pong'}`
- 超过90秒无响应则认为连接断开

---

#### 接口5: 获取KPI指标数据

**接口描述**: 获取顶部6个KPI指标的当前值

**请求格式**:
```
GET /api/map/kpi
Query Parameters:
  - indicators: string[] (可选,指定KPI名称)
```

**响应格式**:
```json
{
  "success": true,
  "data": [
    {
      "id": "Flow_DailyOutput",
      "name": "Flow产量",
      "value": 21,
      "unit": "件/天",
      "target": 24,
      "threshold": {
        "green": 20,
        "yellow": 15
      },
      "status": "yellow",
      "trend": "down",  // up/down/stable
      "observedAt": "2025-11-12T10:30:00+08:00"
    },
    {
      "id": "PLT_InfoRate",
      "name": "PLT信息率",
      "value": 73,
      "unit": "%",
      "target": 90,
      "threshold": {
        "green": 80,
        "yellow": 60
      },
      "status": "yellow",
      "trend": "stable",
      "observedAt": "2025-11-12T10:30:00+08:00"
    },
    // ... 其他4个KPI
  ],
  "lastUpdated": "2025-11-12T10:30:00+08:00"
}
```

**数据来源**:
- ModalData实体,通过 `refModality` 关联到对应的Modality定义
- 实时计算或缓存(Redis)

---

### 4.3 错误处理规范

所有API接口遵循统一的错误响应格式:

```json
{
  "success": false,
  "error": {
    "code": "E4001",
    "message": "实体不存在",
    "details": {
      "entityId": "urn:ngsi-ld:TwinObject:Robot:INVALID-ID",
      "suggestion": "请检查实体ID是否正确"
    }
  },
  "timestamp": "2025-11-12T10:30:00+08:00"
}
```

**错误码定义**:
| 错误码 | HTTP状态码 | 说明 | 处理建议 |
|-------|-----------|------|---------|
| E4000 | 400 | 请求参数错误 | 检查参数格式 |
| E4001 | 404 | 实体不存在 | 确认实体ID |
| E4002 | 400 | 时间范围无效 | 检查时间格式 |
| E5001 | 500 | 数据库查询失败 | 稍后重试 |
| E5002 | 503 | NGSI-LD服务不可用 | 检查服务状态 |
| E5003 | 500 | WebSocket连接失败 | 重新连接 |

---

## 5. 技术栈要求 ⭐

### 5.1 前端技术栈

```yaml
# 核心框架
框架: React 18.3+
语言: TypeScript 5.3+
构建工具: Vite 5.0+

# 地图引擎
地图库: OpenLayers 9.0+
投影转换: proj4 2.9+
矢量图层: ol/layer/Vector
交互控件: ol/interaction/Select, Modify, Draw

# 可视化组件
图表库: ECharts 5.5+
地理可视化: MapV 2.0+
UI组件: Ant Design 5.12+ 或 Material-UI 5.14+

# 状态管理
状态库: Zustand 4.4+ 或 Redux Toolkit 2.0+
数据缓存: React Query 5.0+

# 网络通信
HTTP客户端: Axios 1.6+
WebSocket: 原生 WebSocket API

# 工具库
日期处理: dayjs 1.11+
几何计算: Turf.js 6.5+ (可选)
样式: Tailwind CSS 3.4+ 或 styled-components 6.1+
```

### 5.2 后端技术栈

```yaml
# 核心框架
语言: Python 3.11+
Web框架: FastAPI 0.104+
ASGI服务器: Uvicorn 0.24+

# 数据验证
验证库: Pydantic 2.5+

# 网络通信
HTTP客户端: httpx 0.25+
WebSocket: FastAPI WebSocket 支持

# 数据处理
数据库: Redis 7.2+ (缓存)
数据格式: GeoJSON, JSON

# 容器化
容器: Docker 24+
编排: Docker Compose 2.23+
```

### 5.3 开发工具

```yaml
# 代码质量
前端: ESLint 8.0+, Prettier 3.0+
后端: Black 23.0+, Flake8 6.0+

# 测试框架
前端: Vitest 1.0+, React Testing Library 14.0+
后端: Pytest 7.4+

# 版本控制
Git: 2.42+
分支策略: Git Flow

# CI/CD
可选: GitHub Actions, GitLab CI
```

### 5.4 推荐的依赖版本

#### 前端 package.json

```json
{
  "dependencies": {
    "react": "^18.3.0",
    "react-dom": "^18.3.0",
    "typescript": "^5.3.0",
    "ol": "^9.0.0",
    "proj4": "^2.9.2",
    "echarts": "^5.5.0",
    "echarts-for-react": "^3.0.2",
    "mapv": "^2.0.62",
    "antd": "^5.12.0",
    "zustand": "^4.4.7",
    "@tanstack/react-query": "^5.0.0",
    "axios": "^1.6.2",
    "dayjs": "^1.11.10",
    "@turf/turf": "^6.5.0"
  },
  "devDependencies": {
    "vite": "^5.0.0",
    "@vitejs/plugin-react": "^4.2.0",
    "eslint": "^8.56.0",
    "prettier": "^3.1.0",
    "vitest": "^1.0.0",
    "@testing-library/react": "^14.1.0"
  }
}
```

#### 后端 requirements.txt

```
fastapi==0.104.1
uvicorn[standard]==0.24.0
pydantic==2.5.2
pydantic-settings==2.1.0
httpx==0.25.1
redis==5.0.1
python-dotenv==1.0.0
websockets==12.0
geojson==3.1.0

# 开发依赖
pytest==7.4.3
pytest-asyncio==0.21.1
black==23.12.0
flake8==6.1.0
```

---

## 6. 前期依赖文件 ⭐

### 6.1 必须上传的契约文档

从项目根目录上传以下契约文件:

```
✅ /mnt/project/00_总契约.md
✅ /mnt/project/01_TwinObject契约.md
✅ /mnt/project/02_MBOM契约.md
✅ /mnt/project/03_Scene契约.md
✅ /mnt/project/04_Modality契约.md
✅ /mnt/project/05_ModalityBinding契约.md
✅ /mnt/project/06_ModalData契约.md
✅ /mnt/project/07_Role契约.md
✅ /mnt/project/08_Assignment契约.md
```

### 6.2 必须上传的前期成果

```
✅ /mnt/project/产线2D数字地图页面截图.png  
   (用途: UI原型参考)

✅ /mnt/project/基于OpenLayers的车间生产数据地图技术方案.pdf  
   (用途: 技术方案参考)
```

### 6.3 可选参考文件

```
✅ /mnt/project/03数字孪生实体数据目录.md
   (用途: 了解实体类型全貌)

✅ /mnt/project/04数字孪生平台数据服务接口技术规范_NGSI-LD.md
   (用途: 理解NGSI-LD接口规范)
```

### 6.4 文件上传清单

| 目录 | 文件数 | 用途 |
|-----|-------|------|
| 契约文档 | 9 | 数据契约约束 |
| 前期成果 | 2 | UI和技术参考 |
| 参考文档 | 2 | 背景知识补充 |
| **总计** | **13** | |

---

## 7. 开发任务拆解 ⭐

### 7.1 Phase 划分

开发分为 4 个阶段,总工时约 **280-320小时** (约 **10-11周**)

```
Phase 1: 基础地图渲染 - 60h (2-3周)
Phase 2: 实时监控功能 - 70h (2-3周)
Phase 3: 历史回放功能 - 70h (2-3周)
Phase 4: 高级分析功能 - 80-100h (3-4周)
```

### 7.2 详细任务列表

---

#### Phase 1: 基础地图渲染 (60小时)

**目标**: 搭建项目脚手架,实现地图基础渲染和交互

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| **T1.1** | 前后端项目初始化 | 项目目录结构、配置文件 | 项目可正常启动 | 6h |
| **T1.2** | 自定义坐标系实现 | proj4配置、转换函数 | 转换精度测试通过 | 8h |
| **T1.3** | 产线底图加载 | GeoJSON加载、样式渲染 | 底图正确显示 | 10h |
| **T1.4** | 地图基础交互 | 缩放/平移/控件 | 交互流畅60fps | 6h |
| **T1.5** | 多图层管理 | 6个图层独立控制 | 图层切换正常 | 8h |
| **T1.6** | KPI指标展示 | 顶部指标栏组件 | 6个KPI正确显示 | 10h |
| **T1.7** | Mock数据准备 | 前端Mock、后端Mock | Mock数据完整 | 8h |
| **T1.8** | 单元测试 | 测试用例 | 覆盖率>70% | 4h |

**T1.1详细说明**:
- **目标**: 创建Monorepo项目结构,配置TypeScript、Vite、FastAPI
- **交付物**: 
  ```
  production-line-map/
  ├── frontend/  (React + TypeScript + Vite)
  ├── backend/   (FastAPI + Python)
  ├── shared/    (共享类型定义)
  ├── docker-compose.yml
  └── README.md
  ```
- **验收标准**:
  - [ ] `npm run dev` 启动前端成功(http://localhost:5173)
  - [ ] `uvicorn app.main:app` 启动后端成功(http://localhost:8000)
  - [ ] ESLint、Prettier配置生效
  - [ ] Git仓库初始化,`.gitignore`配置正确

**T1.2详细说明**:
- **目标**: 使用proj4.js实现车间坐标系与Web墨卡托的转换
- **交付物**:
  - `frontend/src/utils/coordinate-transform.ts`
  - 单元测试文件
- **验收标准**:
  - [ ] 正向转换精度<1cm (100个测试点)
  - [ ] 反向转换往返误差<0.1mm
  - [ ] 性能测试:1000次转换<10ms
  - [ ] 边界情况覆盖(原点、极值)

**T1.3详细说明**:
- **目标**: 加载产线矢量布局图(GeoJSON)并应用样式
- **交付物**:
  - `frontend/src/components/BaseMapLayer.tsx`
  - 样式配置文件
- **验收标准**:
  - [ ] 底图要素完整加载(Zone、Station、Passage、Buffer)
  - [ ] 样式正确(墙体灰色、工位蓝色、通道绿色、缓存区黄色)
  - [ ] 标签清晰可读
  - [ ] 初始视图居中

**T1.6详细说明**:
- **目标**: 实现顶部KPI指标栏,显示6个核心指标
- **交付物**:
  - `frontend/src/components/KPIBar.tsx`
  - KPI数据服务
- **验收标准**:
  - [ ] 6个指标正确显示,格式统一
  - [ ] 颜色根据阈值动态变化(绿/黄/红)
  - [ ] 点击指标显示详细趋势图(ECharts)
  - [ ] 数据自动刷新(1-5分钟)

---

#### Phase 2: 实时监控功能 (70小时)

**目标**: 实现设备/在制品/人员的实时状态监控

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| **T2.1** | WebSocket连接管理 | 前后端WebSocket模块 | 连接稳定,自动重连 | 10h |
| **T2.2** | 实时设备状态监控 | 设备图层、状态更新 | 30台设备实时更新 | 12h |
| **T2.3** | 实时在制品追踪 | 在制品图层、位置更新 | 40个在制品流畅追踪 | 10h |
| **T2.4** | 实时人员追踪 | 人员图层、位置更新 | 20人实时定位 | 8h |
| **T2.5** | 要素选择与详情弹窗 | Popup组件、详情查询 | 点击显示详情<500ms | 10h |
| **T2.6** | 数据筛选与查询 | 筛选面板、查询逻辑 | 多条件筛选正确 | 10h |
| **T2.7** | 性能优化 | 防抖/节流/虚拟滚动 | 100并发用户稳定 | 6h |
| **T2.8** | 集成测试 | 端到端测试 | 关键流程覆盖 | 4h |

**T2.1详细说明**:
- **目标**: 实现前后端WebSocket通信,支持实时数据推送
- **交付物**:
  - 前端: `frontend/src/services/websocket-service.ts`
  - 后端: `backend/app/core/websocket_manager.py`
- **验收标准**:
  - [ ] WebSocket连接建立成功
  - [ ] 心跳保活机制正常(30秒ping)
  - [ ] 断线自动重连(指数退避:1s, 2s, 4s, 8s, ...)
  - [ ] 支持100个并发连接
  - [ ] 消息队列缓冲(避免丢失)

**T2.2详细说明**:
- **目标**: 实时监控30台设备的状态,动态更新图标
- **交付物**:
  - `frontend/src/components/EquipmentLayer.tsx`
  - 设备状态样式映射
- **验收标准**:
  - [ ] 设备状态变化实时反映(<100ms延迟)
  - [ ] 故障设备红色闪烁警示
  - [ ] 支持设备图标自定义(不同类型不同图标)
  - [ ] 性能测试:30台×1次/秒×100用户,CPU<50%

**T2.5详细说明**:
- **目标**: 点击地图要素显示详情弹窗
- **交付物**:
  - `frontend/src/components/FeaturePopup.tsx`
  - 详情数据查询API
- **验收标准**:
  - [ ] 弹窗位置锚定在要素旁边
  - [ ] 数据加载<500ms
  - [ ] 支持多层级信息展开(基本信息/实时参数/历史记录)
  - [ ] 弹窗样式美观,响应式布局

---

#### Phase 3: 历史回放功能 (70小时)

**目标**: 实现历史轨迹查询和动画回放

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| **T3.1** | 历史轨迹查询接口 | 后端Temporal Query | 1周数据查询<2秒 | 12h |
| **T3.2** | 轨迹数据处理 | 插值/简化算法 | 轨迹点优化50% | 8h |
| **T3.3** | 轨迹回放动画 | postrender动画 | 60fps流畅动画 | 14h |
| **T3.4** | 时间轴控件 | 播放器UI组件 | 所有按钮功能正常 | 12h |
| **T3.5** | 多对象同步回放 | 多轨迹并行管理 | 5个对象同步回放 | 10h |
| **T3.6** | 轨迹线可视化 | LineString图层 | 轨迹线渐进显示 | 8h |
| **T3.7** | 性能优化 | 大数据量优化 | 1000点轨迹<3秒 | 4h |
| **T3.8** | 功能测试 | 回放场景测试 | 用户体验流畅 | 2h |

**T3.1详细说明**:
- **目标**: 实现后端历史轨迹查询,支持时间范围查询
- **交付物**:
  - `backend/app/api/v1/trajectory_routes.py`
  - NGSI-LD Temporal Query封装
- **验收标准**:
  - [ ] 查询准确性:返回数据与原始数据一致
  - [ ] 查询性能:1周数据(<10000点)<2秒
  - [ ] 支持分页查询(limit+offset)
  - [ ] 支持多对象批量查询

**T3.3详细说明**:
- **目标**: 使用postrender或requestAnimationFrame实现轨迹回放动画
- **交付物**:
  - `frontend/src/components/TrajectoryPlayer.tsx`
  - 动画引擎
- **验收标准**:
  - [ ] 动画流畅度>60fps
  - [ ] 支持速度调节(1x, 2x, 5x, 10x)
  - [ ] 支持暂停/恢复
  - [ ] 拖尾效果展示最近5秒轨迹

**T3.4详细说明**:
- **目标**: 实现类视频播放器的时间轴控件
- **交付物**:
  - `frontend/src/components/TimelineControl.tsx`
- **验收标准**:
  - [ ] 播放/暂停/快进/快退按钮功能正常
  - [ ] 进度条拖动流畅,跳转准确
  - [ ] 当前时间显示精确到秒
  - [ ] 支持键盘快捷键(空格、箭头)

---

#### Phase 4: 高级分析功能 (80-100小时)

**目标**: 实现专属视图、路径分析、热力图等高级功能

| 任务ID | 任务描述 | 交付物 | 验收标准 | 工时 |
|-------|---------|-------|---------|------|
| **T4.1** | Flow流动问题视图 | 瓶颈识别算法、过滤 | 瓶颈点准确识别 | 12h |
| **T4.2** | Quality质量问题视图 | 异常设备过滤 | 质量异常正确过滤 | 8h |
| **T4.3** | Efficiency效率问题视图 | 低效工位过滤 | 效率判定准确 | 8h |
| **T4.4** | Spaghetti图 | 路径综合可视化 | 1000条路径流畅 | 14h |
| **T4.5** | 路径优化分析 | 最短路径算法、建议 | 优化建议合理 | 14h |
| **T4.6** | 设备OEE热力图 | MapV热力图集成 | OEE计算准确 | 10h |
| **T4.7** | 多类型热力图 | 人员密度/报警热力图 | 热力图性能良好 | 8h |
| **T4.8** | 地图标注与编辑 | Draw/Modify交互 | 绘制功能流畅 | 8h |
| **T4.9** | 数据导出功能 | 截图/报表导出 | 导出文件正确 | 6h |
| **T4.10** | 性能全面优化 | 代码优化、懒加载 | 大数据量不卡顿 | 8h |
| **T4.11** | 用户文档 | README、API文档 | 文档完整清晰 | 4h |

**T4.1详细说明**:
- **目标**: 实现Flow流动问题视图,自动识别物流瓶颈点
- **交付物**:
  - 瓶颈识别算法
  - 过滤显示逻辑
- **验收标准**:
  - [ ] 瓶颈判定逻辑正确(队列长度>阈值 或 CT>标准CT×1.2)
  - [ ] 只显示瓶颈工位,其他工位半透明
  - [ ] 显示等待队列长度
  - [ ] 切换视图响应<200ms

**T4.4详细说明**:
- **目标**: 综合展示所有物料流转路径(Spaghetti图)
- **交付物**:
  - `frontend/src/components/SpaghettiDiagram.tsx`
  - ECharts lines系列集成
- **验收标准**:
  - [ ] 路径叠加显示,颜色深浅表示频次
  - [ ] 支持1000条路径流畅渲染
  - [ ] 高频路径突出显示
  - [ ] 点击路径查看详细统计

**T4.5详细说明**:
- **目标**: 基于历史数据分析路径合理性,提供优化建议
- **交付物**:
  - Dijkstra算法实现
  - 优化建议生成逻辑
- **验收标准**:
  - [ ] 计算最短路径准确
  - [ ] 识别无效搬运(往返、绕路)
  - [ ] 优化建议合理(人工评审)
  - [ ] 优化前后定量对比(距离、时间)

**T4.6详细说明**:
- **目标**: 在地图上展示各设备的OEE热力图
- **交付物**:
  - OEE计算引擎
  - MapV热力图集成
- **验收标准**:
  - [ ] OEE计算准确(与MES系统对比误差<2%)
  - [ ] 热力图渲染流畅(30台设备<500ms)
  - [ ] 颜色映射合理(绿/黄/红)
  - [ ] 支持时间范围选择(今日/本周/本月)

---

### 7.3 开发顺序

```
Phase 1 (基础地图)
   ↓
Phase 2 (实时监控)
   ↓
Phase 3 (历史回放)
   ↓
Phase 4 (高级分析)

说明:
- 各Phase必须按顺序完成
- 每个Phase内的任务可并行开发(前后端并行)
- Phase 1完成后前端可独立使用Mock数据开发Phase 2
- Phase 2完成后可开始压力测试
```

---

## 8. 项目结构建议

### 8.1 推荐的目录结构

```
production-line-map/
├── frontend/                           # 前端项目
│   ├── public/
│   │   ├── favicon.ico
│   │   ├── basemap/                    # 底图数据
│   │   │   └── production-line.geojson
│   │   └── assets/                     # 静态资源
│   │       ├── icons/                  # 设备图标
│   │       └── images/
│   ├── src/
│   │   ├── main.tsx                    # 应用入口
│   │   ├── App.tsx
│   │   ├── components/                 # React组件
│   │   │   ├── Map/
│   │   │   │   ├── MapContainer.tsx    # 地图容器
│   │   │   │   ├── BaseMapLayer.tsx    # 底图图层
│   │   │   │   ├── EquipmentLayer.tsx  # 设备图层
│   │   │   │   ├── WorkpieceLayer.tsx  # 在制品图层
│   │   │   │   ├── PersonnelLayer.tsx  # 人员图层
│   │   │   │   └── PathLayer.tsx       # 路径图层
│   │   │   ├── Controls/
│   │   │   │   ├── LayerSwitcher.tsx   # 图层切换
│   │   │   │   ├── ViewModeSelector.tsx # 视图模式选择
│   │   │   │   ├── FilterPanel.tsx     # 筛选面板
│   │   │   │   └── SearchBox.tsx       # 搜索框
│   │   │   ├── Popup/
│   │   │   │   ├── FeaturePopup.tsx    # 要素详情弹窗
│   │   │   │   └── ChartPopup.tsx      # 图表弹窗
│   │   │   ├── KPIBar/
│   │   │   │   ├── KPIBar.tsx          # KPI指标栏
│   │   │   │   └── KPIIndicator.tsx    # 单个指标
│   │   │   ├── Timeline/
│   │   │   │   ├── TimelineControl.tsx # 时间轴控件
│   │   │   │   └── TrajectoryPlayer.tsx # 轨迹播放器
│   │   │   ├── Analysis/
│   │   │   │   ├── SpaghettiDiagram.tsx # Spaghetti图
│   │   │   │   ├── HeatmapLayer.tsx    # 热力图
│   │   │   │   └── PathOptimization.tsx # 路径优化
│   │   │   └── shared/                 # 共享UI组件
│   │   │       ├── Loading.tsx
│   │   │       ├── ErrorBoundary.tsx
│   │   │       └── Tooltip.tsx
│   │   ├── services/                   # 业务服务
│   │   │   ├── api-client.ts           # API客户端
│   │   │   ├── websocket-service.ts    # WebSocket服务
│   │   │   ├── map-service.ts          # 地图服务
│   │   │   ├── trajectory-service.ts   # 轨迹服务
│   │   │   └── ngsi-ld-client.ts       # NGSI-LD客户端(可选)
│   │   ├── stores/                     # 状态管理
│   │   │   ├── map-store.ts            # 地图状态
│   │   │   ├── feature-store.ts        # 要素状态
│   │   │   ├── filter-store.ts         # 筛选状态
│   │   │   └── user-store.ts           # 用户状态
│   │   ├── hooks/                      # React Hooks
│   │   │   ├── useMap.ts               # 地图Hook
│   │   │   ├── useRealtime.ts          # 实时数据Hook
│   │   │   ├── useTrajectory.ts        # 轨迹Hook
│   │   │   └── useFilter.ts            # 筛选Hook
│   │   ├── utils/                      # 工具函数
│   │   │   ├── coordinate-transform.ts # 坐标转换
│   │   │   ├── geometry-utils.ts       # 几何计算
│   │   │   ├── style-utils.ts          # 样式工具
│   │   │   ├── date-utils.ts           # 日期工具
│   │   │   └── interpolation.ts        # 插值算法
│   │   ├── types/                      # TypeScript类型
│   │   │   ├── map-types.ts
│   │   │   ├── feature-types.ts
│   │   │   ├── ngsi-ld-types.ts
│   │   │   └── api-types.ts
│   │   ├── config/                     # 配置文件
│   │   │   ├── map-config.ts           # 地图配置
│   │   │   ├── api-config.ts           # API配置
│   │   │   └── constants.ts            # 常量定义
│   │   ├── styles/                     # 全局样式
│   │   │   ├── global.css
│   │   │   ├── map.css
│   │   │   └── variables.css
│   │   └── __tests__/                  # 测试文件
│   │       ├── components/
│   │       ├── services/
│   │       └── utils/
│   ├── package.json
│   ├── vite.config.ts
│   ├── tsconfig.json
│   ├── .eslintrc.js
│   ├── .prettierrc
│   └── README.md
│
├── backend/                            # 后端项目
│   ├── app/
│   │   ├── main.py                     # FastAPI应用入口
│   │   ├── api/                        # API路由
│   │   │   └── v1/
│   │   │       ├── __init__.py
│   │   │       ├── map_routes.py       # 地图相关API
│   │   │       ├── entity_routes.py    # 实体查询API
│   │   │       ├── trajectory_routes.py # 轨迹查询API
│   │   │       ├── kpi_routes.py       # KPI查询API
│   │   │       └── websocket_routes.py # WebSocket路由
│   │   ├── core/                       # 核心服务
│   │   │   ├── __init__.py
│   │   │   ├── config.py               # 配置管理
│   │   │   ├── ngsi_client.py          # NGSI-LD客户端
│   │   │   ├── cache_service.py        # Redis缓存
│   │   │   ├── websocket_manager.py    # WebSocket管理器
│   │   │   └── logging.py              # 日志配置
│   │   ├── services/                   # 业务逻辑
│   │   │   ├── __init__.py
│   │   │   ├── map_service.py          # 地图服务
│   │   │   ├── entity_service.py       # 实体查询服务
│   │   │   ├── trajectory_service.py   # 轨迹查询服务
│   │   │   ├── kpi_service.py          # KPI计算服务
│   │   │   └── realtime_service.py     # 实时数据服务
│   │   ├── models/                     # 数据模型
│   │   │   ├── __init__.py
│   │   │   ├── contracts.py            # 契约数据模型
│   │   │   ├── requests.py             # 请求模型
│   │   │   ├── responses.py            # 响应模型
│   │   │   └── entities.py             # 实体模型
│   │   ├── utils/                      # 工具函数
│   │   │   ├── __init__.py
│   │   │   ├── coordinate_utils.py     # 坐标处理
│   │   │   ├── geojson_utils.py        # GeoJSON处理
│   │   │   ├── time_utils.py           # 时间处理
│   │   │   └── validation.py           # 数据验证
│   │   └── middleware/                 # 中间件
│   │       ├── __init__.py
│   │       ├── cors.py                 # CORS配置
│   │       ├── error_handler.py        # 错误处理
│   │       └── rate_limit.py           # 限流(可选)
│   ├── tests/                          # 测试代码
│   │   ├── __init__.py
│   │   ├── conftest.py                 # Pytest配置
│   │   ├── test_api/
│   │   ├── test_services/
│   │   └── test_utils/
│   ├── data/                           # 数据文件(开发用)
│   │   ├── basemap/
│   │   │   └── production-line.geojson
│   │   └── mock/
│   │       ├── entities.json
│   │       └── trajectories.json
│   ├── requirements.txt
│   ├── pytest.ini
│   ├── .env.example                    # 环境变量示例
│   └── README.md
│
├── shared/                             # 前后端共享
│   ├── api-contracts/                  # API契约文档
│   │   ├── map-api.md
│   │   └── websocket-protocol.md
│   ├── constants/                      # 常量定义
│   │   └── entity-types.ts
│   └── schemas/                        # JSON Schema
│       ├── feature-schema.json
│       └── trajectory-schema.json
│
├── docs/                               # 文档
│   ├── architecture.md                 # 架构说明
│   ├── api-reference.md                # API参考
│   ├── development-guide.md            # 开发指南
│   ├── deployment-guide.md             # 部署指南
│   └── user-manual.md                  # 用户手册
│
├── docker/                             # Docker配置
│   ├── frontend.Dockerfile
│   ├── backend.Dockerfile
│   └── nginx.conf                      # Nginx配置(生产环境)
│
├── scripts/                            # 脚本
│   ├── build.sh                        # 构建脚本
│   ├── deploy.sh                       # 部署脚本
│   └── test.sh                         # 测试脚本
│
├── .gitignore
├── .dockerignore
├── docker-compose.yml                  # 开发环境编排
├── docker-compose.prod.yml             # 生产环境编排
├── Makefile                            # 常用命令
├── LICENSE
└── README.md
```

### 8.2 关键模块说明

#### 8.2.1 前端核心模块

**MapContainer.tsx**
- 职责:初始化OpenLayers地图,管理图层
- 输入:地图配置、数据源配置
- 输出:地图实例、图层管理器

**CoordinateTransform.ts**
- 职责:车间坐标与Web墨卡托互转
- 算法:proj4.js + EPSG:10001定义
- 性能:1000次转换<10ms

**WebSocketService.ts**
- 职责:管理WebSocket连接,处理实时消息
- 功能:自动重连、心跳保活、消息队列
- 并发:支持100个连接

**TrajectoryPlayer.tsx**
- 职责:历史轨迹动画回放
- 算法:requestAnimationFrame + 线性插值
- 性能:60fps流畅播放

#### 8.2.2 后端核心模块

**NGSIClient.py**
- 职责:封装NGSI-LD API调用
- 功能:实体查询、Temporal Query、批量查询
- 配置:支持切换Mockserver/管理平台

**TrajectoryService.py**
- 职责:历史轨迹查询和数据处理
- 算法:时间范围查询、插值、简化(Douglas-Peucker)
- 性能:1周数据查询<2秒

**WebSocketManager.py**
- 职责:管理所有WebSocket连接
- 功能:消息广播、连接池管理、心跳检测
- 并发:支持100个连接

**CacheService.py**
- 职责:Redis缓存管理
- 功能:实时数据缓存、查询结果缓存
- 策略:LRU淘汰、TTL过期

---

## 9. 测试要求 ⭐

### 9.1 测试覆盖率目标

| 测试类型 | 覆盖率目标 | 工具 |
|---------|-----------|------|
| 前端单元测试 | > 70% | Vitest + React Testing Library |
| 后端单元测试 | > 80% | Pytest |
| 前端组件测试 | > 60% | Vitest + Testing Library |
| 后端API测试 | > 90% | Pytest + httpx |
| 端到端测试 | 核心流程覆盖 | Playwright (可选) |

### 9.2 关键测试场景

#### 前端测试场景

**必须测试的场景**:
1. **坐标转换精度测试**:
   - 测试数据:100个已知坐标点
   - 验证:正向转换误差<1cm,往返误差<0.1mm
   
2. **地图渲染性能测试**:
   - 测试数据:100个设备 + 100个在制品
   - 验证:初始渲染<2秒,帧率>60fps
   
3. **实时更新性能测试**:
   - 测试数据:30台设备×1次/秒×100用户
   - 验证:更新延迟<100ms,CPU<50%
   
4. **轨迹回放流畅性测试**:
   - 测试数据:1000点轨迹
   - 验证:动画帧率>60fps,内存无泄漏
   
5. **用户交互响应测试**:
   - 测试场景:点击要素、切换图层、筛选查询
   - 验证:响应时间<200ms

#### 后端测试场景

**必须测试的场景**:
1. **NGSI-LD查询准确性测试**:
   - 测试数据:已知实体数据集
   - 验证:查询结果与预期100%一致
   
2. **历史轨迹查询性能测试**:
   - 测试数据:1周轨迹数据(~10000点)
   - 验证:查询时间<2秒
   
3. **WebSocket并发测试**:
   - 测试场景:100个并发连接
   - 验证:所有连接稳定,消息无丢失
   
4. **缓存命中率测试**:
   - 测试场景:重复查询常用数据
   - 验证:缓存命中率>80%
   
5. **数据契约验证测试**:
   - 测试数据:各类型实体样本
   - 验证:所有实体符合契约规范

### 9.3 性能要求

| 指标 | 目标值 | 测试条件 |
|-----|-------|---------|
| 地图初始渲染时间 | < 2秒 | 100个要素 |
| 实时更新延迟 | < 100ms | 30台设备同时更新 |
| 历史轨迹查询 | < 2秒 | 1周数据(~10000点) |
| 轨迹回放帧率 | > 60fps | 1000点轨迹 |
| 并发用户支持 | 100人 | 同时在线 |
| WebSocket连接稳定性 | > 99.9% | 连续运行24小时 |
| 前端内存占用 | < 200MB | 运行1小时后 |
| 后端CPU占用 | < 50% | 100并发用户 |

### 9.4 测试工具和命令

#### 前端测试

```bash
# 单元测试
npm run test

# 单元测试(监听模式)
npm run test:watch

# 覆盖率报告
npm run test:coverage

# 组件测试
npm run test:components

# 性能测试(可选)
npm run test:performance
```

#### 后端测试

```bash
# 单元测试
pytest

# 单元测试(详细输出)
pytest -v

# 覆盖率报告
pytest --cov=app --cov-report=html

# API测试
pytest tests/test_api/

# 性能测试
pytest tests/test_performance/ --benchmark
```

---

## 10. 部署要求

### 10.1 Docker 部署

**要求**:
- ✅ 提供前端 Dockerfile
- ✅ 提供后端 Dockerfile
- ✅ 提供 docker-compose.yml (开发环境)
- ✅ 提供 docker-compose.prod.yml (生产环境)
- ✅ 暴露端口:前端5173(开发)/80(生产),后端8000
- ✅ 健康检查端点:/health

#### 前端 Dockerfile 示例

```dockerfile
# 多阶段构建
FROM node:20-alpine AS build

WORKDIR /app
COPY package*.json ./
RUN npm ci
COPY . .
RUN npm run build

# 生产镜像
FROM nginx:alpine
COPY --from=build /app/dist /usr/share/nginx/html
COPY docker/nginx.conf /etc/nginx/conf.d/default.conf
EXPOSE 80
CMD ["nginx", "-g", "daemon off;"]
```

#### 后端 Dockerfile 示例

```dockerfile
FROM python:3.11-slim

WORKDIR /app
COPY requirements.txt .
RUN pip install --no-cache-dir -r requirements.txt

COPY . .
EXPOSE 8000

# 健康检查
HEALTHCHECK --interval=30s --timeout=10s --retries=3 \
  CMD curl -f http://localhost:8000/health || exit 1

CMD ["uvicorn", "app.main:app", "--host", "0.0.0.0", "--port", "8000"]
```

#### docker-compose.yml 示例

```yaml
version: '3.8'

services:
  frontend:
    build:
      context: ./frontend
      dockerfile: ../docker/frontend.Dockerfile
    ports:
      - "5173:5173"
    volumes:
      - ./frontend:/app
      - /app/node_modules
    environment:
      - VITE_API_BASE_URL=http://localhost:8000
      - VITE_WS_URL=ws://localhost:8000/ws
    depends_on:
      - backend

  backend:
    build:
      context: ./backend
      dockerfile: ../docker/backend.Dockerfile
    ports:
      - "8000:8000"
    volumes:
      - ./backend:/app
    environment:
      - NGSI_LD_ENDPOINT=${NGSI_LD_ENDPOINT}
      - REDIS_HOST=redis
      - LOG_LEVEL=INFO
    depends_on:
      - redis

  redis:
    image: redis:7-alpine
    ports:
      - "6379:6379"
    volumes:
      - redis-data:/data

volumes:
  redis-data:
```

### 10.2 配置管理

**环境变量** (.env文件):

```bash
# 前端环境变量
VITE_API_BASE_URL=http://localhost:8000
VITE_WS_URL=ws://localhost:8000/ws
VITE_MAP_CENTER_X=0
VITE_MAP_CENTER_Y=0
VITE_MAP_ZOOM=15

# 后端环境变量
# 数据源配置
NGSI_LD_ENDPOINT=http://mockserver:9090/ngsi-ld/v1
NGSI_LD_CONTEXT=https://example.com/contexts/production-context.jsonld

# 缓存配置
REDIS_HOST=localhost
REDIS_PORT=6379
REDIS_DB=0
CACHE_TTL=300

# WebSocket配置
WS_HEARTBEAT_INTERVAL=30
WS_MAX_CONNECTIONS=100

# 日志配置
LOG_LEVEL=INFO
LOG_FILE=/var/log/map-backend.log

# CORS配置
CORS_ORIGINS=["http://localhost:5173", "http://localhost:3000"]

# 性能配置
MAX_WORKERS=4
QUERY_TIMEOUT=30
```

### 10.3 部署检查清单

部署前检查:
- [ ] 所有环境变量正确配置
- [ ] Docker镜像构建成功
- [ ] 前后端可独立启动
- [ ] Redis连接正常
- [ ] NGSI-LD端点可访问
- [ ] WebSocket连接正常
- [ ] 健康检查端点响应正常

部署后验证:
- [ ] 前端页面可正常访问
- [ ] 地图正确渲染
- [ ] 实时数据正常更新
- [ ] API接口响应正常
- [ ] WebSocket连接稳定
- [ ] 日志正常输出
- [ ] 性能指标达标

---

## 11. 文档交付要求

### 11.1 必须提供的文档

- [ ] **README.md** - 项目说明、快速开始
- [ ] **API_REFERENCE.md** - API接口文档
- [ ] **DEVELOPMENT_GUIDE.md** - 开发指南
- [ ] **DEPLOYMENT_GUIDE.md** - 部署指南
- [ ] **USER_MANUAL.md** - 用户手册(可选)

### 11.2 README.md 必须包含

```markdown
# 产线2D地图系统

## 项目简介
基于OpenLayers的侧墙产线数字孪生2D地图系统,提供实时监控、历史回放、路径分析等功能。

## 快速开始

### 开发环境启动
\`\`\`bash
# 启动所有服务
docker-compose up

# 前端: http://localhost:5173
# 后端: http://localhost:8000
# API文档: http://localhost:8000/docs
\`\`\`

### 手动启动

#### 前端
\`\`\`bash
cd frontend
npm install
npm run dev
\`\`\`

#### 后端
\`\`\`bash
cd backend
pip install -r requirements.txt
uvicorn app.main:app --reload
\`\`\`

## 功能特性
- ✅ 产线矢量地图渲染
- ✅ 实时设备/在制品/人员追踪
- ✅ 历史轨迹回放
- ✅ 专属视图(Flow/Quality/Efficiency)
- ✅ Spaghetti图分析
- ✅ 路径优化建议
- ✅ 热力图分析

## 技术栈
- 前端: React + TypeScript + OpenLayers + ECharts
- 后端: Python + FastAPI + Redis
- 数据契约: NGSI-LD

## 项目结构
[目录结构说明]

## API 文档
详见 [API_REFERENCE.md](./docs/API_REFERENCE.md)

## 开发指南
详见 [DEVELOPMENT_GUIDE.md](./docs/DEVELOPMENT_GUIDE.md)

## 部署指南
详见 [DEPLOYMENT_GUIDE.md](./docs/DEPLOYMENT_GUIDE.md)

## 测试
\`\`\`bash
# 前端测试
cd frontend && npm run test

# 后端测试
cd backend && pytest
\`\`\`

## 许可证
[许可证信息]
```

### 11.3 API_REFERENCE.md 必须包含

- 所有API端点的完整说明
- 请求/响应示例
- 错误码定义
- WebSocket协议说明
- 数据契约映射关系

### 11.4 DEVELOPMENT_GUIDE.md 必须包含

- 开发环境搭建
- 代码规范
- Git工作流
- 调试技巧
- 常见问题解答

---

## 12. 最终验收标准 ⭐

### 12.1 功能验收

**Phase 1 验收**:
- [ ] 地图正确渲染产线布局
- [ ] 坐标转换精度测试通过
- [ ] 多图层管理功能正常
- [ ] 6个KPI指标正确显示
- [ ] 基础交互流畅(缩放/平移)

**Phase 2 验收**:
- [ ] 30台设备实时状态监控正常
- [ ] 40个在制品实时追踪流畅
- [ ] 20名人员定位准确
- [ ] 要素详情弹窗功能完整
- [ ] 数据筛选查询准确
- [ ] WebSocket连接稳定

**Phase 3 验收**:
- [ ] 历史轨迹查询准确快速(1周数据<2秒)
- [ ] 轨迹回放动画流畅(>60fps)
- [ ] 时间轴控件所有按钮功能正常
- [ ] 多对象同步回放正确

**Phase 4 验收**:
- [ ] 4个专属视图过滤逻辑正确
- [ ] Spaghetti图渲染流畅(1000条路径)
- [ ] 路径优化建议合理
- [ ] 热力图展示正确
- [ ] 地图标注功能完整

### 12.2 质量验收

- [ ] 前端单元测试覆盖率>70%
- [ ] 后端单元测试覆盖率>80%
- [ ] 所有关键场景测试通过
- [ ] 性能指标全部达标
- [ ] 数据契约验证100%通过
- [ ] 代码review无严重问题
- [ ] 无内存泄漏

### 12.3 交付验收

- [ ] Docker镜像构建成功
- [ ] docker-compose一键启动正常
- [ ] 前后端容器健康检查通过
- [ ] 所有文档完整清晰
- [ ] API文档准确完整
- [ ] README可指导快速上手

### 12.4 性能验收

- [ ] 100并发用户压力测试通过
- [ ] 地图初始渲染<2秒
- [ ] 实时更新延迟<100ms
- [ ] 历史查询1周数据<2秒
- [ ] 轨迹回放帧率>60fps
- [ ] WebSocket连接稳定性>99.9%
- [ ] 前端内存占用<200MB(运行1小时)
- [ ] 后端CPU占用<50%(100并发)

---

## 附录A: 开发过程中的Mock策略

### A.1 前端Mock策略

**目的**: 支撑前端独立开发,不依赖后端服务

**实现方式**:
1. **Mock Service Worker (MSW)** 或 **Mirage.js**
2. 拦截HTTP请求,返回模拟数据
3. Mock WebSocket连接,模拟实时推送

**Mock数据生成**:
```typescript
// frontend/src/mocks/data-generator.ts
export function generateMockEquipments(count: number) {
  return Array.from({ length: count }, (_, i) => ({
    id: `urn:ngsi-ld:TwinObject:Robot:RBT-${i+1:02d}`,
    type: 'Robot',
    name: `焊接机器人${i+1}`,
    location: { 
      type: 'Point', 
      coordinates: [Math.random() * 100, Math.random() * 100] 
    },
    status: ['Running', 'Idle', 'Fault'][Math.floor(Math.random() * 3)],
    observedAt: new Date().toISOString()
  }));
}
```

### A.2 后端Mock策略

**目的**: 在Mockserver不可用时,后端可独立测试

**实现方式**:
1. 创建 `MockNGSIClient` 类,实现与 `NGSIClient` 相同接口
2. 返回预定义的测试数据
3. 通过环境变量 `USE_MOCK_DATA=true` 切换

**示例**:
```python
# backend/app/core/mock_ngsi_client.py
class MockNGSIClient:
    def get_entity(self, entity_id: str):
        # 返回Mock数据
        return {
            "id": entity_id,
            "type": "Robot",
            # ...
        }
```

### A.3 Mock数据与真实数据的切换

**配置方式**:
```typescript
// frontend/src/config/api-config.ts
export const API_CONFIG = {
  useMock: import.meta.env.VITE_USE_MOCK === 'true',
  baseURL: import.meta.env.VITE_API_BASE_URL,
  wsURL: import.meta.env.VITE_WS_URL
};
```

---

## 附录B: 术语表

| 术语 | 说明 |
|-----|------|
| **OpenLayers** | 开源JavaScript地图库,用于渲染矢量和栅格地图 |
| **NGSI-LD** | 下一代服务接口-链接数据,数字孪生数据交换标准 |
| **GeoJSON** | 地理数据交换格式,基于JSON |
| **WebSocket** | 全双工通信协议,用于实时数据推送 |
| **Spaghetti图** | 物料流转路径综合可视化图,形似意大利面 |
| **OEE** | 综合设备效率(Overall Equipment Effectiveness) |
| **KPI** | 关键绩效指标(Key Performance Indicator) |
| **WIP** | 在制品(Work In Progress) |
| **CT** | 节拍时间(Cycle Time) |
| **FPY** | 首次通过率(First Pass Yield) |
| **OTD** | 准时交付率(On-Time Delivery) |
| **Temporal Query** | NGSI-LD时间序列查询 |
| **proj4** | 投影转换JavaScript库 |
| **MapV** | 百度开源的地理可视化库 |
| **postrender** | OpenLayers渲染完成后事件 |

---

## 附录C: 参考资料

1. **数字孪生项目数据契约**(9个文档)
   - 00_总契约.md
   - 01_TwinObject契约.md
   - 02_MBOM契约.md
   - 03_Scene契约.md
   - 04_Modality契约.md
   - 05_ModalityBinding契约.md
   - 06_ModalData契约.md
   - 07_Role契约.md
   - 08_Assignment契约.md

2. **NGSI-LD 技术规范**
   - ETSI GS CIM 009: NGSI-LD API Specification
   - 04数字孪生平台数据服务接口技术规范_NGSI-LD.md

3. **OpenLayers 官方文档**
   - https://openlayers.org/
   - 坐标投影: https://openlayers.org/en/latest/doc/tutorials/concepts.html#projections
   - 矢量图层: https://openlayers.org/en/latest/examples/vector-layer.html
   - 交互控件: https://openlayers.org/en/latest/apidoc/module-ol_interaction.html

4. **前期技术方案**
   - 基于OpenLayers的车间生产数据地图技术方案.pdf
   - 产线2D数字地图页面截图.png

5. **相关开源库**
   - proj4: https://github.com/proj4js/proj4js
   - ECharts: https://echarts.apache.org/
   - MapV: https://github.com/huiyan-fe/mapv
   - Turf.js: https://turfjs.org/ (几何计算)

---

## 给 Claude Code 的开发指引

### 开发流程

```
1. 阅读本技术规格书,理解功能边界和数据契约约束
2. 确认所有依赖文件已上传(9个契约文档 + 2个前期成果)
3. 搭建项目脚手架(Phase 1, T1.1)
4. 按照 Phase 1 → Phase 2 → Phase 3 → Phase 4 顺序逐步开发
5. 每个 Phase 完成后,对照验收标准自检
6. 所有 Phase 完成后,进行最终验收
```

### 自主决策权

**Claude Code 可以自主决定**:
- ✅ 代码结构和模块划分的具体实现
- ✅ 类、函数、变量的命名和设计
- ✅ 算法和数据结构的具体选择
- ✅ 性能优化的具体方法
- ✅ 样式和UI细节的实现(遵循整体风格)

**Claude Code 必须遵守**:
- ⚠️ 第1章的功能边界(实现什么,不实现什么)
- ⚠️ 第2章的数据契约约束(NGSI-LD规范)
- ⚠️ 第4章的接口规范(API格式、WebSocket协议)
- ⚠️ 第5章的技术栈要求(React、OpenLayers、FastAPI等)
- ⚠️ 第7章的开发Phase划分
- ⚠️ 第12章的验收标准(功能、质量、性能)

### 遇到问题时

如果遇到规格书中未明确的问题:
1. **优先遵守数据契约** - 所有数据交互必须符合NGSI-LD契约
2. **参考前期成果** - 页面截图和技术方案提供了设计参考
3. **参考OpenLayers官方文档** - 地图功能的最佳实践
4. **选择最简单可行的方案** - 优先实现功能,再优化
5. **确保可测试性** - 所有功能必须可测试和验证

### 关键注意事项

1. **坐标转换**: 这是核心难点,必须优先实现并充分测试
2. **性能优化**: 100并发用户是硬性要求,需要关注性能
3. **WebSocket稳定性**: 实时监控的基础,必须保证连接稳定
4. **数据契约遵从**: 所有与平台交互必须符合契约,否则集成失败
5. **只读访问**: 不允许修改平台数据,所有写操作都在本地

### 开发建议

1. **Phase 1优先**: 坐标转换和地图渲染是基础,必须先打牢
2. **前后端并行**: Phase 1完成后,前端可使用Mock独立开发
3. **增量测试**: 每完成一个功能,立即编写测试
4. **性能关注**: 从一开始就关注性能,不要等到最后优化
5. **文档同步**: 边开发边更新README和API文档

---

**祝开发顺利!** 🚀

---

**文档版本**: v1.0.0  
**最后更新**: 2025-11-12

---

## 13. 开发实施规划

### 13.1 总体原则
- **阶段推进**: 严格按照 Phase1 → Phase4 顺序执行,未完成上一阶段验收不得进入下一阶段。
- **技术栈合规**: 前端 React18 + TypeScript + Vite + OpenLayers9 + proj4 + ECharts/MapV + Zustand/React Query; 后端 FastAPI + Redis + httpx + Pydantic; 全程遵循 NGSI-LD 契约。
- **数据规范**: 所有实体使用 URN、@context 与 ISO8601, Relationship 通过 object 字段解析,仅允许只读访问数字孪生平台。
- **Mock 至真实**: 先以 Mock 数据(前端 MSW, 后端 MockNGSIClient) 保证开发连续性,再切换 Mockserver,最终对接生产 NGSI-LD。
- **质量保障**: 每阶段完成时必须通过 Lint/Test/性能指标与文档自检,CI 持续运行 npm/vitest 与 pytest。

### 13.2 目录与脚手架
```
production-line-map/
├── frontend/  # React + OpenLayers
├── backend/   # FastAPI
├── shared/    # 契约/类型/工具
├── docs/      # README, API_REFERENCE, DEVELOPMENT_GUIDE, DEPLOYMENT_GUIDE, USER_MANUAL
├── docker/    # 前后端 Dockerfile, nginx.conf
├── docker-compose.yml / docker-compose.prod.yml
├── scripts/   # build/deploy/test 脚本
└── README.md
```
- 采用 Git Flow(主干/main + develop + feature/*), 所有 PR 需通过 Lint/Test。
- CI(例如 GitHub Actions) 执行 `npm run lint && npm run test`, `pytest`, `docker build`。

### 13.3 Phase 1 (基础地图渲染, 60h)
| 编号 | 任务 | 关键点 | 验收 |
| --- | --- | --- | --- |
| T1.1 | 脚手架搭建 | Vite+TS、FastAPI、共享类型、ESLint/Prettier、Vitest/Pytest、Dockerfile | `npm run dev`/`uvicorn` 可启动且 lint/test 全绿 |
| T1.2 | 坐标系实现 | `proj4` 定义 EPSG:10001, 注册 OpenLayers, `transformWorkshopToMap/from` 工具, Vitest 精度<1cm | 正/逆/往返测试<1cm, 1000 次转换<10ms |
| T1.3 | 产线底图 | `MapContainer` 初始化 OpenLayers, 加载 GeoJSON, 样式/交互控件完善 | 地图渲染正确、初始视角居中、缩放平移 60fps |
| T1.4 | 多图层管理 | 建立底图/设备/WIP/人员/路径/标注等 VectorLayer, Zustand 控制可见性与 zIndex | 至少 6 层可独立开关, 顺序可配置 |
| T1.5 | KPI 指标栏 | `KPIBar` + 阈值颜色 + 趋势弹窗占位, 数据来自 Mock API | 6 项指标实时展示, 1~5 分钟刷新, 点击弹窗 |
| T1.6 | Mock 数据体系 | 前端 MSW/Mirage, 后端 MockNGSIClient, `shared/api-contracts` 定义契约 | Mock 开关生效, 字段与 NGSI-LD 完整匹配 |

### 13.4 Phase 2 (实时监控, 70h)
| 编号 | 任务 | 关键点 | 验收 |
| --- | --- | --- | --- |
| T2.1 | WebSocket 管理 | FastAPI WS + 心跳/断线重连/消息队列, 前端服务 Hook | 自动重连, 30s ping/pong, 100 并发稳定 |
| T2.2 | 设备状态层 | 实时位置/状态更新, 故障闪烁, 图标差异化 | 30 台设备状态延迟<100ms, 故障明显提示 |
| T2.3 | 在制品/人员追踪 | 动态要素更新, 插值动画, 标签信息 | 40 个在制 +20 人流畅展示, 轨迹平滑 |
| T2.4 | 要素详情弹窗 | `FeaturePopup` + 数据缓存, 支持设备/工件/人员 | 点击 500ms 内显示, 锚点正确, 多级信息 |
| T2.5 | 筛选与查询 | FilterPanel + `MapInstance.queryFeatures`, 状态与区域过滤 | 多条件组合<100ms, 结果计数, 支持反选 |
| T2.6 | 性能调优 | 批量更新, 防抖/节流, 虚拟滚动 | 压测(30×1Hz×100用户) CPU<50%, 无掉帧 |
| T2.7 | 集成测试 | 前后端/WS 端到端测试脚本 | 关键流程覆盖, 报告通过 |

### 13.5 Phase 3 (历史回放, 70h)
| 编号 | 任务 | 关键点 | 验收 |
| --- | --- | --- | --- |
| T3.1 | Temporal Query 封装 | `TrajectoryService` 调 NGSI-LD `/temporal/entities`, 支持分页/attrs/缓存 | 1 周数据<2s, 多对象查询, 异常处理完善 |
| T3.2 | 数据处理 | shared 工具实现插值、Douglas-Peucker、速度计算, 单测覆盖 | 点数减少≥50%, 误差可控 |
| T3.3 | 轨迹回放引擎 | `TrajectoryPlayer` + postrender/requestAnimationFrame, 拖尾/速度控制 | 动画>60fps, 支持暂停/恢复/多对象 |
| T3.4 | 时间轴控件 | 播放/暂停/快进/快退/循环/截图 + 快捷键 | 所有按钮与快捷键有效, 拖动即时跳转 |
| T3.5 | 多对象同步 | 管理多轨迹状态、缓冲与渲染 | 5 个对象同步回放无卡顿 |
| T3.6 | 性能优化 | 1000 点轨迹加载<3s, 内存稳定 | 性能报告通过 |
| T3.7 | 功能测试 | 回放相关端到端测试 | 用户体验评审通过 |

### 13.6 Phase 4 (高级分析, 80-100h)
| 编号 | 任务 | 关键点 | 验收 |
| --- | --- | --- | --- |
| T4.1 | Flow 视图 | WIP/CT/OEE 瓶颈算法, 过滤与高亮 | 判定准确, 切换<200ms, 视图状态可保存 |
| T4.2 | Quality 视图 | 24h 不良率计算, 异常设备标识 | 异常高亮, 提供原因入口 |
| T4.3 | Efficiency 视图 | OEE 对标, 低效工位过滤 | OEE 计算误差<2%, 橙色提示 |
| T4.4 | Spaghetti 图 | ECharts lines + OpenLayers, 支持频次/单轨模式 | 1000 条路径流畅, 点击显示统计 |
| T4.5 | 路径优化分析 | 路径密度, Dijkstra 算法, 建议输出与对比 | 建议合理(人工评审), 提供定量对比 |
| T4.6 | OEE 热力图 | MapV 图层, 时间范围切换 | 渲染<500ms, 着色准确 |
| T4.7 | 多类型热力图 | 人员/报警/WIP 热力层, 透明度可调 | 1000 点<500ms |
| T4.8 | 地图标注与编辑 | Draw/Modify/Delete, 样式配置, IndexedDB/后端持久化, GeoJSON 导入导出 | 绘制流畅, 保存/恢复成功, 支持协作 |
| T4.9 | 导出功能 | 地图截图、数据报表导出 | 文件正确, 截图与当前视图一致 |
| T4.10 | 全面性能优化 | 懒加载、虚拟化、Memo、压测脚本 | 大数据场景不卡顿, 指标达标 |
| T4.11 | 文档完善 | README、API_REFERENCE、DEVELOPMENT_GUIDE、DEPLOYMENT_GUIDE、USER_MANUAL | 文档完整且可独立交付 |
| T4.12 | 容器化与部署 | 前后端镜像, docker-compose.prod, /health, 可配置环境变量 | 一键启动, 健康检查通过, 配置可变 |

### 13.7 共性保障
- **契约管理**: 9 份数据契约同步至 `shared/contracts`, 通过 JSON Schema + TypeScript 类型在前后端共用。
- **Mock 切换**: `VITE_USE_MOCK`、`USE_MOCK_DATA` 控制, 提供 Mock 数据生成脚本, 同时记录与真实接口差异。
- **测试指标**: 前端单测覆盖率 ≥70%, 后端 ≥80%, 性能指标(渲染时间、WebSocket RTT、查询耗时)需持续记录。
- **日志与监控**: 后端输出结构化日志与耗时统计, 可选接入 Prometheus/Grafana。
- **阶段验收**: 每阶段输出验收报告(功能/质量/性能/文档), 通过后方可进入下一阶段。

### 13.8 里程碑
1. **M1 (Phase1 完成)**: 地图渲染、坐标转换、Mock 数据、KPI 组件、文档初稿。
2. **M2 (Phase2 完成)**: 实时监控与 WebSocket 稳定、要素弹窗、筛选、性能测试报告。
3. **M3 (Phase3 完成)**: 历史轨迹查询/回放、时间轴控件、相关测试报告。
4. **M4 (Phase4 完成)**: 专属视图、Spaghetti、路径优化、热力图、标注、导出、最终文档/部署闭环。

该规划覆盖从目录搭建、阶段任务到验收指标的完整落地路径, 可直接指导团队按技术规格书要求完成开发。

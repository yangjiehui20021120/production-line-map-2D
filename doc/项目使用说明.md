# 产线2D地图系统 - 功能与数据流说明

**当前系统实现状态说明**

---

## 一、功能模块总览

| 模块 | 功能说明 | 状态 |
|------|---------|------|
| **实况监控** | 实时展示设备、在制品、人员状态 | ✅ 已实现 |
| **历史回放** | 回放历史轨迹数据 | ✅ 已实现 |
| **路线仿真** | 生产路线仿真分析 | 🚧 开发中 |

---

## 二、前端功能 → 后端API → 数据源对应表

### 2.1 KPI看板功能

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| KPI看板展示（6个核心指标） | `GET /api/v1/map/kpi` | mock_realtime_service静态数据<br/>（工位/设备/在制品数据） | **kpi_service**<br/>基于Mock数据计算6个KPI指标 |

**数据流**：
前端请求KPI → 后端读取Mock数据 → 计算6个指标 → 返回给前端 → 显示在页面上

---

### 2.2 地图底图加载

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| 产线底图展示（工位、区域、路径） | `GET /api/v1/map/basemap` | `backend/data/basemap/production-line.geojson`<br/>（静态GeoJSON文件） | **map_service**<br/>读取并返回GeoJSON数据 |

**OpenLayers使用说明**：
- OpenLayers是地图渲染引擎，负责将GeoJSON数据转换为可视化地图
- 支持地图缩放、平移、图层控制等交互功能

**数据流**：
前端请求地图 → 后端读取地图文件 → 返回地图数据 → 前端显示地图

---

### 2.3 实时实体数据（初始加载）

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| 设备/在制品/人员初始数据 | `GET /api/v1/realtime/entities` | mock_realtime_service静态数据<br/>（EQUIPMENT_DATA/WORKPIECE_DATA/PERSONNEL_DATA） | **mock_realtime_service**<br/>返回设备/在制品/人员列表 |

**数据流**：
前端请求实体数据 → 后端读取Mock数据 → 返回设备/在制品/人员列表 → 前端在地图上显示标记点

---

### 2.4 实时数据推送（WebSocket）

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| 实时数据自动更新（设备状态、在制品位置、人员位置） | `WS /api/v1/realtime/ws` | websocket_routes定时生成Mock更新<br/>每2秒推送一次 | **websocket_routes**<br/>WebSocket服务，持续推送更新 |

**数据流**：
websocketService建立连接 → 后端websocket_routes每2秒生成Mock更新 → 自动推送 → websocketService接收 → 更新realtimeStore → MapContainer使用OpenLayers刷新标记点位置

**OpenLayers使用说明**：
- 使用OpenLayers实时更新标记点的坐标位置和样式
- 支持平滑的位置移动动画

**WebSocket作用**：
- 后端主动推送，无需前端轮询
- 实现实时数据自动更新

---

### 2.5 Flow流动视图

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| 瓶颈工位识别（高亮显示瓶颈工位） | `GET /api/v1/analysis/bottlenecks` | mock_realtime_service工位数据<br/>（STATION_DATA） | **analysis_service**<br/>分析WIP数量和CT时间，识别瓶颈 |

**数据流**：
用户点击Flow视图 → Sidebar触发切换 → MapContainer调用analysisService → 后端analysis_service分析Mock工位数据 → 返回瓶颈列表 → MapContainer使用OpenLayers高亮显示瓶颈工位

**OpenLayers使用说明**：
- 使用OpenLayers的Style样式系统高亮显示瓶颈工位
- 支持不同颜色和图标区分瓶颈严重程度

---

### 2.6 Quality质量视图

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| 质量问题设备识别（高亮显示缺陷率超标的设备） | `GET /api/v1/analysis/quality-issues` | mock_realtime_service设备数据<br/>（EQUIPMENT_DATA） | **analysis_service**<br/>分析设备缺陷率，识别质量问题 |

**数据流**：
用户点击Quality视图 → Sidebar触发切换 → MapContainer调用analysisService → 后端analysis_service分析Mock设备数据 → 返回问题设备列表 → MapContainer使用OpenLayers高亮显示问题设备

**OpenLayers使用说明**：
- 使用OpenLayers的CircleStyle和Text样式显示质量问题设备
- 支持显示缺陷率标签和返工路径

---

### 2.7 Efficiency效率视图

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| 低效率工位识别（高亮显示OEE低于目标的工位） | `GET /api/v1/analysis/efficiency-issues` | mock_realtime_service工位数据<br/>（STATION_DATA） | **analysis_service**<br/>分析工位OEE，识别低效率工位 |

**数据流**：
用户点击Efficiency视图 → Sidebar触发切换 → MapContainer调用analysisService → 后端analysis_service分析Mock工位数据 → 返回低效率工位列表 → MapContainer使用OpenLayers高亮显示低效率工位

**OpenLayers使用说明**：
- 使用OpenLayers的Style样式显示OEE指标和效率问题
- 支持显示OEE数值标签

---

### 2.8 Spaghetti意面图视图

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| 物流路径统计分析（显示物料流转路径和频率） | `GET /api/v1/analysis/spaghetti-paths?hours=24` | mock_realtime_service路径数据<br/>（SPAGHETTI_PATH_DATA） | **analysis_service**<br/>统计路径频率和热点 |

**数据流**：
用户点击Spaghetti视图 → Sidebar触发切换 → MapContainer调用analysisService → 后端analysis_service统计Mock路径数据 → 返回路径统计结果 → MapContainer使用OpenLayers显示路径热力图

**OpenLayers使用说明**：
- 使用OpenLayers的LineString几何类型绘制路径线条
- 使用不同颜色和粗细表示路径频率
- 支持路径热力图可视化

---

### 2.9 历史轨迹搜索

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| 搜索可回放的轨迹（按实体类型和时间范围） | `GET /api/v1/trajectory/search?entityType=workpiece&start=...&end=...` | `test-data/trajectory_7days_sample.json`<br/>（静态JSON文件） | **trajectory_service**<br/>从JSON文件查询符合条件的轨迹实体 |

**数据流**：
用户在TimelinePanel输入搜索条件 → trajectoryService调用API → 后端trajectory_service从JSON文件查询 → 返回轨迹列表 → TimelinePanel显示搜索结果

---

### 2.10 历史轨迹详情加载

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| 加载轨迹点数据（用于播放动画） | `GET /api/v1/trajectory/{entityId}?start=...&end=...&max_points=500` | `test-data/trajectory_7days_sample.json`<br/>（静态JSON文件） | **trajectory_service**<br/>从JSON文件加载轨迹点并采样 |

**数据流**：
用户选择轨迹 → TimelinePanel调用trajectoryService → 后端trajectory_service从JSON文件加载轨迹点 → 返回轨迹点数据 → MapContainer使用OpenLayers播放轨迹动画，TimelinePanel显示时间轴

**OpenLayers使用说明**：
- 使用OpenLayers的LineString几何类型绘制轨迹路径
- 使用requestAnimationFrame实现流畅的轨迹播放动画
- 支持播放/暂停/快进控制

---

## 三、后端服务说明

### 3.1 核心业务服务

| 服务名称 | 主要职责 | 数据来源 |
|---------|---------|---------|
| **kpi_service** | 计算6个核心KPI指标 | mock_realtime_service静态数据 |
| **map_service** | 提供产线底图数据 | GeoJSON文件 |
| **mock_realtime_service** | 提供实时实体数据 | Python代码中的静态数据 |
| **analysis_service** | 分析瓶颈/质量/效率问题 | mock_realtime_service数据 |
| **trajectory_service** | 提供历史轨迹数据 | JSON轨迹文件 |

### 3.2 数据服务

| 服务名称 | 主要职责 | 数据来源 |
|---------|---------|---------|
| **mock_ngsi_service** | Mock NGSI-LD数据服务 | `backend/data/entities/*.json`<br/>（支持Redis缓存） |
| **entity_service** | 实体查询服务（统一接口） | mock_ngsi_service（当前） |

### 3.3 缓存服务

**cache_service**（Redis缓存服务）
- **作用**：提供Redis缓存功能，加速数据访问
- **使用场景**：缓存mock_ngsi_service加载的实体数据（TwinObject、MBOM、Scene等）
  - **缓存策略**：首次从JSON文件加载后缓存到Redis，24小时过期；后续请求优先从Redis读取
- **配置**：通过`USE_REDIS_CACHE`配置项控制是否启用（默认启用）

### 3.4 特殊服务

**websocket_routes**（WebSocket服务）
- **作用**：实现实时数据自动更新，无需前端轮询
- **数据来源**：每2秒调用`mock_realtime_service.generate_updates()`生成Mock更新
- **推送方式**：通过WebSocket推送给所有连接的客户端

---

## 四、数据源总览

### 4.1 Mock数据文件

| 数据类型 | 文件位置 | 用途 |
|---------|---------|------|
| 实时实体数据 | Python代码中的静态数据<br/>（mock_realtime_service） | 设备/在制品/人员实时数据 |
| NGSI-LD实体数据 | `backend/data/entities/*.json` | TwinObject/MBOM/Scene等实体 |
| 产线底图 | `backend/data/basemap/production-line.geojson` | 地图底图GeoJSON |
| 历史轨迹 | `test-data/trajectory_7days_sample.json` | 历史轨迹回放数据 |

### 4.2 数据服务说明

- **mock_realtime_service**：提供设备、在制品、人员的实时数据（Python静态数据）
- **mock_ngsi_service**：提供NGSI-LD格式的实体数据（JSON文件，支持Redis缓存）
- **map_service**：提供产线底图GeoJSON数据
- **trajectory_service**：提供历史轨迹数据（JSON文件）
- **cache_service**：Redis缓存服务，用于缓存实体数据，提高访问性能

---

## 五、数据流向

**普通请求流程**：
```
用户操作 → 前端请求 → 后端读取Mock数据 → 返回数据 → 前端显示
```

**WebSocket推送流程**：
```
后端每2秒生成Mock更新 → 自动推送给前端 → 前端更新地图
```

---

## 六、功能-API-数据源快速对照表

| 前端功能 | 后端API | 数据来源 | 后端服务 |
|---------|--------|---------|---------|
| KPI看板 | `/api/v1/map/kpi` | mock_realtime_service静态数据 | kpi_service |
| 地图底图 | `/api/v1/map/basemap` | GeoJSON文件 | map_service |
| 实时实体 | `/api/v1/realtime/entities` | mock_realtime_service静态数据 | mock_realtime_service |
| 实时推送 | `WS /api/v1/realtime/ws` | 定时生成Mock更新 | websocket_routes |
| Flow视图 | `/api/v1/analysis/bottlenecks` | mock_realtime_service工位数据 | analysis_service |
| Quality视图 | `/api/v1/analysis/quality-issues` | mock_realtime_service设备数据 | analysis_service |
| Efficiency视图 | `/api/v1/analysis/efficiency-issues` | mock_realtime_service工位数据 | analysis_service |
| Spaghetti视图 | `/api/v1/analysis/spaghetti-paths` | mock_realtime_service路径数据 | analysis_service |
| 轨迹搜索 | `/api/v1/trajectory/search` | JSON轨迹文件 | trajectory_service |
| 轨迹详情 | `/api/v1/trajectory/{entityId}` | JSON轨迹文件 | trajectory_service |

---

**文档版本**：v4.0  
**最后更新**：2025-11-30

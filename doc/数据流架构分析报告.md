# 数据流架构分析报告

## 一、当前数据流架构

### 1.1 架构图

```
┌─────────────────────────────────────────────────────────┐
│                      前端层 (Frontend)                    │
│  - MapContainer.tsx                                      │
│  - 实时数据展示、历史回放、分析视图                        │
└───────────────────────┬───────────────────────────────────┘
                        │ HTTP/WebSocket
                        │
┌───────────────────────┴───────────────────────────────────┐
│                   后端服务层 (Backend)                     │
│  ┌──────────────┐  ┌──────────────┐  ┌──────────────┐  │
│  │ EntityService│  │RealtimeService│  │TrajectorySvc │  │
│  └──────┬───────┘  └──────┬───────┘  └──────┬───────┘  │
│         │                  │                  │          │
│  ┌──────┴──────────────────┴──────────────────┴──────┐  │
│  │           数据访问抽象层                              │  │
│  │  if USE_MOCK_DATA:                                  │  │
│  │    → MockNGSIService                               │  │
│  │  else:                                             │  │
│  │    → NGSIClient (占位符，未实现)                    │  │
│  └───────────────────────────────────────────────────┘  │
└───────────────────────┬───────────────────────────────────┘
                        │
        ┌───────────────┴───────────────┐
        │                               │
┌───────┴──────┐            ┌───────────┴──────────┐
│ Mock数据服务  │            │  NGSI-LD客户端       │
│ (当前使用)    │            │  (待实现)           │
│              │            │                      │
│ - JSON文件   │            │ - Context Broker     │
│ - 内存缓存   │            │ - Temporal API       │
│ - Redis缓存  │            │ - Subscription API   │
└──────────────┘            └──────────────────────┘
```

### 1.2 数据流路径

**当前实现（Mock模式）**：
```
Mock JSON文件 → MockNGSIService → EntityService → API路由 → 前端
```

**目标实现（生产环境）**：
```
T1管理平台 → NGSIClient → EntityService → API路由 → 前端
```

## 二、技术文档要求对比

### 2.1 接口协议要求

| 要求项 | 技术文档要求 | 当前实现状态 | 符合度 |
|--------|------------|------------|--------|
| **NGSI-LD标准** | 严格遵循ETSI NGSI-LD标准 | Mock服务模拟NGSI-LD格式 | ⚠️ 部分符合 |
| **只读访问** | 不允许修改/创建/删除实体 | ✅ 只读访问 | ✅ 符合 |
| **URN格式** | `urn:ngsi-ld:{EntityType}:{ID}` | ✅ Mock数据使用标准URN | ✅ 符合 |
| **@context处理** | 必须包含@context声明 | ✅ Mock数据包含@context | ✅ 符合 |
| **时间格式** | ISO 8601，带时区 | ✅ 使用ISO 8601格式 | ✅ 符合 |

### 2.2 核心API要求

| API端点 | 技术文档要求 | 当前实现 | 缺失功能 |
|---------|------------|---------|---------|
| **GET /entities/{entityId}** | 单实体查询 | ✅ MockNGSIService实现 | ❌ NGSIClient未实现 |
| **GET /entities** | 实体列表查询（支持q参数） | ✅ MockNGSIService实现（简化q语法） | ⚠️ NGSIClient未实现，q语法支持不完整 |
| **GET /temporal/entities/{entityId}** | 历史轨迹查询（timerel参数） | ❌ trajectory_service使用本地JSON | ❌ 完全缺失 |
| **POST /subscriptions** | 实时数据订阅 | ❌ WebSocket使用mock数据流 | ❌ 完全缺失 |
| **GET /entities/{entityId}/relationships** | 关系查询 | ✅ MockNGSIService实现 | ❌ NGSIClient未实现 |

### 2.3 数据契约要求

| 契约类型 | 技术文档要求 | 当前实现 | 符合度 |
|---------|------------|---------|--------|
| **TwinObject** | 11种子类型，location属性 | ✅ Mock数据包含所有子类型 | ✅ 符合 |
| **Scene** | sceneLevel、timeFrame、status | ✅ Mock数据包含Scene实体 | ✅ 符合 |
| **MBOM** | 4层工艺结构 | ✅ Mock数据包含MBOM实体 | ✅ 符合 |
| **ModalData** | 实时数据、observedAt | ✅ Mock数据包含ModalData | ✅ 符合 |
| **Modality/ModalityBinding** | 数据模态定义 | ✅ Mock数据包含 | ✅ 符合 |
| **Role/Assignment** | 角色和岗位指派 | ✅ Mock数据包含 | ✅ 符合 |

## 三、关键缺失功能分析

### 3.1 NGSI-LD客户端实现（ngsi_client.py）

**当前状态**：仅有方法签名，所有方法都是`pass`

**需要实现的核心方法**：
```python
✅ get_entity()              # 单实体查询
✅ query_entities()           # 实体列表查询
❌ query_temporal_entities() # 历史轨迹查询（缺失）
✅ subscribe_entities()       # 订阅（签名存在，但未实现）
✅ get_entity_relationships() # 关系查询
```

**缺失的Temporal API**：
- `GET /temporal/entities/{entityId}?timerel=between&timeAt=...&endTimeAt=...`
- 用于历史轨迹回放功能

### 3.2 服务层数据源切换

**当前问题**：

1. **trajectory_service.py**：
   - ❌ 直接读取本地JSON文件
   - ❌ 未通过NGSI-LD Temporal API查询
   - ❌ 无法切换到真实数据源

2. **kpi_service.py**：
   - ❌ 直接使用`mock_realtime_service`的静态数据
   - ❌ 未通过NGSI-LD查询ModalData和Scene实体
   - ❌ 无法切换到真实数据源

3. **analysis_service.py**：
   - ❌ 直接使用`mock_realtime_service`的静态数据
   - ❌ 未通过NGSI-LD查询TwinObject和ModalData
   - ❌ 无法切换到真实数据源

4. **realtime_service.py**：
   - ⚠️ 有NGSI客户端占位符，但未实现
   - ❌ 当前使用`mock_realtime_service`

### 3.3 WebSocket实时数据推送

**当前实现**：
- 使用`mock_realtime_service.generate_updates()`生成模拟数据
- 每2秒推送一次

**技术文档要求**：
- 通过NGSI-LD Subscription API订阅实体变更
- 接收Context Broker的变更通知
- 转发给前端WebSocket客户端

**缺失功能**：
- ❌ NGSI-LD订阅管理
- ❌ 变更通知接收和处理
- ❌ 订阅生命周期管理

## 四、替换为数字孪生客户端后的符合度评估

### 4.1 架构符合度：✅ **基本符合**

**优势**：
- ✅ 数据访问层已抽象（EntityService支持条件切换）
- ✅ Mock服务已模拟NGSI-LD格式，数据契约一致
- ✅ 前端接口保持不变，无需修改

**待完善**：
- ⚠️ NGSIClient需要完整实现
- ⚠️ 服务层需要重构以支持数据源切换

### 4.2 接口符合度：⚠️ **部分符合**

**符合项**：
- ✅ 单实体查询接口
- ✅ 实体列表查询接口（基础功能）
- ✅ 关系查询接口

**不符合项**：
- ❌ **历史轨迹查询**：未使用NGSI-LD Temporal API
- ❌ **实时订阅**：未使用NGSI-LD Subscription API
- ⚠️ **查询语法**：q参数支持不完整（仅支持简单相等查询）

### 4.3 数据契约符合度：✅ **完全符合**

- ✅ 所有实体类型符合契约定义
- ✅ URN格式标准
- ✅ @context处理正确
- ✅ 时间格式符合ISO 8601

### 4.4 功能完整性：⚠️ **部分缺失**

**完整功能**：
- ✅ 地图底图加载
- ✅ 实时实体展示（Mock模式）
- ✅ 实体查询和详情展示

**缺失功能**：
- ❌ **历史轨迹回放**：未使用Temporal API
- ❌ **实时数据推送**：未使用Subscription API
- ⚠️ **KPI计算**：未从NGSI-LD查询真实数据
- ⚠️ **分析视图**：未从NGSI-LD查询真实数据

## 五、关键改进建议

### 5.1 优先级P0（必须实现）

1. **实现NGSIClient核心方法**：
   ```python
   - get_entity()
   - query_entities()
   - query_temporal_entities()  # 新增，用于历史轨迹
   - get_entity_relationships()
   ```

2. **重构trajectory_service.py**：
   - 移除直接读取JSON文件的逻辑
   - 通过NGSIClient.query_temporal_entities()查询历史数据
   - 支持USE_MOCK_DATA切换

3. **实现NGSI-LD Subscription**：
   - 在NGSIClient中添加subscribe_entities()实现
   - 在WebSocket路由中集成订阅管理
   - 接收并转发变更通知

### 5.2 优先级P1（建议实现）

1. **重构kpi_service.py**：
   - 通过NGSI-LD查询ModalData和Scene实体
   - 支持USE_MOCK_DATA切换

2. **重构analysis_service.py**：
   - 通过NGSI-LD查询TwinObject和ModalData
   - 支持USE_MOCK_DATA切换

3. **完善查询语法支持**：
   - 支持复杂q参数（AND/OR逻辑）
   - 支持georel地理空间查询
   - 支持timerel时间范围查询

### 5.3 优先级P2（可选优化）

1. **缓存策略优化**：
   - 对NGSI-LD查询结果进行Redis缓存
   - 减少对Context Broker的请求压力

2. **错误处理和重试**：
   - NGSIClient连接失败重试
   - 降级到Mock数据（开发环境）

## 六、总结

### 6.1 当前状态

**数据流架构**：✅ 设计合理，支持条件切换
**数据契约**：✅ 完全符合技术文档要求
**接口实现**：⚠️ 部分缺失，特别是Temporal和Subscription API
**功能完整性**：⚠️ 核心功能完整，高级功能依赖Mock数据

### 6.2 替换可行性

**结论**：✅ **可以替换，但需要完成以下工作**

1. **必须完成**（P0）：
   - 实现NGSIClient核心方法
   - 实现Temporal API查询
   - 实现Subscription API订阅

2. **建议完成**（P1）：
   - 重构服务层以支持数据源切换
   - 完善查询语法支持

3. **可选优化**（P2）：
   - 缓存和性能优化
   - 错误处理增强

### 6.3 符合度评分

| 评估维度 | 评分 | 说明 |
|---------|------|------|
| **架构设计** | 9/10 | 抽象层设计良好，支持切换 |
| **数据契约** | 10/10 | 完全符合技术文档要求 |
| **接口实现** | 6/10 | 基础接口完整，高级接口缺失 |
| **功能完整性** | 7/10 | 核心功能完整，部分功能依赖Mock |
| **总体符合度** | **8/10** | **基本符合，需要补充实现** |

---

**报告生成时间**：2025-01-XX  
**分析依据**：
- `doc/T3_产线2D地图_技术规格书-V1_0.md`
- `shared/contracts/04数字孪生平台数据服务接口技术规范_NGSI-LD.md`
- 当前代码实现



# 前后端连接测试指南

## 一、环境准备

### 1.1 前端环境配置

前端已创建 `.env` 文件（如果被gitignore，需要手动创建）：

```env
# 禁用Mock模式，使用真实后端API
VITE_USE_MOCK=false

# API基础地址
VITE_API_BASE_URL=http://localhost:8000

# WebSocket地址
VITE_WS_URL=ws://localhost:8000/api/v1/realtime/ws
```

### 1.2 后端环境配置

后端配置（`backend/app/core/config.py`）：
- `USE_MOCK_DATA=True` - 使用Mock数据服务
- `API_V1_PREFIX="/api/v1"` - API前缀

## 二、启动服务

### 2.1 启动后端服务

```bash
cd backend

# 激活虚拟环境（如果使用）
# Windows PowerShell
.\.venv\Scripts\Activate.ps1
# Linux/Mac
source .venv/bin/activate

# 启动服务
uvicorn app.main:app --reload --host 0.0.0.0 --port 8000
```

服务启动后，访问：
- API文档: http://localhost:8000/docs
- 健康检查: http://localhost:8000/health

### 2.2 启动前端服务

```bash
cd frontend

# 安装依赖（如果需要）
npm install

# 启动开发服务器
npm run dev
```

前端服务通常在 http://localhost:5173

## 三、测试Mock数据服务

### 3.1 运行Mock服务测试

```bash
cd backend
python test_connection.py
```

测试内容：
- Mock NGSI服务数据加载
- 实体类型查询（TwinObject, MBOM, Scene等）
- 按ID获取实体
- Entity服务集成

### 3.2 运行API端点测试

**注意：需要先启动后端服务**

```bash
cd backend
python test_api.py
```

测试的API端点：
- `/health` - 健康检查
- `/api/v1/ping` - Ping端点
- `/api/v1/entities` - 实体查询
- `/api/v1/entities/{id}` - 获取单个实体
- `/api/v1/map/kpi` - KPI数据
- `/api/v1/realtime/entities` - 实时数据

## 四、测试结果

### 4.1 Mock服务测试结果

✅ **已通过测试：**
- 加载了3334个实体，涵盖8种类型
- TwinObject查询正常（Station, AutoEquipment等）
- MBOM查询正常
- Scene查询正常
- Modality, ModalityBinding, ModalData, Role, Assignment查询正常
- 按ID获取实体正常
- Entity服务集成正常

### 4.2 数据统计

- **TwinObject**: 包含所有子类型
- **MBOM**: 2个产品的MBOM数据
- **Scene**: 2个产品的场景数据
- **Modality**: 完整的Modality定义
- **ModalityBinding**: 所有绑定关系
- **ModalData**: 1971条采样记录
- **Role**: 所有角色定义
- **Assignment**: 92条自动生成的岗位指派记录

## 五、API使用示例

### 5.1 查询实体列表

```bash
# 查询TwinObject实体
curl "http://localhost:8000/api/v1/entities?type=TwinObject&limit=10"

# 查询MBOM实体
curl "http://localhost:8000/api/v1/entities?type=MBOM&limit=5"

# 查询Station类型的TwinObject
curl "http://localhost:8000/api/v1/entities?type=TwinObject&q=subType.value=='Station'"
```

### 5.2 获取单个实体

```bash
curl "http://localhost:8000/api/v1/entities/urn:ngsi-ld:TwinObject:Station:ST-HJ"
```

### 5.3 查询KPI

```bash
curl "http://localhost:8000/api/v1/map/kpi"
```

### 5.4 查询实时数据

```bash
curl "http://localhost:8000/api/v1/realtime/entities"
```

## 六、WebSocket连接

前端WebSocket服务地址：`ws://localhost:8000/api/v1/realtime/ws`

前端会自动连接WebSocket获取实时数据更新。

## 七、常见问题

### 7.1 后端服务无法启动

- 检查端口8000是否被占用
- 检查Python依赖是否安装完整：`pip install -r requirements.txt`
- 检查虚拟环境是否激活

### 7.2 前端无法连接后端

- 检查后端服务是否启动
- 检查CORS配置是否正确
- 检查前端`.env`文件配置
- 检查浏览器控制台错误信息

### 7.3 Mock数据未加载

- 检查`backend/data/entities/`目录是否存在
- 检查`USE_MOCK_DATA=True`配置
- 查看后端日志确认数据加载情况

## 八、下一步

1. ✅ Mock数据服务已实现并测试通过
2. ✅ 前后端连接配置完成
3. ⏭️ 可以开始前端功能测试
4. ⏭️ 后续对接真实NGSI-LD客户端时，设置`USE_MOCK_DATA=False`

